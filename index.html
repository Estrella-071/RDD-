<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¡ç‰‡æ•¸ / å›åˆæ•¸ æ›ç®—å™¨</title>
  <!-- è¼‰å…¥ Roboto å­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js èˆ‡æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    :root {
      font-size: 16px;
      --bg-color: #f9f9f9;
      --text-color: #333;
      --container-bg: #fff;
      --primary-color: #3498db;
      --primary-hover: #2980b9;
      --table-border: #ddd;
      --shadow-light: rgba(0,0,0,0.1);
      --shadow-dark: rgba(0,0,0,0.2);
      --toggle-bg: #888;
      /* ç™½å¤©æ¨¡å¼èƒŒæ™¯ä»¥ç™½è‰²ç‚ºåŸºèª¿ */
      --bg-gradient-light: linear-gradient(-45deg, #ffffff, #f0f0f0, #ffffff, #f0f0f0);
    }
    .dark {
      --bg-color: #121212;
      --text-color: #ccc;
      --container-bg: #1e1e1e;
      --primary-color: #2980b9;
      --primary-hover: #1f6391;
      --table-border: #555;
      --shadow-light: rgba(0,0,0,0.2);
      --shadow-dark: rgba(0,0,0,0.4);
      --toggle-bg: #666;
      --bg-gradient-dark: linear-gradient(-45deg, #232526, #414345, #232526, #414345);
    }
    /* å‹•ç•«æ•ˆæœï¼ˆç§»é™¤èƒŒæ™¯å‹•æ…‹æ•ˆæœï¼Œåªä¿ç•™å…¶ä»–å‹•ç•«ï¼‰ */
    @keyframes slideInDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(1rem); }
      to { opacity: 1; transform: translateY(0); }
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg-gradient-light);
      /* ç§»é™¤èƒŒæ™¯å‹•ç•« */
      transition: background 1s ease, color 1s ease;
      color: var(--text-color);
    }
    body.dark {
      background: var(--bg-gradient-dark);
    }
    section {
      min-height: 100vh;
      padding: 1.25rem 0.625rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      animation: fadeInUp 0.8s forwards;
    }
    .module {
      background: var(--container-bg);
      border-radius: 1rem;
      box-shadow: 0.5rem 0.5rem 1rem var(--shadow-light), -0.5rem -0.5rem 1rem var(--shadow-light);
      padding: 1.25rem 1.875rem;
      margin: 0.625rem;
      width: 90%;
      max-width: 56.25rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .module:hover {
      transform: scale(1.03);
      box-shadow: 0.625rem 0.625rem 1.25rem var(--shadow-dark), -0.625rem -0.625rem 1.25rem var(--shadow-dark);
    }
    .module h2 {
      text-align: center;
      margin-bottom: 1.25rem;
      font-size: 1.6rem;
    }
    .mode-toggle {
      display: inline-block;
      margin: 0 0.938rem;
      padding: 0.625rem 1.25rem;
      border: 0.125rem solid var(--primary-color);
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary-color);
      background: linear-gradient(45deg, #fff, #f0f0f0);
      transition: background 0.3s, color 0.3s, transform 0.2s;
    }
    .mode-toggle.active {
      background: var(--primary-color);
      color: #fff;
    }
    .mode-toggle:hover { transform: scale(1.05); }
    /* å¸¸ç”¨æ›ç®—æ¨¡å¡Šï¼šå·¦å³ç•™ç™½ */
    #common .module { width: calc(100% - 2rem); max-width: 56.25rem; margin: 0 auto; }
    /* é ‚ç«¯å°èˆªåˆ— */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--container-bg);
      border-bottom: 0.125rem solid var(--primary-color);
      padding: 0.625rem 0;
      z-index: 1000;
      display: flex;
      justify-content: center;
      box-sizing: border-box;
      animation: slideInDown 0.8s ease-out;
    }
    #sidebar ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 1.875rem;
    }
    #sidebar li { margin: 0; }
    #sidebar li::before {
      content: "â€¢ ";
      color: var(--primary-color);
      font-weight: bold;
    }
    #sidebar a {
      text-decoration: none;
      color: var(--text-color);
      font-weight: bold;
      transition: transform 0.2s, color 0.3s, border-bottom 0.3s;
    }
    #sidebar a:active { transform: scale(0.95); }
    #sidebar a.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }
    /* é é¢å³ä¸‹æµ®å‹•å°èˆªæŒ‰éˆ• */
    #pageNav {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
      z-index: 1200;
    }
    #pageNav button {
      width: 3.75rem;
      height: 3.75rem;
      border-radius: 50%;
      border: none;
      background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
      color: #fff;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.5s, transform 0.5s;
      white-space: normal;
      text-align: center;
      line-height: 1.2;
    }
    /* å›åˆ°é ‚éƒ¨æŒ‰éˆ•ï¼šç›´æ¥é¡¯ç¤º â¥” */
    #navTop {
      font-size: 1.5rem;
      line-height: 1;
    }
    /* ä¸Šä¸€é ã€ä¸‹ä¸€é æŒ‰éˆ•åªç”¨ç¬¦è™Ÿ */
    #navPrev { font-size: 1.2rem; }
    #navPrev::before { content: "â–²"; }
    #navNext { font-size: 1.2rem; }
    #navNext::before { content: "â–¼"; }
    #pageNav button.hidden {
      opacity: 0;
      transform: scale(0.5);
      pointer-events: none;
    }
    #pageNav button:active { transform: scale(0.95); }
    #pageNav button:hover { background: linear-gradient(45deg, var(--primary-hover), var(--primary-color)); }
    /* Dark/Light åˆ‡æ›æŒ‰éˆ• */
    .toggle-dark {
      position: fixed;
      top: 2.5rem;
      right: 1.25rem;
      background: linear-gradient(45deg, var(--toggle-bg), var(--primary-color));
      border: none;
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s, background 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 1100;
      padding: 0;
    }
    .toggle-dark:hover {
      transform: scale(1.1);
      background: linear-gradient(45deg, var(--primary-hover), var(--primary-color));
    }
    .toggle-dark svg { width: 100%; height: 100%; }
    /* èªè¨€åˆ‡æ›é¸å–® */
    #language-switcher {
      position: fixed;
      top: 2.5rem;
      right: 4rem;
      z-index: 1100;
    }
    #language-switcher select {
      padding: 0.25rem;
      font-size: 1rem;
      border: 0.125rem solid var(--primary-color);
      border-radius: 0.25rem;
      background: var(--container-bg);
      color: var(--text-color);
      cursor: pointer;
    }
    /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
    input[type="number"], select {
      padding: 0.5rem;
      border: 0.125rem solid var(--primary-color);
      border-radius: 0.25rem;
      font-size: 1.1rem;
      margin: 0.625rem 0;
      transition: border-color 0.3s;
      background: #fff;
      color: #333;
    }
    body.dark input[type="number"], body.dark select {
      background: #222;
      color: #ddd;
    }
    /* ç¾åŒ–æ‰€æœ‰æŒ‰éˆ• */
    button {
      background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
      color: #fff;
      border: none;
      padding: 0.625rem 1.25rem;
      font-size: 1.1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      margin: 0.625rem 0;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    button:hover { 
      background: linear-gradient(45deg, var(--primary-hover), var(--primary-color));
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .result {
      margin-top: 1.25rem;
      padding: 0.938rem;
      background: #ecf0f1;
      border-radius: 0.5rem;
      text-align: left;
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary-color);
      opacity: 0;
      transition: opacity 0.5s;
    }
    .result.visible { opacity: 1; }
    .table-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      margin-top: 1.25rem;
    }
    .table-box { width: 48%; margin-bottom: 1.25rem; }
    @media (max-width: 600px) {
      .table-container { flex-direction: column; }
      .table-box { width: 100%; border: 0.125rem solid var(--primary-color); border-radius: 0.5rem; padding: 0.625rem; }
      .mode-toggle { margin: 0.625rem 0; display: block; text-align: center; }
      .module { padding: 0.938rem 1.25rem; }
      .chart-container { height: 37.5rem !important; }
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 0.75rem 1rem;
      text-align: center;
      vertical-align: middle;
      border-bottom: 0.125rem solid var(--primary-color);
      font-size: 1.1rem;
    }
    th { background: var(--primary-color); color: #fff; }
    .chart-container {
      position: relative;
      margin: auto;
      height: 28.125rem;
      width: 100%;
    }
    /* åº•éƒ¨è£½ä½œè€…è³‡è¨Š */
    #hiddenCredits {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #808080;
      color: #fff;
      text-align: center;
      padding: 0.938rem;
      box-shadow: 0 -0.25rem 0.75rem rgba(0,0,0,0.3);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      font-size: 1rem;
    }
    #hiddenCredits.visible { transform: translateY(0); }
    /* æ›ç®—éç¨‹å€å¡Š */
    #processBtn {
      background: var(--primary-hover);
      color: #fff;
      border: none;
      padding: 0.313rem 0.625rem;
      font-size: 0.9rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-left: 0.625rem;
      transition: background 0.3s;
    }
    #processBtn:hover { background: var(--primary-color); }
    #processInfo {
      max-height: 0;
      overflow-y: auto;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease;
      margin-top: 0.625rem;
      padding: 0 0.625rem;
      background: #ecf0f1;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-color);
      text-align: left;
      line-height: 1.6;
      white-space: pre-wrap;
      border: 0.125rem solid var(--table-border);
      position: relative;
    }
    #processInfo.visible {
      max-height: 18.75rem;
      opacity: 1;
      padding: 0.625rem;
    }
    body.dark #processInfo {
      background: #333;
      color: #fff;
      border-color: #555;
    }
    /* æ›ç®—éç¨‹å…§è¿”å›é ‚ç«¯æŒ‰éˆ• */
    #processTopBtn {
      position: sticky;
      bottom: 0.625rem;
      right: 0.625rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 3.125rem;
      height: 3.125rem;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      align-self: flex-end;
    }
    #processTopBtn:hover { background: var(--primary-hover); }
  </style>
</head>
<body>
  <!-- é ‚ç«¯å°èˆªåˆ— -->
  <nav id="sidebar">
    <ul>
      <li><a href="#calculator" data-target="calculator">æ›ç®—å™¨</a></li>
      <li><a href="#common" data-target="common">å¸¸ç”¨æ›ç®—</a></li>
      <li><a href="#chartSection" data-target="chartSection">é—œä¿‚åœ–</a></li>
      <li><a href="#history" data-target="history">æ­·å²è¨˜éŒ„</a></li>
    </ul>
  </nav>
  <!-- é»‘å¤œ/ç™½å¤©åˆ‡æ›æŒ‰éˆ• -->
  <button class="toggle-dark" id="toggleDark" aria-label="åˆ‡æ›ä¸»é¡Œ"></button>
  <!-- èªè¨€åˆ‡æ›é¸å–® -->
  <div id="language-switcher">
    <select id="langSelect" aria-label="é¸æ“‡èªè¨€">
      <option value="zh-TW">ç¹ä¸­</option>
      <option value="zh-CN">ç®€ä¸­</option>
      <option value="en">English</option>
      <option value="ja">æ—¥æœ¬èª</option>
      <option value="ko">í•œêµ­ì–´</option>
    </select>
  </div>
  <!-- é é¢å³ä¸‹æµ®å‹•å°èˆªæŒ‰éˆ• -->
  <div id="pageNav">
    <!-- å›åˆ°é ‚éƒ¨æŒ‰éˆ•ï¼šæ”¹ç‚ºå–®ä¸€ç¬¦è™Ÿ â¥” -->
    <button id="navTop" title="å›åˆ°é ‚éƒ¨" aria-label="å›åˆ°é ‚éƒ¨">â¥”</button>
    <button id="navPrev" title="ä¸Šä¸€é " aria-label="ä¸Šä¸€é "></button>
    <button id="navNext" title="ä¸‹ä¸€é " aria-label="ä¸‹ä¸€é "></button>
  </div>
  <!-- éš±è—çš„é é¢å›åˆ°é ‚éƒ¨æŒ‰éˆ•ï¼ˆå‚™ç”¨ï¼‰-->
  <div id="backToTop" style="display:none;">â–²</div>
  <!-- æ›ç®—å™¨æ¨¡å¡Š -->
  <section id="calculator">
    <div class="module">
      <h2>å¡ç‰‡æ•¸ / å›åˆæ•¸ æ›ç®—å™¨</h2>
      <div style="text-align: center; margin-bottom: 1.25rem;">
        <span class="mode-toggle active" id="btnR2C">å›åˆ â†’ å¡ç‰‡</span>
        <span class="mode-toggle" id="btnC2R">å¡ç‰‡ â†’ å›åˆ</span>
        <!-- é¡¯ç¤ºæ›ç®—éç¨‹æŒ‰éˆ•åƒ…é¡¯ç¤ºå•è™Ÿ -->
        <button id="processBtn" title="é¡¯ç¤ºæ›ç®—éç¨‹" aria-label="é¡¯ç¤ºæ›ç®—éç¨‹">?</button>
      </div>
      <div style="text-align: left; width: 100%;">
        <label for="inputValue" style="font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 0.625rem;">è¼¸å…¥æ•¸å­—ï¼š</label>
        <input type="number" id="inputValue" min="1" step="1" value="100">
        <button id="calcBtn">è¨ˆç®—</button>
        <div class="result" id="result">â†’ </div>
        <div id="processInfo"></div>
      </div>
    </div>
  </section>
  <!-- å¸¸ç”¨æ›ç®—æ¨¡å¡Š -->
  <section id="common">
    <div class="module">
      <h2>å¸¸ç”¨æ›ç®—</h2>
      <div class="table-container">
        <div class="table-box">
          <!-- å¸¸ç”¨æ›ç®—å€å¡Šæ¨™é¡Œå°‡ç”±èªè¨€åˆ‡æ›æ›´æ–° -->
          <h3>å›åˆ â†’ å¡ç‰‡</h3>
          <table id="r2cTable">
            <thead>
              <tr>
                <th>å›åˆæ•¸</th>
                <th>å¡ç‰‡æ•¸</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-box">
          <h3>å¡ç‰‡ â†’ å›åˆ</h3>
          <table id="c2rTable">
            <thead>
              <tr>
                <th>å¡ç‰‡æ•¸</th>
                <th>å›åˆæ•¸</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  <!-- é—œä¿‚åœ–æ¨¡å¡Š -->
  <section id="chartSection">
    <div class="module">
      <h2>å¡æ•¸ - å›åˆæ•¸ é—œä¿‚åœ–</h2>
      <div style="text-align: center; margin-bottom: 1rem;">
        <label for="chartType" style="font-size: 1rem; font-weight: bold;">åœ–è¡¨é¡å‹ï¼š</label>
        <select id="chartType" style="font-size: 1rem; padding: 0.25rem;">
          <option value="line">æŠ˜ç·šåœ–</option>
          <option value="bar">æŸ±ç‹€åœ–</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>
  <!-- æ›ç®—æ­·å²è¨˜éŒ„æ¨¡å¡Š -->
  <section id="history">
    <div class="module">
      <h2>æ›ç®—æ­·å²è¨˜éŒ„</h2>
      <button id="clearHistory">æ¸…é™¤æ­·å²</button>
      <table id="historyTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>æ¨¡å¼</th>
            <th>è¼¸å…¥å€¼</th>
            <th>çµæœ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <!-- æ­·å²ç´€éŒ„åˆ†é æ§åˆ¶ -->
      <div id="historyPagination" style="text-align: center; margin-top: 1rem;"></div>
    </div>
  </section>
  <!-- åº•éƒ¨è£½ä½œè€…è³‡è¨Š -->
  <div id="hiddenCredits">ç¶²é ã€åœ–è¡¨è£½ä½œï¼šDiscord ğ•«ğ•™ğ•šğ•ğ•š @zhili_71</div>
  <!-- è¼‰å…¥ Chart.js èˆ‡ Annotation æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <script>
    (function(){
      "use strict";
      //==============================
      // é…ç½®èˆ‡ LocalStorage éµå€¼
      //==============================
      const LS_KEYS = {
        darkMode: "converter_darkMode",
        lastInput: "converter_lastInput",
        mode: "converter_mode", // "r2c" æˆ– "c2r"
        history: "converter_history"
      };
      const CONFIG = {
        baseThreshold: 45,
        baseArray: [0,1,2,4,5],
        extraRanges: [
          {a: 46, b: 111, f: 1},
          {a: 112, b: 500, f: 2},
          {a: 501, b: 1000, f: 3},
          {a: 1001, b: 1500, f: 4},
          {a: 1501, b: Infinity, f: 5}
        ],
        chart: {
          maxRounds: 1600,
          step: 50
        }
      };

      //==============================
      // ç¿»è­¯å­—å…¸è¨­å®šï¼ˆåŒ…å«æ›ç®—éç¨‹ã€æ­·å²è¨˜éŒ„ã€è¡¨æ ¼ã€åˆ†é ç­‰ï¼‰
      //==============================
      let currentLang = "zh-TW";
      const translations = {
        "zh-TW": {
          nav: {
             calculator: "æ›ç®—å™¨",
             common: "å¸¸ç”¨æ›ç®—",
             chartSection: "é—œä¿‚åœ–",
             history: "æ­·å²è¨˜éŒ„"
          },
          calculator: {
             title: "å¡ç‰‡æ•¸ / å›åˆæ•¸ æ›ç®—å™¨",
             modeR2C: "å›åˆ â†’ å¡ç‰‡",
             modeC2R: "å¡ç‰‡ â†’ å›åˆ",
             inputLabel: "è¼¸å…¥æ•¸å­—ï¼š",
             calcBtn: "è¨ˆç®—",
             processBtn: "æ›ç®—éç¨‹"
          },
          common: {
            title: "å¸¸ç”¨æ›ç®—",
            r2c: "å›åˆ â†’ å¡ç‰‡",
            c2r: "å¡ç‰‡ â†’ å›åˆ"
          },
          chart: {
             title: "å¡æ•¸ - å›åˆæ•¸ é—œä¿‚åœ–",
             chartTypeLabel: "åœ–è¡¨é¡å‹ï¼š",
             optionLine: "æŠ˜ç·šåœ–",
             optionBar: "æŸ±ç‹€åœ–",
             xAxis: "å›åˆæ•¸",
             yAxis: "å¡ç‰‡æ•¸"
          },
          history: {
             title: "æ›ç®—æ­·å²è¨˜éŒ„",
             clearHistory: "æ¸…é™¤æ­·å²",
             noRecord: "ç„¡æ­·å²è¨˜éŒ„"
          },
          process: {
             r2cTitle: "ã€å›åˆ â†’ å¡ç‰‡ æ›ç®—éç¨‹ã€‘",
             c2rTitle: "ã€å¡ç‰‡ â†’ å›åˆ æ›ç®—éç¨‹ã€‘",
             r2cStep1: "1. å‰45å›éƒ¨åˆ†ï¼š",
             r2cLine1: "   - å›åˆæ•¸ï¼šmin({input}, 45) = {r}",
             r2cLine2: "   - åŸºç¤å¡ç‰‡ = floor({r}/5) * 8 = {baseCalc}",
             r2cLine3: "   - é¤˜æ•¸ {mod} â†’ åŠ æˆ {lookup} å¡",
             r2cLine4: "   â†’ å°è¨ˆ = {subtotal}",
             r2cStep2: "2. è¶…é45å›éƒ¨åˆ†ï¼š",
             r2cLineExtra: "   - å€é–“ {a}ï½{b} (å€ç‡ {f})ï¼šè¨ˆç®—å¾— {extra}",
             r2cStep3: "3. ç¸½å¡ç‰‡æ•¸ = åŸºç¤ ({subtotal}) + è¶…ééƒ¨åˆ† ({extraTotal}) = {result} å¡",
             c2rStep1: "1. åˆ©ç”¨äºŒåˆ†æœå°‹æ³•å°‹æ‰¾æœ€å°å›åˆæ•¸ï¼Œä½¿æ›ç®—å¾Œå¡ç‰‡æ•¸ â‰¥ è¼¸å…¥å¡ç‰‡æ•¸ã€‚",
             c2rStep2: "   - åˆå§‹ç¯„åœï¼šä½ = 1, é«˜ = {high}",
             c2rStep3: "   - è¿­ä»£ï¼šå›åˆæ•¸ {mid} â†’ {cards} å¡",
             c2rStep4: "   â†’ çµæœï¼šæœ€å°å›åˆæ•¸ = {result}"
          },
          tables: {
            r2c: { header1: "å›åˆæ•¸", header2: "å¡ç‰‡æ•¸" },
            c2r: { header1: "å¡ç‰‡æ•¸", header2: "å›åˆæ•¸" },
            history: { header1: "æ™‚é–“", header2: "æ¨¡å¼", header3: "è¼¸å…¥å€¼", header4: "çµæœ" }
          },
          units: {
            r2c: " å¡ç‰‡",
            c2r: " å›åˆ"
          },
          pagination: {
            prev: "ä¸Šä¸€é ",
            next: "ä¸‹ä¸€é ",
            pageInfo: "ç¬¬ {current} é  / å…± {total} é "
          },
          credits: "ç¶²é ã€åœ–è¡¨è£½ä½œï¼šDiscord ğ•«ğ•™ğ•šğ•ğ•š @zhili_71"
        },
        "zh-CN": {
          nav: {
             calculator: "æ¢ç®—å™¨",
             common: "å¸¸ç”¨æ¢ç®—",
             chartSection: "å…³ç³»å›¾",
             history: "å†å²è®°å½•"
          },
          calculator: {
             title: "å¡ç‰‡æ•° / å›åˆæ•° æ¢ç®—å™¨",
             modeR2C: "å›åˆ â†’ å¡ç‰‡",
             modeC2R: "å¡ç‰‡ â†’ å›åˆ",
             inputLabel: "è¾“å…¥æ•°å­—ï¼š",
             calcBtn: "è®¡ç®—",
             processBtn: "æ¢ç®—è¿‡ç¨‹"
          },
          common: {
            title: "å¸¸ç”¨æ¢ç®—",
            r2c: "å›åˆ â†’ å¡ç‰‡",
            c2r: "å¡ç‰‡ â†’ å›åˆ"
          },
          chart: {
             title: "å¡æ•° - å›åˆæ•° å…³ç³»å›¾",
             chartTypeLabel: "å›¾è¡¨ç±»å‹ï¼š",
             optionLine: "æŠ˜çº¿å›¾",
             optionBar: "æŸ±çŠ¶å›¾",
             xAxis: "å›åˆæ•°",
             yAxis: "å¡ç‰‡æ•°"
          },
          history: {
             title: "æ¢ç®—å†å²è®°å½•",
             clearHistory: "æ¸…é™¤å†å²",
             noRecord: "æ— å†å²è®°å½•"
          },
          process: {
             r2cTitle: "ã€å›åˆ â†’ å¡ç‰‡ æ¢ç®—è¿‡ç¨‹ã€‘",
             c2rTitle: "ã€å¡ç‰‡ â†’ å›åˆ æ¢ç®—è¿‡ç¨‹ã€‘",
             r2cStep1: "1. å‰45å›éƒ¨åˆ†ï¼š",
             r2cLine1: "   - å›åˆæ•°ï¼šmin({input}, 45) = {r}",
             r2cLine2: "   - åŸºç¡€å¡ç‰‡ = floor({r}/5) * 8 = {baseCalc}",
             r2cLine3: "   - ä½™æ•° {mod} â†’ åŠ æˆ {lookup} å¡",
             r2cLine4: "   â†’ å°è®¡ = {subtotal}",
             r2cStep2: "2. è¶…è¿‡45å›éƒ¨åˆ†ï¼š",
             r2cLineExtra: "   - åŒºé—´ {a}ï½{b} (å€ç‡ {f})ï¼šè®¡ç®—å¾— {extra}",
             r2cStep3: "3. æ€»å¡ç‰‡æ•° = åŸºç¡€ ({subtotal}) + è¶…è¿‡éƒ¨åˆ† ({extraTotal}) = {result} å¡",
             c2rStep1: "1. åˆ©ç”¨äºŒåˆ†æœç´¢æ³•å¯»æ‰¾æœ€å°å›åˆæ•°ï¼Œä½¿æ¢ç®—åå¡ç‰‡æ•° â‰¥ è¾“å…¥å¡ç‰‡æ•°ã€‚",
             c2rStep2: "   - åˆå§‹èŒƒå›´ï¼šä½ = 1, é«˜ = {high}",
             c2rStep3: "   - è¿­ä»£ï¼šå›åˆæ•° {mid} â†’ {cards} å¡",
             c2rStep4: "   â†’ ç»“æœï¼šæœ€å°å›åˆæ•° = {result}"
          },
          tables: {
            r2c: { header1: "å›åˆæ•°", header2: "å¡ç‰‡æ•°" },
            c2r: { header1: "å¡ç‰‡æ•°", header2: "å›åˆæ•°" },
            history: { header1: "æ—¶é—´", header2: "æ¨¡å¼", header3: "è¾“å…¥å€¼", header4: "ç»“æœ" }
          },
          units: {
            r2c: " å¡ç‰‡",
            c2r: " å›åˆ"
          },
          pagination: {
            prev: "ä¸Šä¸€é¡µ",
            next: "ä¸‹ä¸€é¡µ",
            pageInfo: "ç¬¬ {current} é¡µ / å…± {total} é¡µ"
          },
          credits: "ç½‘é¡µã€å›¾è¡¨åˆ¶ä½œï¼šDiscord zhili @zhili_71"
        },
        "en": {
          nav: {
             calculator: "Calculator",
             common: "Common Conversions",
             chartSection: "Chart",
             history: "History"
          },
          calculator: {
             title: "Cards / Rounds Converter",
             modeR2C: "Rounds â†’ Cards",
             modeC2R: "Cards â†’ Rounds",
             inputLabel: "Input Number:",
             calcBtn: "Calculate",
             processBtn: "Conversion Process"
          },
          common: {
            title: "Common Conversions",
            r2c: "Rounds â†’ Cards",
            c2r: "Cards â†’ Rounds"
          },
          chart: {
             title: "Cards - Rounds Chart",
             chartTypeLabel: "Chart Type:",
             optionLine: "Line Chart",
             optionBar: "Bar Chart",
             xAxis: "Rounds",
             yAxis: "Cards"
          },
          history: {
             title: "Conversion History",
             clearHistory: "Clear History",
             noRecord: "No History"
          },
          process: {
             r2cTitle: "ã€Rounds â†’ Cards Conversion Processã€‘",
             c2rTitle: "ã€Cards â†’ Rounds Conversion Processã€‘",
             r2cStep1: "1. Base calculation for the first 45 rounds:",
             r2cLine1: "   - Rounds: min({input}, 45) = {r}",
             r2cLine2: "   - Base cards = floor({r}/5) * 8 = {baseCalc}",
             r2cLine3: "   - Remainder {mod} adds {lookup} cards",
             r2cLine4: "   â†’ Subtotal = {subtotal}",
             r2cStep2: "2. Additional rounds beyond 45:",
             r2cLineExtra: "   - Interval {a}â€“{b} (factor {f}): calculated as {extra}",
             r2cStep3: "3. Total cards = Base ({subtotal}) + Additional ({extraTotal}) = {result} cards",
             c2rStep1: "1. Using binary search to find the minimum rounds such that calculated cards â‰¥ input.",
             c2rStep2: "   - Initial range: low = 1, high = {high}",
             c2rStep3: "   - Iteration: rounds {mid} â†’ {cards} cards",
             c2rStep4: "   â†’ Result: Minimum rounds = {result}"
          },
          tables: {
            r2c: { header1: "Rounds", header2: "Cards" },
            c2r: { header1: "Cards", header2: "Rounds" },
            history: { header1: "Time", header2: "Mode", header3: "Input", header4: "Result" }
          },
          units: {
            r2c: " Cards",
            c2r: " Rounds"
          },
          pagination: {
            prev: "Prev",
            next: "Next",
            pageInfo: "Page {current} of {total}"
          },
          credits: "Web & Chart by: Discord zhili @zhili_71"
        },
        "ja": {
          nav: {
             calculator: "ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼",
             common: "ä¸€èˆ¬çš„ãªæ›ç®—",
             chartSection: "ã‚°ãƒ©ãƒ•",
             history: "å±¥æ­´"
          },
          calculator: {
             title: "ã‚«ãƒ¼ãƒ‰æ•° / ãƒ©ã‚¦ãƒ³ãƒ‰æ•° ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼",
             modeR2C: "ãƒ©ã‚¦ãƒ³ãƒ‰ â†’ ã‚«ãƒ¼ãƒ‰",
             modeC2R: "ã‚«ãƒ¼ãƒ‰ â†’ ãƒ©ã‚¦ãƒ³ãƒ‰",
             inputLabel: "æ•°å­—ã‚’å…¥åŠ›ï¼š",
             calcBtn: "è¨ˆç®—ã™ã‚‹",
             processBtn: "æ›ç®—éç¨‹"
          },
          common: {
            title: "ä¸€èˆ¬çš„ãªæ›ç®—",
            r2c: "ãƒ©ã‚¦ãƒ³ãƒ‰ â†’ ã‚«ãƒ¼ãƒ‰",
            c2r: "ã‚«ãƒ¼ãƒ‰ â†’ ãƒ©ã‚¦ãƒ³ãƒ‰"
          },
          chart: {
             title: "ã‚«ãƒ¼ãƒ‰æ•° - ãƒ©ã‚¦ãƒ³ãƒ‰æ•° ã‚°ãƒ©ãƒ•",
             chartTypeLabel: "ã‚°ãƒ©ãƒ•ã®ç¨®é¡ï¼š",
             optionLine: "æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•",
             optionBar: "æ£’ã‚°ãƒ©ãƒ•",
             xAxis: "ãƒ©ã‚¦ãƒ³ãƒ‰æ•°",
             yAxis: "ã‚«ãƒ¼ãƒ‰æ•°"
          },
          history: {
             title: "æ›ç®—å±¥æ­´",
             clearHistory: "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢",
             noRecord: "å±¥æ­´ãªã—"
          },
          process: {
             r2cTitle: "ã€ãƒ©ã‚¦ãƒ³ãƒ‰ â†’ ã‚«ãƒ¼ãƒ‰ æ›ç®—éç¨‹ã€‘",
             c2rTitle: "ã€ã‚«ãƒ¼ãƒ‰ â†’ ãƒ©ã‚¦ãƒ³ãƒ‰ æ›ç®—éç¨‹ã€‘",
             r2cStep1: "1. æœ€åˆã®45ãƒ©ã‚¦ãƒ³ãƒ‰ã®åŸºæœ¬è¨ˆç®—ï¼š",
             r2cLine1: "   - ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ï¼šmin({input}, 45) = {r}",
             r2cLine2: "   - åŸºæœ¬ã‚«ãƒ¼ãƒ‰æ•° = floor({r}/5) * 8 = {baseCalc}",
             r2cLine3: "   - ä½™ã‚Š {mod} ã¯ {lookup} ã‚«ãƒ¼ãƒ‰åŠ ç®—",
             r2cLine4: "   â†’ å°è¨ˆ = {subtotal}",
             r2cStep2: "2. 45ãƒ©ã‚¦ãƒ³ãƒ‰è¶…éåˆ†ï¼š",
             r2cLineExtra: "   - ç¯„å›² {a}ï½{b} (å€ç‡ {f})ï¼šè¨ˆç®—çµæœ {extra}",
             r2cStep3: "3. ç·ã‚«ãƒ¼ãƒ‰æ•° = åŸºæœ¬ ({subtotal}) + è¶…éåˆ† ({extraTotal}) = {result} æš",
             c2rStep1: "1. äºŒåˆ†æ¢ç´¢æ³•ã‚’ç”¨ã„ã¦ã€æ›ç®—å¾Œã‚«ãƒ¼ãƒ‰æ•°ãŒå…¥åŠ›å€¤ä»¥ä¸Šã¨ãªã‚‹æœ€å°ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’æ±‚ã‚ã‚‹ã€‚",
             c2rStep2: "   - åˆæœŸç¯„å›²ï¼šä¸‹é™ = 1, ä¸Šé™ = {high}",
             c2rStep3: "   - åå¾©ï¼šãƒ©ã‚¦ãƒ³ãƒ‰ {mid} â†’ {cards} æš",
             c2rStep4: "   â†’ çµæœï¼šæœ€å°ãƒ©ã‚¦ãƒ³ãƒ‰æ•° = {result}"
          },
          tables: {
            r2c: { header1: "ãƒ©ã‚¦ãƒ³ãƒ‰æ•°", header2: "ã‚«ãƒ¼ãƒ‰æ•°" },
            c2r: { header1: "ã‚«ãƒ¼ãƒ‰æ•°", header2: "ãƒ©ã‚¦ãƒ³ãƒ‰æ•°" },
            history: { header1: "æ™‚é–“", header2: "ãƒ¢ãƒ¼ãƒ‰", header3: "å…¥åŠ›å€¤", header4: "çµæœ" }
          },
          units: {
            r2c: " æš",
            c2r: " ãƒ©ã‚¦ãƒ³ãƒ‰"
          },
          pagination: {
            prev: "å‰ã¸",
            next: "æ¬¡ã¸",
            pageInfo: "ç¬¬ {current} ãƒšãƒ¼ã‚¸ / å…¨ {total} ãƒšãƒ¼ã‚¸"
          },
          credits: "ã‚¦ã‚§ãƒ–ãƒ»ã‚°ãƒ©ãƒ•ä½œæˆï¼šDiscord zhili @zhili_71"
        },
        "ko": {
          nav: {
             calculator: "ë³€í™˜ê¸°",
             common: "ì¼ë°˜ ë³€í™˜",
             chartSection: "ì°¨íŠ¸",
             history: "ê¸°ë¡"
          },
          calculator: {
             title: "ì¹´ë“œ ìˆ˜ / ë¼ìš´ë“œ ìˆ˜ ë³€í™˜ê¸°",
             modeR2C: "ë¼ìš´ë“œ â†’ ì¹´ë“œ",
             modeC2R: "ì¹´ë“œ â†’ ë¼ìš´ë“œ",
             inputLabel: "ìˆ«ì ì…ë ¥:",
             calcBtn: "ê³„ì‚°",
             processBtn: "ë³€í™˜ ê³¼ì •"
          },
          common: {
            title: "ì¼ë°˜ ë³€í™˜",
            r2c: "ë¼ìš´ë“œ â†’ ì¹´ë“œ",
            c2r: "ì¹´ë“œ â†’ ë¼ìš´ë“œ"
          },
          chart: {
             title: "ì¹´ë“œ - ë¼ìš´ë“œ ì°¨íŠ¸",
             chartTypeLabel: "ì°¨íŠ¸ ìœ í˜•:",
             optionLine: "ì„ í˜• ì°¨íŠ¸",
             optionBar: "ë§‰ëŒ€ ì°¨íŠ¸",
             xAxis: "ë¼ìš´ë“œ ìˆ˜",
             yAxis: "ì¹´ë“œ ìˆ˜"
          },
          history: {
             title: "ë³€í™˜ ê¸°ë¡",
             clearHistory: "ê¸°ë¡ ì‚­ì œ",
             noRecord: "ê¸°ë¡ ì—†ìŒ"
          },
          process: {
             r2cTitle: "ã€ë¼ìš´ë“œ â†’ ì¹´ë“œ ë³€í™˜ ê³¼ì •ã€‘",
             c2rTitle: "ã€ì¹´ë“œ â†’ ë¼ìš´ë“œ ë³€í™˜ ê³¼ì •ã€‘",
             r2cStep1: "1. ì²« 45ë¼ìš´ë“œì˜ ê¸°ë³¸ ê³„ì‚°:",
             r2cLine1: "   - ë¼ìš´ë“œ ìˆ˜: min({input}, 45) = {r}",
             r2cLine2: "   - ê¸°ë³¸ ì¹´ë“œ ìˆ˜ = floor({r}/5) * 8 = {baseCalc}",
             r2cLine3: "   - ë‚˜ë¨¸ì§€ {mod}ì€(ëŠ”) {lookup} ì¹´ë“œ ì¶”ê°€",
             r2cLine4: "   â†’ ì†Œê³„ = {subtotal}",
             r2cStep2: "2. 45ë¼ìš´ë“œ ì´ˆê³¼ë¶„:",
             r2cLineExtra: "   - êµ¬ê°„ {a}â€“{b} (ë°°ìˆ˜ {f}): ê³„ì‚° ê²°ê³¼ {extra}",
             r2cStep3: "3. ì´ ì¹´ë“œ ìˆ˜ = ê¸°ë³¸ ({subtotal}) + ì¶”ê°€ ({extraTotal}) = {result} ì¥",
             c2rStep1: "1. ì´ì§„ íƒìƒ‰ì„ ì‚¬ìš©í•˜ì—¬, ë³€í™˜ í›„ ì¹´ë“œ ìˆ˜ê°€ ì…ë ¥ê°’ ì´ìƒì¸ ìµœì†Œ ë¼ìš´ë“œ ìˆ˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤.",
             c2rStep2: "   - ì´ˆê¸° ë²”ìœ„: í•˜í•œ = 1, ìƒí•œ = {high}",
             c2rStep3: "   - ë°˜ë³µ: ë¼ìš´ë“œ {mid} â†’ {cards} ì¥",
             c2rStep4: "   â†’ ê²°ê³¼: ìµœì†Œ ë¼ìš´ë“œ ìˆ˜ = {result}"
          },
          tables: {
            r2c: { header1: "ë¼ìš´ë“œ ìˆ˜", header2: "ì¹´ë“œ ìˆ˜" },
            c2r: { header1: "ì¹´ë“œ ìˆ˜", header2: "ë¼ìš´ë“œ ìˆ˜" },
            history: { header1: "ì‹œê°„", header2: "ëª¨ë“œ", header3: "ì…ë ¥ê°’", header4: "ê²°ê³¼" }
          },
          units: {
            r2c: " ì¥",
            c2r: " ë¼ìš´ë“œ"
          },
          pagination: {
            prev: "ì´ì „",
            next: "ë‹¤ìŒ",
            pageInfo: "{total}í˜ì´ì§€ ì¤‘ {current}í˜ì´ì§€"
          },
          credits: "ì›¹ & ì°¨íŠ¸ ì œì‘: Discord zhili @zhili_71"
        }
      };

      //==============================
      // DOM å…ƒç´ 
      //==============================
      const body = document.body;
      const toggleDarkBtn = document.getElementById("toggleDark");
      const inputValueElem = document.getElementById("inputValue");
      const resultDiv = document.getElementById("result");
      const processInfo = document.getElementById("processInfo");
      const btnR2C = document.getElementById("btnR2C");
      const btnC2R = document.getElementById("btnC2R");
      const calcBtn = document.getElementById("calcBtn");
      const processBtn = document.getElementById("processBtn");
      const chartTypeSelect = document.getElementById("chartType");
      const r2cTableBody = document.getElementById("r2cTable").querySelector("tbody");
      const c2rTableBody = document.getElementById("c2rTable").querySelector("tbody");
      const historyTableBody = document.getElementById("historyTable").querySelector("tbody");
      const clearHistoryBtn = document.getElementById("clearHistory");
      const navTopBtn = document.getElementById("navTop");
      const navPrevBtn = document.getElementById("navPrev");
      const navNextBtn = document.getElementById("navNext");
      const historyPagination = document.getElementById("historyPagination");
      let myChart = null;
      let currentChartType = chartTypeSelect.value;
      let mode = "r2c"; // é è¨­ç‚ºå›åˆâ†’å¡ç‰‡
      let historyData = [];
      let currentHistoryPage = 0;
      const recordsPerPage = 5;

      //==============================
      // å„²å­˜èˆ‡è®€å– LocalStorage
      //==============================
      function saveLS(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }
      function loadLS(key, defaultValue) {
        const val = localStorage.getItem(key);
        return val ? JSON.parse(val) : defaultValue;
      }

      //==============================
      // åˆå§‹åŒ–åå¥½èˆ‡æ­·å²è¨˜éŒ„
      //==============================
      function initPreferences(){
        const darkPref = loadLS(LS_KEYS.darkMode, null);
        if(darkPref !== null){
          if(darkPref) body.classList.add("dark");
          else body.classList.remove("dark");
        } else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          body.classList.add("dark");
        }
        renderToggleBtn();
        const lastInput = loadLS(LS_KEYS.lastInput, "100");
        inputValueElem.value = lastInput;
        mode = loadLS(LS_KEYS.mode, "r2c");
        if(mode === "r2c"){
          btnR2C.classList.add("active");
          btnC2R.classList.remove("active");
        } else {
          btnC2R.classList.add("active");
          btnR2C.classList.remove("active");
        }
        historyData = loadLS(LS_KEYS.history, []);
        renderHistory();
      }

      //==============================
      // Dark æ¨¡å¼åˆ‡æ›èˆ‡åœ–ç¤ºæ›´æ–°
      //==============================
      function renderToggleBtn(){
        if(body.classList.contains("dark")){
          toggleDarkBtn.innerHTML = getSunSVG();
        } else {
          toggleDarkBtn.innerHTML = getMoonSVG();
        }
        updateChartAxisColor();
      }
      function getSunSVG(){
        return `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2"/>
          <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2"/>
        </svg>`;
      }
      function getMoonSVG(){
        return `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9.37 5.51A7 7 0 0 0 12 19a7 7 0 0 0 6.49-9.64A9 9 0 1 1 9.37 5.51z"/>
        </svg>`;
      }
      toggleDarkBtn.addEventListener("click", function(){
        body.classList.toggle("dark");
        renderToggleBtn();
        saveLS(LS_KEYS.darkMode, body.classList.contains("dark"));
      });

      //==============================
      // å¹³æ»‘æ»¾å‹•èˆ‡é é¢å°è¦½ï¼ˆæ•ˆèƒ½æœ€ä½³åŒ–ï¼šåˆä½µ scroll äº‹ä»¶ä¸¦ç”¨ requestAnimationFrame ç¯€æµï¼‰
      //==============================
      let ticking = false;
      window.addEventListener("scroll", function(){
        if (!ticking) {
          window.requestAnimationFrame(function(){
            updatePageNavVisibility();
            updateActiveNav();
            if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 150){
              document.getElementById("hiddenCredits").classList.add("visible");
            } else {
              document.getElementById("hiddenCredits").classList.remove("visible");
            }
            ticking = false;
          });
          ticking = true;
        }
      });
      function updatePageNavVisibility(){
        if(window.scrollY < 50){
          navTopBtn.classList.add("hidden");
        } else {
          navTopBtn.classList.remove("hidden");
        }
      }
      function updateActiveNav() {
        let sections = document.querySelectorAll("section");
        let scrollPos = window.scrollY + window.innerHeight/2;
        sections.forEach(section => {
          if (section.offsetTop <= scrollPos && (section.offsetTop + section.offsetHeight) > scrollPos) {
            let id = section.getAttribute("id");
            document.querySelectorAll("#sidebar a").forEach(link => {
              if(link.getAttribute("href").substring(1) === id) {
                link.classList.add("active");
              } else {
                link.classList.remove("active");
              }
            });
          }
        });
      }
      navTopBtn.addEventListener("click", function(){
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      navPrevBtn.addEventListener("click", function(){
        const sections = Array.from(document.querySelectorAll("section"));
        const currentScroll = window.scrollY;
        let target = null;
        for(let i = sections.length - 1; i >= 0; i--){
          if(sections[i].offsetTop < currentScroll - 50){
            target = sections[i];
            break;
          }
        }
        if(target) target.scrollIntoView({ behavior: "smooth" });
      });
      navNextBtn.addEventListener("click", function(){
        const sections = Array.from(document.querySelectorAll("section"));
        const currentScroll = window.scrollY;
        let target = null;
        for(let i = 0; i < sections.length; i++){
          if(sections[i].offsetTop > currentScroll + 50){
            target = sections[i];
            break;
          }
        }
        if(target) target.scrollIntoView({ behavior: "smooth" });
      });

      //==============================
      // æ›ç®—é‚è¼¯å‡½å¼
      //==============================
      function roundsToCards(t){
        t = Number(t);
        if(isNaN(t) || t < 1) return 0;
        let r = Math.min(t, CONFIG.baseThreshold);
        let base = Math.floor(r/5) * 8 + CONFIG.baseArray[r % 5];
        let extra = 0;
        CONFIG.extraRanges.forEach(range => {
          if(t >= range.a){
            let x = Math.min(t, range.b === Infinity ? t : range.b);
            extra += 2 * range.f * ((x - range.a + 1) + 2 * (Math.floor((x+1)/2) - Math.floor(range.a/2)));
          }
        });
        return base + extra;
      }
      function cardsToRounds(x){
        x = Number(x);
        if(isNaN(x) || x < 1) return 0;
        let l = 1, h = 1;
        while(roundsToCards(h) < x){ h *= 2; }
        while(l < h){
          let m = Math.floor((l+h)/2);
          if(roundsToCards(m) < x) l = m+1;
          else h = m;
        }
        return l;
      }

      //==============================
      // æ›´æ–°æ›ç®—çµæœèˆ‡éç¨‹èªªæ˜ï¼ˆä¾æ“šèªç³»ç”¢ç”Ÿç¿»è­¯æ–‡å­—ï¼‰
      //==============================
      function updateResult(){
        let inputValue = Number(inputValueElem.value);
        if(isNaN(inputValue) || inputValue < 1){
          resultDiv.innerText = translations[currentLang].process.invalidInput || "è«‹è¼¸å…¥æœ‰æ•ˆä¸”å¤§æ–¼ 0 çš„æ•¸å€¼";
          resultDiv.classList.add("visible");
          return;
        }
        saveLS(LS_KEYS.lastInput, inputValueElem.value);
        let calcResult = (mode === "r2c") ? roundsToCards(inputValue) : cardsToRounds(inputValue);
        let resultText = "â†’ " + calcResult + ((mode==="r2c") ? translations[currentLang].units.r2c : translations[currentLang].units.c2r);
        resultDiv.innerText = resultText;
        resultDiv.classList.add("visible");
        updateProcessInfo(inputValue);
        addHistoryRecord(new Date().toLocaleString(), mode, inputValue);
      }
      function updateProcessInfo(inputValue){
        if(resultDiv.innerText.trim() === "â†’") return;
        if(isNaN(inputValue) || inputValue < 1) {
          processInfo.innerHTML = "<pre>" + (translations[currentLang].process.invalidInput || "è«‹è¼¸å…¥æœ‰æ•ˆä¸”å¤§æ–¼ 0 çš„æ•¸å€¼") + "</pre>";
          return;
        }
        let explanation = "";
        if(mode === "r2c"){
          explanation += translations[currentLang].process.r2cTitle + "\n\n";
          const r = Math.min(inputValue, CONFIG.baseThreshold);
          const baseCalc = Math.floor(r/5) * 8;
          const lookup = CONFIG.baseArray[r % 5];
          let subtotal = baseCalc + lookup;
          explanation += translations[currentLang].process.r2cStep1 + "\n";
          explanation += translations[currentLang].process.r2cLine1.replace("{input}", inputValue).replace("{r}", r) + "\n";
          explanation += translations[currentLang].process.r2cLine2.replace("{r}", r).replace("{baseCalc}", baseCalc) + "\n";
          explanation += translations[currentLang].process.r2cLine3.replace("{mod}", r % 5).replace("{lookup}", lookup) + "\n";
          explanation += translations[currentLang].process.r2cLine4.replace("{subtotal}", subtotal) + "\n\n";
          let extraTotal = 0;
          if(inputValue > CONFIG.baseThreshold){
            explanation += translations[currentLang].process.r2cStep2 + "\n";
            CONFIG.extraRanges.forEach(range => {
              if(inputValue >= range.a){
                let x = Math.min(inputValue, range.b === Infinity ? inputValue : range.b);
                let extra = 2 * range.f * ((x - range.a + 1) + 2 * (Math.floor((x+1)/2) - Math.floor(range.a/2)));
                explanation += translations[currentLang].process.r2cLineExtra
                  .replace("{a}", range.a)
                  .replace("{b}", (range.b === Infinity ? inputValue : range.b))
                  .replace("{f}", range.f)
                  .replace("{extra}", extra) + "\n";
                extraTotal += extra;
              }
            });
            explanation += "\n" + translations[currentLang].process.r2cStep3
              .replace("{subtotal}", subtotal)
              .replace("{extraTotal}", extraTotal)
              .replace("{result}", roundsToCards(inputValue)) + "\n";
          }
        } else {
          explanation += translations[currentLang].process.c2rTitle + "\n\n";
          explanation += translations[currentLang].process.c2rStep1 + "\n";
          let low = 1, high = 1;
          while(roundsToCards(high) < inputValue){ high *= 2; }
          explanation += translations[currentLang].process.c2rStep2.replace("{high}", high) + "\n";
          while(low < high){
            let mid = Math.floor((low + high) / 2);
            explanation += translations[currentLang].process.c2rStep3.replace("{mid}", mid).replace("{cards}", roundsToCards(mid)) + "\n";
            if(roundsToCards(mid) < inputValue) low = mid + 1;
            else high = mid;
          }
          explanation += translations[currentLang].process.c2rStep4.replace("{result}", low) + "\n";
        }
        processInfo.innerHTML = `<pre>${explanation}</pre>`;
        addProcessTopBtn();
      }
      function addProcessTopBtn(){
        if(!document.getElementById("processTopBtn")){
          const topBtn = document.createElement("button");
          topBtn.id = "processTopBtn";
          topBtn.innerHTML = "â¥”";
          topBtn.addEventListener("click", function(){
            processInfo.scrollTo({ top: 0, behavior: "smooth" });
          });
          processInfo.appendChild(topBtn);
        }
      }

      //==============================
      // å¸¸ç”¨æ›ç®—è¡¨æ ¼èˆ‡åœ–è¡¨ç”¢ç”Ÿ
      //==============================
      function populateTables(){
        const r2cValues = [111,200,300,1000,1500,2000,2500,10000,20000];
        const c2rValues = [40,400,4000,8000,12000,16000,20000,40000,400000];
        r2cValues.forEach(rounds => {
          const cards = roundsToCards(rounds);
          const tr = document.createElement("tr");
          // ä¿®æ­£ï¼šç›´æ¥é¡¯ç¤ºæ•¸å­—ï¼Œä¸é‡è¤‡é¡¯ç¤ºè¡¨é ­æ–‡å­—
          tr.innerHTML = `<td>${rounds}</td><td>${cards}</td>`;
          r2cTableBody.appendChild(tr);
        });
        c2rValues.forEach(cards => {
          const rounds = cardsToRounds(cards);
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${cards}</td><td>${rounds}</td>`;
          c2rTableBody.appendChild(tr);
        });
      }
      function generateChart(){
        const dataPoints = [];
        const maxRounds = CONFIG.chart.maxRounds;
        const step = CONFIG.chart.step;
        for(let r=0; r<=maxRounds; r+=step){
          dataPoints.push({x: r, y: roundsToCards(r)});
        }
        const maxY = roundsToCards(maxRounds);
        const marker45 = roundsToCards(45);
        const marker111 = roundsToCards(111);
        const marker501 = roundsToCards(501);
        const marker1001 = roundsToCards(1001);
        const marker1501 = roundsToCards(1501);
        const ctx = document.getElementById("chart").getContext("2d");
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
          type: currentChartType,
          data: {
            datasets: [{
              label: translations[currentLang].chart.yAxis,
              data: dataPoints,
              borderColor: "rgba(75,192,192,1)",
              backgroundColor: "rgba(75,192,192,0.2)",
              pointRadius: 3,
              fill: false,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800 },
            plugins: {
              tooltip: {
                mode: "index",
                intersect: false,
                callbacks: {
                  label: function(context){
                    return translations[currentLang].chart.xAxis + ": " + context.parsed.x + ", " + translations[currentLang].chart.yAxis + ": " + context.parsed.y;
                  }
                }
              },
              datalabels: { display: false },
              annotation: {
                annotations: {
                  line45: {
                    type: "line",
                    scaleID: "x",
                    value: 45,
                    borderColor: "rgba(255,0,0,0.8)",
                    borderWidth: 2,
                    borderDash: [6,3],
                    label: {
                      enabled: true,
                      position: "center",
                      xAdjust: -20,
                      yAdjust: -20,
                      content: ["45å›", marker45],
                      backgroundColor: "rgba(0,0,0,0.7)",
                      color: "#fff",
                      font: { weight: "bold", size: 14 },
                      borderRadius: 4,
                      padding: 4
                    }
                  },
                  line111: {
                    type: "line",
                    scaleID: "x",
                    value: 111,
                    borderColor: "rgba(255,0,0,0.8)",
                    borderWidth: 2,
                    borderDash: [6,3],
                    label: {
                      enabled: true,
                      position: "center",
                      xAdjust: 20,
                      yAdjust: -20,
                      content: ["111å›", marker111],
                      backgroundColor: "rgba(0,0,0,0.7)",
                      color: "#fff",
                      font: { weight: "bold", size: 14 },
                      borderRadius: 4,
                      padding: 4
                    }
                  },
                  line501: {
                    type: "line",
                    scaleID: "x",
                    value: 501,
                    borderColor: "rgba(255,0,0,0.8)",
                    borderWidth: 2,
                    borderDash: [6,3],
                    label: {
                      enabled: true,
                      position: "center",
                      yAdjust: -20,
                      content: ["501å›", marker501],
                      backgroundColor: "rgba(0,0,0,0.7)",
                      color: "#fff",
                      font: { weight: "bold", size: 14 },
                      borderRadius: 4,
                      padding: 4
                    }
                  },
                  line1001: {
                    type: "line",
                    scaleID: "x",
                    value: 1001,
                    borderColor: "rgba(255,0,0,0.8)",
                    borderWidth: 2,
                    borderDash: [6,3],
                    label: {
                      enabled: true,
                      position: "center",
                      yAdjust: -20,
                      content: ["1001å›", marker1001],
                      backgroundColor: "rgba(0,0,0,0.7)",
                      color: "#fff",
                      font: { weight: "bold", size: 14 },
                      borderRadius: 4,
                      padding: 4
                    }
                  },
                  line1501: {
                    type: "line",
                    scaleID: "x",
                    value: 1501,
                    borderColor: "rgba(255,0,0,0.8)",
                    borderWidth: 2,
                    borderDash: [6,3],
                    label: {
                      enabled: true,
                      position: "center",
                      yAdjust: -20,
                      content: ["1501å›", marker1501],
                      backgroundColor: "rgba(0,0,0,0.7)",
                      color: "#fff",
                      font: { weight: "bold", size: 14 },
                      borderRadius: 4,
                      padding: 4
                    }
                  }
                }
              }
            },
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: translations[currentLang].chart.xAxis },
                min: 0,
                max: maxRounds,
                ticks: { font: { size: 14 }, color: body.classList.contains("dark") ? "#fff" : "#333" }
              },
              y: {
                title: { display: true, text: translations[currentLang].chart.yAxis },
                min: 0,
                max: maxY,
                ticks: { stepSize: 3000, font: { size: 14 }, color: body.classList.contains("dark") ? "#fff" : "#333" }
              }
            }
          }
        });
      }
      chartTypeSelect.addEventListener("change", function(){
        currentChartType = this.value;
        generateChart();
      });

      //==============================
      // æ›ç®—æ¨¡å¼åˆ‡æ›
      //==============================
      btnR2C.addEventListener("click", function(){
        mode = "r2c";
        btnR2C.classList.add("active");
        btnC2R.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "â†’") {
          updateResult();
        }
      });
      btnC2R.addEventListener("click", function(){
        mode = "c2r";
        btnC2R.classList.add("active");
        btnR2C.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "â†’") {
          updateResult();
        }
      });
      calcBtn.addEventListener("click", updateResult);
      processBtn.addEventListener("click", function(e){
        e.stopPropagation();
        processInfo.classList.toggle("visible");
        updateResult();
      });
      processInfo.addEventListener("wheel", function(e){ e.stopPropagation(); });

      //==============================
      // æ›ç®—æ­·å²è¨˜éŒ„åŠŸèƒ½ï¼ˆåˆ†é ç‰ˆï¼Œæ¯é é¡¯ç¤º 5 ç­†ï¼‰
      //==============================
      function addHistoryRecord(time, modeUsed, input){
        const record = { time, mode: modeUsed, input };
        historyData.unshift(record);
        saveLS(LS_KEYS.history, historyData);
        currentHistoryPage = 0;
        renderHistory();
      }
      function renderHistory(){
        historyTableBody.innerHTML = "";
        if(historyData.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan='4'>${translations[currentLang].history.noRecord}</td>`;
          historyTableBody.appendChild(tr);
        } else {
          let startIndex = currentHistoryPage * recordsPerPage;
          let endIndex = startIndex + recordsPerPage;
          let pageData = historyData.slice(startIndex, endIndex);
          pageData.forEach(rec => {
            const tr = document.createElement("tr");
            let computed = (rec.mode === "r2c") ? roundsToCards(rec.input) : cardsToRounds(rec.input);
            let resultText = "â†’ " + computed + (rec.mode === "r2c" ? translations[currentLang].units.r2c : translations[currentLang].units.c2r);
            let modeText = (rec.mode === "r2c") ? translations[currentLang].calculator.modeR2C : translations[currentLang].calculator.modeC2R;
            tr.innerHTML = `<td>${rec.time}</td><td>${modeText}</td><td>${rec.input}</td><td>${resultText}</td>`;
            historyTableBody.appendChild(tr);
          });
        }
        renderHistoryPagination();
      }
      function renderHistoryPagination(){
        historyPagination.innerHTML = "";
        const totalPages = Math.ceil(historyData.length / recordsPerPage);
        if(totalPages <= 1) return;
        const paginationDiv = document.createElement("div");
        if(currentHistoryPage > 0){
          const prevBtn = document.createElement("button");
          prevBtn.textContent = translations[currentLang].pagination.prev;
          prevBtn.style.marginRight = "1rem";
          prevBtn.addEventListener("click", function(){
            currentHistoryPage--;
            renderHistory();
          });
          paginationDiv.appendChild(prevBtn);
        }
        const pageInfo = document.createElement("span");
        pageInfo.textContent = translations[currentLang].pagination.pageInfo
          .replace("{current}", currentHistoryPage + 1)
          .replace("{total}", totalPages);
        paginationDiv.appendChild(pageInfo);
        if(currentHistoryPage < totalPages - 1){
          const nextBtn = document.createElement("button");
          nextBtn.textContent = translations[currentLang].pagination.next;
          nextBtn.style.marginLeft = "1rem";
          nextBtn.addEventListener("click", function(){
            currentHistoryPage++;
            renderHistory();
          });
          paginationDiv.appendChild(nextBtn);
        }
        historyPagination.appendChild(paginationDiv);
      }
      clearHistoryBtn.addEventListener("click", function(){
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ")){
          historyData = [];
          saveLS(LS_KEYS.history, historyData);
          currentHistoryPage = 0;
          renderHistory();
        }
      });

      //==============================
      // èªè¨€åˆ‡æ›åŠŸèƒ½ï¼ˆæ›´æ–°å„å€æ–‡å­—åŠè¡¨æ ¼æ¨™é¡Œï¼‰
      //==============================
      function updateLanguage() {
         currentLang = document.getElementById("langSelect").value;
         const t = translations[currentLang];
         document.querySelectorAll("#sidebar a").forEach(link => {
           const target = link.getAttribute("data-target");
           if(t.nav[target]) {
              link.textContent = t.nav[target];
           }
         });
         document.querySelector("#calculator .module h2").textContent = t.calculator.title;
         document.querySelector("#common .module h2").textContent = t.common.title;
         document.querySelector("#chartSection .module h2").textContent = t.chart.title;
         document.querySelector("#history .module h2").textContent = t.history.title;
         document.getElementById("btnR2C").textContent = t.calculator.modeR2C;
         document.getElementById("btnC2R").textContent = t.calculator.modeC2R;
         document.querySelector("#calculator label[for='inputValue']").textContent = t.calculator.inputLabel;
         document.getElementById("calcBtn").textContent = t.calculator.calcBtn;
         document.getElementById("processBtn").textContent = "?";
         let chartLabel = document.querySelector("#chartSection label[for='chartType']");
         if(chartLabel) { chartLabel.textContent = t.chart.chartTypeLabel; }
         const chartTypeSelect = document.getElementById("chartType");
         if(chartTypeSelect) {
           chartTypeSelect.options[0].text = t.chart.optionLine;
           chartTypeSelect.options[1].text = t.chart.optionBar;
         }
         document.getElementById("clearHistory").textContent = t.history.clearHistory;
         let r2cHeaders = document.querySelectorAll("#r2cTable thead tr th");
         r2cHeaders[0].textContent = t.tables.r2c.header1;
         r2cHeaders[1].textContent = t.tables.r2c.header2;
         let c2rHeaders = document.querySelectorAll("#c2rTable thead tr th");
         c2rHeaders[0].textContent = t.tables.c2r.header1;
         c2rHeaders[1].textContent = t.tables.c2r.header2;
         let historyHeaders = document.querySelectorAll("#historyTable thead tr th");
         historyHeaders[0].textContent = t.tables.history.header1;
         historyHeaders[1].textContent = t.tables.history.header2;
         historyHeaders[2].textContent = t.tables.history.header3;
         historyHeaders[3].textContent = t.tables.history.header4;
         // æ–°å¢ï¼šæ›´æ–°å¸¸ç”¨æ›ç®—å€å¡Šçš„æ¨™é¡Œ
         const commonTableHeadings = document.querySelectorAll("#common .table-box h3");
         if(commonTableHeadings.length >= 2) {
           commonTableHeadings[0].textContent = t.common.r2c;
           commonTableHeadings[1].textContent = t.common.c2r;
         }
         document.getElementById("hiddenCredits").textContent = t.credits;
         generateChart();
         if(processInfo.classList.contains("visible")){
           updateProcessInfo(Number(inputValueElem.value));
         }
         renderHistory();
      }
      document.getElementById("langSelect").addEventListener("change", updateLanguage);

      //==============================
      // åˆå§‹å¡«å……è¡¨æ ¼èˆ‡åœ–è¡¨
      //==============================
      populateTables();
      generateChart();
      initPreferences();
      updatePageNavVisibility();
      updateChartAxisColor();

      // æ›´æ–°åœ–è¡¨åº§æ¨™è»¸è‰²å½©ï¼ˆç•¶æš—é»‘æ¨¡å¼æ”¹è®Šæ™‚å‘¼å«ï¼‰
      function updateChartAxisColor(){
        if(myChart){
          myChart.options.scales.x.ticks.color = body.classList.contains("dark") ? "#fff" : "#333";
          myChart.options.scales.y.ticks.color = body.classList.contains("dark") ? "#fff" : "#333";
          myChart.update();
        }
      }
    })();
  </script>
</body>
</html>

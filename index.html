<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>卡片數 / 回合數 換算器</title>
  <!-- Load Roboto font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js and annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <style>
    /* Reset and box-sizing */
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
      font-family: 'Roboto', sans-serif;
    }
    /* Disable vertical scroll on desktop */
    @media (min-width: 769px) { body { overflow-y: hidden; } }
    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --container-bg: #fff;
      --primary-color: #3498db;
      --primary-hover: #2980b9;
      --table-border: #ddd;
      --shadow-light: rgba(0,0,0,0.1);
      --shadow-dark: rgba(0,0,0,0.2);
      --button-shadow: 0 3px 6px rgba(0,0,0,0.15);
      --bg-gradient-light: linear-gradient(-45deg, #ffffff, #e6f7ff, #ffffff, #e6f7ff);
    }
    .dark {
      --bg-color: #121212;
      --text-color: #ccc;
      --container-bg: #1e1e1e;
      --primary-color: #2980b9;
      --primary-hover: #1f6391;
      --table-border: #555;
      --shadow-light: rgba(0,0,0,0.2);
      --shadow-dark: rgba(0,0,0,0.4);
      --button-shadow: 0 5px 10px rgba(0,0,0,0.2);
      --bg-gradient-dark: linear-gradient(-45deg, #1c1c3c, #32325d, #1c1c3c, #32325d);
    }
    body {
      background: var(--bg-gradient-light);
      background-size: 200% 200%;
      animation: bgShift 15s ease infinite;
      color: var(--text-color);
      transition: background 1s ease, color 1s ease;
    }
    body.dark {
      background: var(--bg-gradient-dark);
      background-size: 200% 200%;
      animation: bgShift 15s ease infinite;
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    section {
      min-height: 100vh;
      padding: 1.25rem 0.625rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .module {
      background: var(--container-bg);
      border-radius: 1rem;
      box-shadow: 0.5rem 0.5rem 1rem var(--shadow-light), -0.5rem -0.5rem 1rem var(--shadow-light);
      padding: 1.25rem 1.875rem;
      margin: 0.625rem auto;
      width: 90%;
      max-width: 56.25rem;
      transition: box-shadow 0.3s;
    }
    .module:hover {
      box-shadow: 0.625rem 0.625rem 1.25rem var(--shadow-dark), -0.625rem -0.625rem 1.25rem var(--shadow-dark);
    }
    .module h2 {
      text-align: center;
      margin-bottom: 1.25rem;
      font-size: 1.6rem;
      font-weight: 700;
      text-shadow: 0 2px 4px var(--shadow-light);
    }
    body.dark .module h2 { text-shadow: 0 2px 4px var(--shadow-dark); }
    /* Mode toggle container */
    .mode-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .mode-toggle {
      padding: 0.625rem 1.25rem;
      border: 0.125rem solid var(--primary-color);
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary-color);
      background: linear-gradient(45deg, #fff, #f0f0f0);
      transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
    }
    body.dark .mode-toggle {
      background: #444;
      border-color: #444;
      color: #ccc;
    }
    body.dark .mode-toggle.active {
      background: #2980b9;
      border-color: #2980b9;
      color: #fff;
    }
    .mode-toggle:hover { transform: scale(1.1); }
    /* Table styles */
    .table-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.25rem;
    }
    .table-box { flex: 1 1 45%; max-width: 45%; margin-bottom: 1.25rem; }
    .table-responsive { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 0.5rem 0.75rem;
      text-align: center;
      border-bottom: 0.125rem solid var(--primary-color);
      font-size: 0.95rem;
    }
    th { background: var(--primary-color); color: #fff; }
    /* Side menu */
    #sideMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 240px;
      height: 100%;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, background 0.3s ease;
      z-index: 1300;
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #sideMenu.collapsed { transform: translateX(-100%); }
    body.dark #sideMenu { background: rgba(34,34,34,0.7); }
    #sideMenu a {
      color: #333;
      text-decoration: none;
      font-size: 1.1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    body.dark #sideMenu a { color: #ddd; }
    #sideMenu a.active, #sideMenu a:hover {
      background: #3498db;
      color: #fff;
      transform: scale(1.05);
    }
    /* Site title */
    #siteTitleContainer {
      text-align: center;
      margin-bottom: 1rem;
      user-select: none;
      cursor: pointer;
    }
    #siteTitleContainer:hover { transform: scale(1.02); }
    #siteTitleContainer h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #siteTitleSub {
      display: block;
      margin-top: 0.25rem;
      font-size: 1rem;
      color: var(--primary-color);
      font-weight: bold;
    }
    #easterEggText {
      display: block;
      margin-top: 0.25rem;
      font-size: 1rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    /* Dark mode adjustments */
    body.dark select, body.dark input[type="text"] {
      background: #333;
      color: #fff;
      border-color: #555;
    }
    body.dark .result { background: #333; color: #fff; }
    /* Dark mode toggle */
    #darkModeToggle {
      margin-top: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-top: 1px solid #ccc;
      transition: transform 0.3s ease;
    }
    #darkModeToggle:hover { transform: scale(1.05); }
    #darkModeToggle svg { width: 1.5rem; height: 1.5rem; }
    #darkModeToggle span { font-size: 1rem; color: #333; }
    body.dark #darkModeToggle span { color: #eee; }
    /* Side menu toggle button */
    #sideMenuToggle {
      position: fixed;
      top: 10px;
      left: 250px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      color: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 1400;
      transition: left 0.3s ease, background 0.3s ease;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body.dark #sideMenuToggle { background: rgba(34,34,34,0.7); color: #ddd; }
    #sideMenuToggle:hover { transform: scale(1.1); }
    /* Process button and info */
    #processBtn {
      background: var(--primary-hover);
      color: #fff;
      border: none;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: background 0.3s;
    }
    #processBtn:hover { background: var(--primary-color); }
    #processInfo {
      max-height: 0;
      overflow-y: auto;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      margin-top: 0.5rem;
      padding: 0 0.5rem;
      background: #fff;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      white-space: pre-wrap;
      font-family: monospace;
      line-height: 1.5;
      position: relative;
      z-index: 500;
      color: #000;
      border: 0.125rem solid var(--table-border);
    }
    body.dark #processInfo { background: #333; color: #fff; }
    #processInfo.visible {
      max-height: 15rem;
      opacity: 1;
      padding: 0.5rem;
      padding-bottom: 3rem;
    }
    #processTopBtn {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.3rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    #processTopBtn:hover { background: var(--primary-hover); }
    .result {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #fff;
      border-radius: 0.5rem;
      text-align: left;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .result.visible { opacity: 1; }
    /* Chart styles */
    .chart-container { position: relative; height: 28rem; width: 100%; }
    #chartControls {
      text-align: center;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    #chartControls label { font-size: 1rem; color: var(--text-color); cursor: pointer; }
    /* Process animation */
    #processInfo span.char {
      opacity: 0;
      transition: opacity 0.05s ease;
      position: relative;
      display: inline-block;
    }
    .blinker {
      position: absolute;
      bottom: -4px;
      right: -6px;
      font-size: 0.8em;
      animation: blink 1s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }
    /* Credits */
    #hiddenCredits {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #808080;
      color: #fff;
      text-align: center;
      padding: 0.75rem;
      box-shadow: 0 -0.25rem 0.75rem rgba(0,0,0,0.3);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 500;
      font-size: 1rem;
    }
    #hiddenCredits.visible { transform: translateY(0); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Page navigation */
    #pageNav {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1200;
    }
    #pageNav button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #pageNav button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    #navPrev::before { content: "▲"; }
    #navNext::before { content: "▼"; }
    /* Button styles */
    button {
      background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 0.75rem;
      cursor: pointer;
      margin: 0.625rem 0;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
      box-shadow: var(--button-shadow);
    }
    button:hover {
      background: linear-gradient(45deg, var(--primary-hover), var(--primary-color), var(--primary-hover));
      background-size: 200% 200%;
      animation: gradientShift 1.5s ease infinite;
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Input and select styles */
    input[type="text"], select {
      padding: 0.5rem;
      border: 0.125rem solid var(--primary-color);
      border-radius: 0.5rem;
      font-size: 1.1rem;
      margin: 0.625rem 0;
      transition: border-color 0.3s, box-shadow 0.3s;
      background: #fff;
      color: #333;
    }
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: var(--primary-hover);
      box-shadow: 0 0 5px rgba(52,152,219,0.5);
    }
    /* Mobile adjustments */
    @media (max-width: 768px) {
      #calculator > div[style] {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
      }
      #calculator input[type="text"] { flex: 1; }
      #calcBtn { margin-left: 0.5rem; }
    }
  </style>
</head>
<body>
  <!-- Side menu toggle -->
  <button id="sideMenuToggle" title="Toggle Menu">☰</button>
  <!-- Side menu -->
  <div id="sideMenu">
    <div id="siteTitleContainer">
      <h1 id="siteTitle">Random Dice Defense : PvP</h1>
      <span id="siteTitleSub"></span>
      <span id="easterEggText"></span>
    </div>
    <div id="languageToggle">
      <svg id="globeIcon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 32 32" style="width:1.2rem; height:1.2rem;">
        <path d="M16 2.667C8.64 2.667 2.667 8.64 2.667 16S8.64 29.333 16 29.333 29.333 23.36 29.333 16 23.36 2.667 16 2.667zm0 24C9.76 26.667 4.667 21.573 4.667 16c0-5.573 5.093-10.667 11.333-10.667 6.24 0 11.333 5.093 11.333 10.667 0 5.573-5.093 10.667-11.333 10.667z"/>
        <path d="M14.667 4.76V27.24c-5.293-.64-9.333-5.107-9.333-11.24 0-6.133 5.093-10.6 9.333-11.24zM17.333 27.24V4.76c5.293.64 9.333 5.107 9.333 11.24 0 6.133-4.04 10.6-9.333 11.24z"/>
      </svg>
      <span>語言</span>
      <select id="langSelect" aria-label="Select Language">
        <option value="zh-TW">繁中</option>
        <option value="zh-CN">简中</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="ko">한국어</option>
      </select>
    </div>
    <a href="#calculator" id="menuCalculator" data-target="calculator"></a>
    <a href="#common" id="menuCommon" data-target="common"></a>
    <a href="#chartSection" id="menuChartSection" data-target="chartSection"></a>
    <a href="#history" id="menuHistory" data-target="history"></a>
    <div id="darkModeToggle">
      <svg id="darkModeIcon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"></svg>
      <span id="darkModeText"></span>
    </div>
  </div>
  <!-- Page navigation -->
  <div id="pageNav">
    <button id="navTop" title="Back to Top" aria-label="Back to Top">⥔</button>
    <button id="navPrev" title="Previous Page" aria-label="Previous Page"></button>
    <button id="navNext" title="Next Page" aria-label="Next Page"></button>
  </div>
  <!-- Calculator section -->
  <section id="calculator">
    <div class="module">
      <h2></h2>
      <div class="mode-container">
        <span class="mode-toggle active" id="btnR2C"></span>
        <span class="mode-toggle" id="btnC2R"></span>
        <button id="processBtn" title="Conversion Process" aria-label="Conversion Process"></button>
      </div>
      <div style="text-align: left; width: 100%;">
        <label for="inputValue">輸入數字（可用逗號分隔多值，例如：100, 200）：</label>
        <input type="text" id="inputValue" value="100" pattern="^[0-9,\s]+$" inputmode="numeric">
        <button id="calcBtn"></button>
        <div class="result" id="result">→ </div>
        <div id="processInfo"></div>
      </div>
    </div>
  </section>
  <!-- Common conversions section -->
  <section id="common">
    <div class="module">
      <h2></h2>
      <div class="table-container">
        <div class="table-box">
          <h3></h3>
          <div class="table-responsive">
            <table id="r2cTable">
              <thead><tr><th></th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="table-box">
          <h3></h3>
          <div class="table-responsive">
            <table id="c2rTable">
              <thead><tr><th></th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- Chart section -->
  <section id="chartSection">
    <div class="module">
      <h2></h2>
      <div style="text-align: center; margin-bottom: 1rem;">
        <label for="chartType"></label>
        <select id="chartType" style="font-size: 1rem; padding: 0.25rem;">
          <option value="line"></option>
          <option value="bar"></option>
        </select>
      </div>
      <div id="chartControls">
        <label><input type="checkbox" id="toggleAnnotations" checked><span id="annotationsLabel"></span></label>
        <label><input type="checkbox" id="togglePoints" checked><span id="pointsLabel"></span></label>
        <label><input type="checkbox" id="toggleGrid" checked><span id="gridLabel"></span></label>
      </div>
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>
  <!-- History section -->
  <section id="history">
    <div class="module">
      <h2></h2>
      <button id="clearHistory"></button>
      <div class="table-responsive">
        <table id="historyTable">
          <thead><tr><th></th><th></th><th></th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="historyPagination" style="text-align: center; margin-top: 1rem;"></div>
    </div>
  </section>
  <!-- Credits -->
  <div id="hiddenCredits"></div>
  <script>
    (function(){
      "use strict";
      // Config and LocalStorage keys
      const LS_KEYS = {
        darkMode: "converter_darkMode",
        lastInput: "converter_lastInput",
        mode: "converter_mode",
        history: "converter_history"
      };
      const CONFIG = {
        baseThreshold: 45,
        baseArray: [0,1,2,4,5],
        extraRanges: [
          {a: 46, b: 111, f: 1},
          {a: 112, b: 500, f: 2},
          {a: 501, b: 1000, f: 3},
          {a: 1001, b: 1500, f: 4},
          {a: 1501, b: Infinity, f: 5}
        ],
        chart: { maxRounds: 1600, step: 50 }
      };

      // Translation dictionary
      let currentLang = "zh-TW";
      const translations = {
        "zh-TW": {
          nav: { calculator: "換算器", common: "常用換算", chartSection: "關係圖", history: "歷史記錄" },
          calculator: {
            title: "卡片數 / 回合數 換算器",
            modeR2C: "回合 → 卡片",
            modeC2R: "卡片 → 回合",
            inputLabel: "輸入數字（可用逗號分隔多值，例如：100, 200）：",
            calcBtn: "計算",
            processBtn: "換算過程",
            invalidInput: "請輸入有效且大於 0 的數值"
          },
          common: { title: "常用換算", r2c: "回合 → 卡片", c2r: "卡片 → 回合" },
          chart: {
            title: "卡數 - 回合數 關係圖",
            chartTypeLabel: "圖表類型：",
            optionLine: "折線圖",
            optionBar: "柱狀圖",
            xAxis: "回合數",
            yAxis: "卡片數",
            showAnnotationsLabel: "顯示標註線",
            showPointsLabel: "顯示資料點",
            showGridLabel: "顯示網格線",
            roundSuffix: "回"
          },
          history: { title: "換算歷史記錄", clearHistory: "清除歷史", noRecord: "無歷史記錄" },
          process: {
            r2cTitle: "【回合 → 卡片 換算過程】",
            r2cIntro: "回合數轉換為卡片數分為兩個主要部分：前45回的基礎計算和超過45回的額外計算：",
            r2cBaseTitle: "1. 前45回的基礎計算：",
            r2cBaseDesc: "我們考慮輸入回合數與45的最小值，因為基礎計算僅適用於前45回。每完整的5回可獲得8張卡片，根據回合數除以5的餘數還有額外加成。",
            r2cBaseCalc: "   - 考慮的回合數：min({input}, 45) = {r}\n   - 完整5回數：floor({r}/5) = {fullSets}\n   - 完整部分的卡片：{fullSets} * 8 = {baseCalc}\n   - 餘數：{r} % 5 = {mod}\n   - 加成卡片：{lookup}\n   - 基礎卡片合計：{baseCalc} + {lookup} = {subtotal}",
            r2cExtraTitle: "2. 超過45回的額外卡片：",
            r2cExtraDesc: "對於超過45回的部分，我們根據不同的回合區間和對應的倍率來計算額外卡片。",
            r2cExtraCalc: "   - 區間 {a}～{b} (倍率 {f})：\n     - 此區間回合數：{roundsInRange}\n     - 額外卡片：{extra}",
            r2cTotal: "3. 總卡片數：基礎 ({subtotal}) + 額外 ({extraTotal}) = {result}",
            c2rTitle: "【卡片 → 回合 換算過程】",
            c2rIntro: "要找到獲得至少指定卡片數所需的最小回合數，我們使用二分搜尋算法：",
            c2rSetup: "1. 初始化搜尋範圍：低 = 1, 高 = {high}",
            c2rIteration: "2. 迭代：中間值 = {mid}, 卡片數 = {cards}",
            c2rResult: "3. 結果：最小回合數 = {result}"
          },
          tables: {
            r2c: { header1: "回合數", header2: "卡片數" },
            c2r: { header1: "卡片數", header2: "回合數" },
            history: { header1: "時間", header2: "模式", header3: "輸入值", header4: "結果" }
          },
          units: { r2c: " 卡片", c2r: " 回合" },
          pagination: { prev: "上一頁", next: "下一頁", pageInfo: "第 {current} 頁 / 共 {total} 頁" },
          credits: "網頁、圖表製作：Discord 𝕫𝕙𝕚𝕝𝕚 @zhili_71",
          darkMode: { light: "白天模式", dark: "黑夜模式" },
          siteTitleSub: "協同模式卡片計算器",
          easterEgg: {
            click1: "Thinking🤔",
            click3: "雙倍 Thinking🤔",
            click5: "三倍 Thinking🤔！",
            click7: "主宰一切！",
            click10: "狂暴攻擊！！",
            click15: "終極 Thinking🤔！！",
            click25: "無人能擋！！",
            click35: "變態殺戮！！",
            click45: "猛獸級 Thinking🤔！！！",
            click60: "超神的！！！！",
            click80: "比神還神！！！！"
          }
        },
        "en": {
          nav: { calculator: "Converter", common: "Common Conversions", chartSection: "Chart", history: "History" },
          calculator: {
            title: "Cards / Rounds Converter",
            modeR2C: "Rounds → Cards",
            modeC2R: "Cards → Rounds",
            inputLabel: "Enter numbers (comma-separated for multiple values, e.g., 100, 200):",
            calcBtn: "Calculate",
            processBtn: "Conversion Process",
            invalidInput: "Please enter valid numbers greater than 0"
          },
          common: { title: "Common Conversions", r2c: "Rounds → Cards", c2r: "Cards → Rounds" },
          chart: {
            title: "Cards vs. Rounds Chart",
            chartTypeLabel: "Chart Type:",
            optionLine: "Line Chart",
            optionBar: "Bar Chart",
            xAxis: "Rounds",
            yAxis: "Cards",
            showAnnotationsLabel: "Show Annotations",
            showPointsLabel: "Show Points",
            showGridLabel: "Show Grid",
            roundSuffix: " rounds"
          },
          history: { title: "Conversion History", clearHistory: "Clear History", noRecord: "No history records" },
          process: {
            r2cTitle: "Conversion Process: Rounds to Cards",
            r2cIntro: "To convert rounds to cards, we use a two-part calculation:",
            r2cBaseTitle: "1. Base Calculation for the First 45 Rounds:",
            r2cBaseDesc: "We consider the minimum of the input rounds and 45, as the base calculation applies only to the first 45 rounds. For every complete set of 5 rounds, you earn 8 cards. Bonus cards are added based on the remainder when divided by 5.",
            r2cBaseCalc: "   - Rounds considered: min({input}, 45) = {r}\n   - Full sets: floor({r}/5) = {fullSets}\n   - Cards from full sets: {fullSets} * 8 = {baseCalc}\n   - Remainder: {r} % 5 = {mod}\n   - Bonus cards: {lookup}\n   - Base total: {baseCalc} + {lookup} = {subtotal}",
            r2cExtraTitle: "2. Additional Cards for Rounds Beyond 45:",
            r2cExtraDesc: "For rounds exceeding 45, extra cards are calculated based on specific ranges with different multipliers.",
            r2cExtraCalc: "   - Range {a} to {b} (multiplier {f}):\n     - Rounds in range: {roundsInRange}\n     - Extra cards: {extra}",
            r2cTotal: "3. Total Cards: base ({subtotal}) + extra ({extraTotal}) = {result}",
            c2rTitle: "Conversion Process: Cards to Rounds",
            c2rIntro: "To find the minimum rounds needed for at least the specified cards, we use a binary search algorithm:",
            c2rSetup: "1. Initialize search range: low = 1, high = {high}",
            c2rIteration: "2. Iteration: mid = {mid}, cards = {cards}",
            c2rResult: "3. Result: minimum rounds = {result}"
          },
          tables: {
            r2c: { header1: "Rounds", header2: "Cards" },
            c2r: { header1: "Cards", header2: "Rounds" },
            history: { header1: "Time", header2: "Mode", header3: "Input", header4: "Result" }
          },
          units: { r2c: " cards", c2r: " rounds" },
          pagination: { prev: "Previous", next: "Next", pageInfo: "Page {current} of {total}" },
          credits: "Website & Chart by: Discord 𝕫𝕙𝕚𝕝𝕚 @zhili_71",
          darkMode: { light: "Light Mode", dark: "Dark Mode" },
          siteTitleSub: "Co-op Mode Card Calculator",
          easterEgg: {
            click1: "Thinking🤔",
            click3: "Double Thinking🤔",
            click5: "Triple Thinking🤔!",
            click7: "Dominate All!",
            click10: "Frenzied Attack!!",
            click15: "Ultimate Thinking🤔!!",
            click25: "Unstoppable!!",
            click35: "Insane Slaughter!!",
            click45: "Beast-Level Thinking🤔!!!",
            click60: "Super Divine!!!!",
            click80: "Beyond God!!!!"
          }
        },
        "zh-CN": {
          nav: { calculator: "换算器", common: "常用换算", chartSection: "关系图", history: "历史记录" },
          calculator: {
            title: "卡片数 / 回合数 换算器",
            modeR2C: "回合 → 卡片",
            modeC2R: "卡片 → 回合",
            inputLabel: "输入数字（可用逗号分隔多值，例如：100, 200）：",
            calcBtn: "计算",
            processBtn: "换算过程",
            invalidInput: "请输入有效且大于 0 的数值"
          },
          common: { title: "常用换算", r2c: "回合 → 卡片", c2r: "卡片 → 回合" },
          chart: {
            title: "卡数 - 回合数 关系图",
            chartTypeLabel: "图表类型：",
            optionLine: "折线图",
            optionBar: "柱状图",
            xAxis: "回合数",
            yAxis: "卡片数",
            showAnnotationsLabel: "显示标注线",
            showPointsLabel: "显示数据点",
            showGridLabel: "显示网格线",
            roundSuffix: "回"
          },
          history: { title: "换算历史记录", clearHistory: "清除历史", noRecord: "无历史记录" },
          process: {
            r2cTitle: "【回合 → 卡片 换算过程】",
            r2cIntro: "回合数转换为卡片数分为两个主要部分：前45回的基础计算和超过45回的额外计算：",
            r2cBaseTitle: "1. 前45回的基础计算：",
            r2cBaseDesc: "我们考虑输入回合数与45的最小值，因为基础计算仅适用于前45回。每完整的5回可获得8张卡片，根據回合数除以5的余数还有额外加成。",
            r2cBaseCalc: "   - 考虑的回合数：min({input}, 45) = {r}\n   - 完整5回数：floor({r}/5) = {fullSets}\n   - 完整部分的卡片：{fullSets} * 8 = {baseCalc}\n   - 余数：{r} % 5 = {mod}\n   - 加成卡片：{lookup}\n   - 基础卡片合计：{baseCalc} + {lookup} = {subtotal}",
            r2cExtraTitle: "2. 超过45回的额外卡片：",
            r2cExtraDesc: "对于超过45回的部分，我们根据不同的回合区间和对应的倍率来计算额外卡片。",
            r2cExtraCalc: "   - 区间 {a}～{b} (倍率 {f})：\n     - 此区间回合数：{roundsInRange}\n     - 额外卡片：{extra}",
            r2cTotal: "3. 总卡片数：基础 ({subtotal}) + 额外 ({extraTotal}) = {result}",
            c2rTitle: "【卡片 → 回合 换算过程】",
            c2rIntro: "要找到获得至少指定卡片数所需的最小回合数，我们使用二分搜索算法：",
            c2rSetup: "1. 初始化搜索范围：低 = 1, 高 = {high}",
            c2rIteration: "2. 迭代：中间值 = {mid}, 卡片数 = {cards}",
            c2rResult: "3. 结果：最小回合数 = {result}"
          },
          tables: {
            r2c: { header1: "回合数", header2: "卡片数" },
            c2r: { header1: "卡片数", header2: "回合数" },
            history: { header1: "时间", header2: "模式", header3: "输入值", header4: "结果" }
          },
          units: { r2c: " 卡片", c2r: " 回合" },
          pagination: { prev: "上一页", next: "下一页", pageInfo: "第 {current} 页 / 共 {total} 页" },
          credits: "网页、图表制作：Discord 𝕫𝕙𝕚𝕝𝕚 @zhili_71",
          darkMode: { light: "白天模式", dark: "黑夜模式" },
          siteTitleSub: "协同模式卡片计算器",
          easterEgg: {
            click1: "Thinking🤔",
            click3: "双倍 Thinking🤔",
            click5: "三倍 Thinking🤔！",
            click7: "主宰一切！",
            click10: "狂暴攻击！！",
            click15: "终极 Thinking🤔！！",
            click25: "无人能挡！！",
            click35: "变态杀戮！！",
            click45: "猛兽级 Thinking🤔！！！",
            click60: "超神的！！！！",
            click80: "比神还神！！！！"
          }
        },
        "ja": {
          nav: { calculator: "変換器", common: "一般的な変換", chartSection: "チャート", history: "履歴" },
          calculator: {
            title: "カード数 / ラウンド数 変換器",
            modeR2C: "ラウンド → カード",
            modeC2R: "カード → ラウンド",
            inputLabel: "数字を入力してください（複数の値をカンマで区切ってください、例：100, 200）：",
            calcBtn: "計算",
            processBtn: "変換プロセス",
            invalidInput: "0より大きい有効な数値を入力してください"
          },
          common: { title: "一般的な変換", r2c: "ラウンド → カード", c2r: "カード → ラウンド" },
          chart: {
            title: "カード数 - ラウンド数 チャート",
            chartTypeLabel: "チャートタイプ：",
            optionLine: "折れ線グラフ",
            optionBar: "棒グラフ",
            xAxis: "ラウンド数",
            yAxis: "カード数",
            showAnnotationsLabel: "注釈を表示",
            showPointsLabel: "データポイントを表示",
            showGridLabel: "グリッド線を表示",
            roundSuffix: "ラウンド"
          },
          history: { title: "変換履歴", clearHistory: "履歴をクリア", noRecord: "履歴記録なし" },
          process: {
            r2cTitle: "【ラウンド → カード 変換プロセス】",
            r2cIntro: "ラウンドからカードへの変換は2つの主要な部分に分かれます：最初の45ラウンドの基本計算と45ラウンドを超える追加計算です。",
            r2cBaseTitle: "1. 最初の45ラウンドの基本計算：",
            r2cBaseDesc: "入力ラウンドと45の最小値を考慮します。5ラウンドごとに8枚のカードを獲得し、5で割った余りに基づいてボーナスカードが追加されます。",
            r2cBaseCalc: "   - 考慮されるラウンド：min({input}, 45) = {r}\n   - 完全な5ラウンドセット：floor({r}/5) = {fullSets}\n   - セットからのカード：{fullSets} * 8 = {baseCalc}\n   - 余り：{r} % 5 = {mod}\n   - ボーナスカード：{lookup}\n   - 基本合計：{baseCalc} + {lookup} = {subtotal}",
            r2cExtraTitle: "2. 45ラウンドを超える追加カード：",
            r2cExtraDesc: "45ラウンドを超える部分については、特定の範囲と乗数に基づいて追加カードを計算します。",
            r2cExtraCalc: "   - 範囲 {a}～{b} (乗数 {f})：\n     - この範囲のラウンド数：{roundsInRange}\n     - 追加カード：{extra}",
            r2cTotal: "3. 総カード数：基本 ({subtotal}) + 追加 ({extraTotal}) = {result}",
            c2rTitle: "【カード → ラウンド 変換プロセス】",
            c2rIntro: "指定されたカード数以上を獲得するために必要な最小ラウンド数を見つけるために、バイナリサーチアルゴリズムを使用します：",
            c2rSetup: "1. 検索範囲を初期化：低 = 1, 高 = {high}",
            c2rIteration: "2. 反復：中間値 = {mid}, カード数 = {cards}",
            c2rResult: "3. 結果：最小ラウンド数 = {result}"
          },
          tables: {
            r2c: { header1: "ラウンド数", header2: "カード数" },
            c2r: { header1: "カード数", header2: "ラウンド数" },
            history: { header1: "時間", header2: "モード", header3: "入力値", header4: "結果" }
          },
          units: { r2c: " カード", c2r: " ラウンド" },
          pagination: { prev: "前へ", next: "次へ", pageInfo: "ページ {current} / {total}" },
          credits: "ウェブサイト＆チャート：Discord 𝕫𝕙𝕚𝕝𝕚 @zhili_71",
          darkMode: { light: "ライトモード", dark: "ダークモード" },
          siteTitleSub: "協力モードカード計算機",
          easterEgg: {
            click1: "Thinking🤔",
            click3: "ダブル Thinking🤔",
            click5: "トリプル Thinking🤔！",
            click7: "全てを支配！",
            click10: "狂乱の攻撃！！",
            click15: "究極の Thinking🤔！！",
            click25: "無敵！！",
            click35: "狂気の殺戮！！",
            click45: "獣級 Thinking🤔！！！",
            click60: "超神！！！！",
            click80: "神を超える！！！！"
          }
        },
        "ko": {
          nav: { calculator: "변환기", common: "일반 변환", chartSection: "차트", history: "기록" },
          calculator: {
            title: "카드 수 / 라운드 수 변환기",
            modeR2C: "라운드 → 카드",
            modeC2R: "카드 → 라운드",
            inputLabel: "숫자를 입력하세요 (여러 값을 쉼표로 구분, 예: 100, 200):",
            calcBtn: "계산",
            processBtn: "변환 과정",
            invalidInput: "0보다 큰 유효한 숫자를 입력하세요"
          },
          common: { title: "일반 변환", r2c: "라운드 → 카드", c2r: "카드 → 라운드" },
          chart: {
            title: "카드 수 - 라운드 수 차트",
            chartTypeLabel: "차트 유형:",
            optionLine: "선 그래프",
            optionBar: "막대 그래프",
            xAxis: "라운드 수",
            yAxis: "카드 수",
            showAnnotationsLabel: "주석 표시",
            showPointsLabel: "데이터 포인트 표시",
            showGridLabel: "그리드 라인 표시",
            roundSuffix: "라운드"
          },
          history: { title: "변환 기록", clearHistory: "기록 지우기", noRecord: "기록 없음" },
          process: {
            r2cTitle: "【라운드 → 카드 변환 과정】",
            r2cIntro: "라운드에서 카드로의 변환은 두 가지 주요 부분으로 나뉩니다: 처음 45라운드의 기본 계산과 45라운드를 초과하는 추가 계산입니다.",
            r2cBaseTitle: "1. 처음 45라운드의 기본 계산:",
            r2cBaseDesc: "입력 라운드와 45 중 더 작은 값을 고려합니다. 5라운드마다 8장의 카드를 얻으며, 5로 나눈 나머지에 따라 보너스 카드가 추가됩니다.",
            r2cBaseCalc: "   - 고려된 라운드: min({input}, 45) = {r}\n   - 완전한 5라운드 세트: floor({r}/5) = {fullSets}\n   - 세트에서 얻은 카드: {fullSets} * 8 = {baseCalc}\n   - 나머지: {r} % 5 = {mod}\n   - 보너스 카드: {lookup}\n   - 기본 합계: {baseCalc} + {lookup} = {subtotal}",
            r2cExtraTitle: "2. 45라운드를 초과하는 추가 카드:",
            r2cExtraDesc: "45라운드를 초과하는 부분은 특정 범위와 배율에 따라 추가 카드를 계산합니다.",
            r2cExtraCalc: "   - 범위 {a}～{b} (배율 {f}): \n     - 이 범위의 라운드 수: {roundsInRange}\n     - 추가 카드: {extra}",
            r2cTotal: "3. 총 카드 수: 기본 ({subtotal}) + 추가 ({extraTotal}) = {result}",
            c2rTitle: "【카드 → 라운드 변환 과정】",
            c2rIntro: "지정된 카드 수 이상을 얻기 위해 필요한 최소 라운드 수를 찾기 위해 이진 탐색 알고리즘을 사용합니다:",
            c2rSetup: "1. 검색 범위 초기화: 저 = 1, 고 = {high}",
            c2rIteration: "2. 반복: 중간값 = {mid}, 카드 수 = {cards}",
            c2rResult: "3. 결과: 최소 라운드 수 = {result}"
          },
          tables: {
            r2c: { header1: "라운드 수", header2: "카드 수" },
            c2r: { header1: "카드 수", header2: "라운드 수" },
            history: { header1: "시간", header2: "모드", header3: "입력값", header4: "결과" }
          },
          units: { r2c: " 카드", c2r: " 라운드" },
          pagination: { prev: "이전", next: "다음", pageInfo: "페이지 {current} / {total}" },
          credits: "웹사이트 & 차트: Discord 𝕫𝕙𝕚𝕝𝕚 @zhili_71",
          darkMode: { light: "라이트 모드", dark: "다크 모드" },
          siteTitleSub: "협동 모드 카드 계산기",
          easterEgg: {
            click1: "Thinking🤔",
            click3: "더블 Thinking🤔",
            click5: "트리플 Thinking🤔!",
            click7: "모두 지배!",
            click10: "광란의 공격!!",
            click15: "궁극의 Thinking🤔!!",
            click25: "무적!!",
            click35: "광기의 살육!!",
            click45: "야수급 Thinking🤔!!!",
            click60: "초신!!!!",
            click80: "신을 초월!!!!"
          }
        }
      };

      // DOM elements
      const body = document.body;
      const inputValueElem = document.getElementById("inputValue");
      const resultDiv = document.getElementById("result");
      const processInfo = document.getElementById("processInfo");
      const btnR2C = document.getElementById("btnR2C");
      const btnC2R = document.getElementById("btnC2R");
      const calcBtn = document.getElementById("calcBtn");
      const processBtn = document.getElementById("processBtn");
      const chartTypeSelect = document.getElementById("chartType");
      const toggleAnnotationsCheckbox = document.getElementById("toggleAnnotations");
      const togglePointsCheckbox = document.getElementById("togglePoints");
      const toggleGridCheckbox = document.getElementById("toggleGrid");
      const r2cTableBody = document.getElementById("r2cTable").querySelector("tbody");
      const c2rTableBody = document.getElementById("c2rTable").querySelector("tbody");
      const historyTableBody = document.getElementById("historyTable").querySelector("tbody");
      const clearHistoryBtn = document.getElementById("clearHistory");
      const navTopBtn = document.getElementById("navTop");
      const navPrevBtn = document.getElementById("navPrev");
      const navNextBtn = document.getElementById("navNext");
      const historyPagination = document.getElementById("historyPagination");
      const darkModeToggle = document.getElementById("darkModeToggle");
      const darkModeIcon = document.getElementById("darkModeIcon");
      const darkModeText = document.getElementById("darkModeText");
      const langSelect = document.getElementById("langSelect");
      const sideMenuToggle = document.getElementById("sideMenuToggle");
      const siteTitleContainer = document.getElementById("siteTitleContainer");
      const siteTitleSub = document.getElementById("siteTitleSub");
      const easterEggText = document.getElementById("easterEggText");
      let myChart = null;
      let currentChartType = chartTypeSelect.value;
      let mode = "r2c";
      let historyData = [];
      let currentHistoryPage = 0;
      const recordsPerPage = 5;
      let typewriterInterval = null;
      let typewriterIndex = 0;
      let processTextCache = "";
      let eggClickCount = 0;
      let eggTimeout = null;

      // Restrict input to numbers and commas
      inputValueElem.addEventListener("input", function(){ this.value = this.value.replace(/[^0-9,]/g, ""); });

      // LocalStorage functions
      function saveLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
      function loadLS(key, defaultValue) {
        const val = localStorage.getItem(key);
        return val ? JSON.parse(val) : defaultValue;
      }

      // Initialize preferences
      function initPreferences(){
        const darkPref = loadLS(LS_KEYS.darkMode, null);
        if(darkPref !== null) body.classList.toggle("dark", darkPref);
        else if(window.matchMedia('(prefers-color-scheme: dark)').matches) body.classList.add("dark");
        renderToggleBtn();
        inputValueElem.value = loadLS(LS_KEYS.lastInput, "100");
        mode = loadLS(LS_KEYS.mode, "r2c");
        btnR2C.classList.toggle("active", mode === "r2c");
        btnC2R.classList.toggle("active", mode === "c2r");
        historyData = loadLS(LS_KEYS.history, []);
        renderHistory();
        updateLanguage();
      }

      // Side menu toggle
      sideMenuToggle.addEventListener("click", function(){
        sideMenu.classList.toggle("collapsed");
        sideMenuToggle.style.left = sideMenu.classList.contains("collapsed") ? "0px" : "250px";
      });

      // Dark mode toggle
      function renderToggleBtn(){
        darkModeIcon.innerHTML = body.classList.contains("dark") ? getSunSVG() : getMoonSVG();
        darkModeText.textContent = translations[currentLang].darkMode[body.classList.contains("dark") ? "light" : "dark"];
        updateChartAxisColor();
      }
      function getSunSVG(){
        return `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2"/>
          <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2"/>
        </svg>`;
      }
      function getMoonSVG(){
        return `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9.37 5.51A7 7 0 0 0 12 19a7 7 0 0 0 6.49-9.64A9 9 0 1 1 9.37 5.51z"/>
        </svg>`;
      }
      darkModeToggle.addEventListener("click", function(){
        body.classList.toggle("dark");
        renderToggleBtn();
        saveLS(LS_KEYS.darkMode, body.classList.contains("dark"));
      });

      // Desktop scroll handling
      if(window.innerWidth > 768) {
        window.addEventListener("wheel", function(e) {
          e.preventDefault();
          const sections = Array.from(document.querySelectorAll("section"));
          const currentScroll = window.scrollY;
          let target = null;
          if(e.deltaY > 0) {
            for(let i = 0; i < sections.length; i++){
              if(sections[i].offsetTop > currentScroll + 50){
                target = sections[i];
                break;
              }
            }
          } else {
            for(let i = sections.length - 1; i >= 0; i--){
              if(sections[i].offsetTop < currentScroll - 50){
                target = sections[i];
                break;
              }
            }
          }
          if(target) target.scrollIntoView({ behavior: "smooth" });
        }, {passive: false});
      }

      // Page navigation
      window.addEventListener("scroll", function(){
        document.getElementById("hiddenCredits").classList.toggle("visible", window.innerHeight + window.scrollY >= document.body.offsetHeight - 150);
        updateSideMenuHighlight();
      });
      navTopBtn.addEventListener("click", function(){ window.scrollTo({ top: 0, behavior: "smooth" }); });
      navPrevBtn.addEventListener("click", function(){
        const sections = Array.from(document.querySelectorAll("section"));
        const currentScroll = window.scrollY;
        let target = null;
        for(let i = sections.length - 1; i >= 0; i--){
          if(sections[i].offsetTop < currentScroll - 50){
            target = sections[i];
            break;
          }
        }
        if(target) target.scrollIntoView({ behavior: "smooth" });
      });
      navNextBtn.addEventListener("click", function(){
        const sections = Array.from(document.querySelectorAll("section"));
        const currentScroll = window.scrollY;
        let target = null;
        for(let i = 0; i < sections.length; i++){
          if(sections[i].offsetTop > currentScroll + 50){
            target = sections[i];
            break;
          }
        }
        if(target) target.scrollIntoView({ behavior: "smooth" });
      });

      // Side menu highlight
      function updateSideMenuHighlight() {
        const sections = document.querySelectorAll("section");
        let currentSectionId = "";
        sections.forEach(sec => {
          if(window.scrollY >= sec.offsetTop - 100) currentSectionId = sec.id;
        });
        document.querySelectorAll("#sideMenu a").forEach(link => {
          link.classList.toggle("active", link.getAttribute("href") === "#" + currentSectionId);
        });
      }

      // Conversion functions
      function roundsToCards(t){
        let T = BigInt(t);
        if(T < 1n) return 0n;
        const baseThreshold = BigInt(CONFIG.baseThreshold);
        let r = T < baseThreshold ? T : baseThreshold;
        const baseArray = CONFIG.baseArray.map(x => BigInt(x));
        let base = (r / 5n) * 8n + baseArray[Number(r % 5n)];
        let extra = 0n;
        CONFIG.extraRanges.forEach(range => {
          let a = BigInt(range.a);
          let b = (range.b === Infinity) ? T : BigInt(range.b);
          let f = BigInt(range.f);
          if(T >= a){
            let x = T < b ? T : b;
            let term1 = x - a + 1n;
            let term2 = ((x + 1n) / 2n) - (a / 2n);
            extra += 2n * f * (term1 + 2n * term2);
          }
        });
        return base + extra;
      }
      function cardsToRounds(x){
        let X = BigInt(x);
        if(X < 1n) return 0n;
        let l = 1n, h = 1n;
        while(roundsToCards(h) < X){ h *= 2n; }
        while(l < h){
          let m = (l + h) / 2n;
          if(roundsToCards(m) < X) l = m + 1n; else h = m;
        }
        return l;
      }

      // Process animation
      function animateProcessText(text) {
        if(processTextCache === text) return;
        processTextCache = text;
        typewriterIndex = 0;
        if(typewriterInterval) clearInterval(typewriterInterval);
        processInfo.innerHTML = "";
        let currentBlinker = null;
        let currentLineSpan = document.createElement("span");
        currentLineSpan.className = "line";
        processInfo.appendChild(currentLineSpan);

        typewriterInterval = setInterval(() => {
          if (typewriterIndex < text.length) {
            if (currentBlinker) {
              currentBlinker.remove();
              currentBlinker = null;
            }
            let char = text[typewriterIndex];
            if (char === "\n") {
              let br = document.createElement("br");
              processInfo.appendChild(br);
              currentLineSpan = document.createElement("span");
              currentLineSpan.className = "line";
              processInfo.appendChild(currentLineSpan);
            } else {
              let charSpan = document.createElement("span");
              charSpan.className = "char";
              charSpan.textContent = char;
              currentLineSpan.appendChild(charSpan);
              let blinker = document.createElement("span");
              blinker.className = "blinker";
              blinker.textContent = "●";
              charSpan.appendChild(blinker);
              currentBlinker = blinker;
              requestAnimationFrame(() => { charSpan.style.opacity = "1"; });
            }
            typewriterIndex++;
          } else {
            clearInterval(typewriterInterval);
            typewriterInterval = null;
          }
        }, 2);
      }

      // Update result and process
      function updateResult(){
        let inputStr = inputValueElem.value.trim();
        let inputs = inputStr.split(",").map(s => s.trim()).filter(s => /^\d+$/.test(s) && s !== "0");
        if (inputs.length === 0) {
          resultDiv.innerText = translations[currentLang].calculator.invalidInput;
          resultDiv.classList.add("visible");
          return;
        }
        saveLS(LS_KEYS.lastInput, inputStr);
        let results = [];
        inputs.forEach(input => {
          let calcResult = mode === "r2c" ? roundsToCards(input) : cardsToRounds(input);
          results.push(`${input} → ${calcResult}${translations[currentLang].units[mode]}`);
          addHistoryRecord(Date.now(), mode, input);
        });
        resultDiv.innerText = results.join("\n");
        resultDiv.classList.add("visible");
        updateProcessInfo(inputs[0]);
      }
      function updateProcessInfo(inputStr){
        if(resultDiv.innerText.trim() === "→") return;
        if(!/^\d+$/.test(inputStr) || inputStr === "0"){
          processInfo.innerHTML = "<pre>" + translations[currentLang].calculator.invalidInput + "</pre>";
          return;
        }
        const t = translations[currentLang];
        let explanation = mode === "r2c" ? t.process.r2cTitle + "\n\n" : t.process.c2rTitle + "\n\n";
        if(mode === "r2c"){
          explanation += t.process.r2cIntro + "\n\n";
          const r = BigInt(inputStr) < BigInt(CONFIG.baseThreshold) ? BigInt(inputStr) : BigInt(CONFIG.baseThreshold);
          const fullSets = (r / 5n);
          const baseCalc = fullSets * 8n;
          const baseArray = CONFIG.baseArray.map(x => BigInt(x));
          const mod = r % 5n;
          const lookup = baseArray[Number(mod)];
          let subtotal = baseCalc + lookup;
          explanation += t.process.r2cBaseTitle + "\n" + t.process.r2cBaseDesc + "\n" +
            t.process.r2cBaseCalc
              .replace("{input}", inputStr)
              .replace("{r}", r.toString())
              .replace("{fullSets}", fullSets.toString())
              .replace("{baseCalc}", baseCalc.toString())
              .replace("{mod}", mod.toString())
              .replace("{lookup}", lookup.toString())
              .replace("{subtotal}", subtotal.toString()) + "\n\n";
          let extraTotal = 0n;
          if(BigInt(inputStr) > BigInt(CONFIG.baseThreshold)){
            explanation += t.process.r2cExtraTitle + "\n" + t.process.r2cExtraDesc + "\n";
            CONFIG.extraRanges.forEach(range => {
              let a = BigInt(range.a);
              let b = (range.b === Infinity) ? BigInt(inputStr) : BigInt(range.b);
              let f = BigInt(range.f);
              if(BigInt(inputStr) >= a){
                let x = BigInt(inputStr) < b ? BigInt(inputStr) : b;
                let roundsInRange = x - a + 1n;
                let term1 = roundsInRange;
                let term2 = ((x + 1n) / 2n) - (a / 2n);
                let extra = 2n * f * (term1 + 2n * term2);
                explanation += t.process.r2cExtraCalc
                  .replace("{a}", a.toString())
                  .replace("{b}", (b === BigInt(inputStr) ? inputStr : b.toString()))
                  .replace("{f}", f.toString())
                  .replace("{roundsInRange}", roundsInRange.toString())
                  .replace("{extra}", extra.toString()) + "\n";
                extraTotal += extra;
              }
            });
            explanation += "\n" + t.process.r2cTotal
              .replace("{subtotal}", subtotal.toString())
              .replace("{extraTotal}", extraTotal.toString())
              .replace("{result}", roundsToCards(inputStr).toString()) + "\n";
          }
        } else {
          explanation += t.process.c2rIntro + "\n";
          let low = 1n, high = 1n;
          while(roundsToCards(high) < BigInt(inputStr)){ high *= 2n; }
          explanation += t.process.c2rSetup.replace("{high}", high.toString()) + "\n";
          while(low < high){
            let mid = (low + high) / 2n;
            let cards = roundsToCards(mid);
            explanation += t.process.c2rIteration.replace("{mid}", mid.toString()).replace("{cards}", cards.toString()) + "\n";
            if(cards < BigInt(inputStr)) low = mid + 1n; else high = mid;
          }
          explanation += t.process.c2rResult.replace("{result}", low.toString()) + "\n";
        }
        animateProcessText(explanation);
      }

      // Add scroll-to-top button for process
      function addProcessTopBtn(){
        if(!document.getElementById("processTopBtn")){
          const topBtn = document.createElement("button");
          topBtn.id = "processTopBtn";
          topBtn.innerHTML = "⥔";
          topBtn.addEventListener("click", function(){ processInfo.scrollTo({ top: 0, behavior: "smooth" }); });
          processInfo.appendChild(topBtn);
        }
      }

      // Populate tables and chart
      function populateTables(){
        const r2cValues = [111,200,300,1000,1500,2000,2500,10000,20000];
        const c2rValues = [40,400,4000,8000,12000,16000,20000,40000,400000];
        r2cValues.forEach(rounds => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${rounds}</td><td>${roundsToCards(rounds).toString()}</td>`;
          r2cTableBody.appendChild(tr);
        });
        c2rValues.forEach(cards => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${cards}</td><td>${cardsToRounds(cards).toString()}</td>`;
          c2rTableBody.appendChild(tr);
        });
      }
      function generateChart(){
        const dataPoints = [];
        const maxRounds = CONFIG.chart.maxRounds;
        const step = CONFIG.chart.step;
        for(let r=0; r<=maxRounds; r+=step){
          dataPoints.push({x: r, y: Number(roundsToCards(r))});
        }
        const maxY = Number(roundsToCards(maxRounds));
        const ctx = document.getElementById("chart").getContext("2d");
        if(myChart) myChart.destroy();
        const t = translations[currentLang];
        const datasetOptions = {
          label: t.chart.yAxis,
          data: dataPoints,
          borderColor: "rgba(75,192,192,1)",
          backgroundColor: "rgba(75,192,192,0.2)",
          pointRadius: togglePointsCheckbox.checked ? 4 : 0,
          fill: false,
          tension: 0.15
        };
        const chartOptions = {
          type: currentChartType,
          data: { datasets: [datasetOptions] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 1000, easing: 'easeInOutQuad' },
            plugins: {
              tooltip: {
                mode: "index",
                intersect: false,
                callbacks: { label: context => `${t.chart.xAxis}: ${context.parsed.x}, ${t.chart.yAxis}: ${context.parsed.y}` }
              },
              datalabels: { display: false }
            },
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: t.chart.xAxis },
                min: 0,
                max: maxRounds,
                ticks: { font: { size: 14 }, color: body.classList.contains("dark") ? "#fff" : "#333" },
                grid: { display: toggleGridCheckbox.checked }
              },
              y: {
                title: { display: true, text: t.chart.yAxis },
                min: 0,
                max: maxY,
                ticks: { 
                  stepSize: 3000, 
                  callback: value => Math.round(value),
                  font: { size: 14 }, 
                  color: body.classList.contains("dark") ? "#fff" : "#333" 
                },
                grid: { display: toggleGridCheckbox.checked }
              }
            }
          }
        };
        if(toggleAnnotationsCheckbox.checked){
          chartOptions.options.plugins.annotation = {
            annotations: {
              line45: { type: "line", scaleID: "x", value: 45, borderColor: "rgba(255,0,0,0.8)", borderWidth: 2, borderDash: [6,3], label: { enabled: true, position: "start", yAdjust: 10, content: ["45" + t.chart.roundSuffix, roundsToCards(45).toString()], backgroundColor: "rgba(0,0,0,0.7)", color: "#fff", font: { weight: "bold", size: 12 }, borderRadius: 4, padding: 4 } },
              line111: { type: "line", scaleID: "x", value: 111, borderColor: "rgba(255,0,0,0.8)", borderWidth: 2, borderDash: [6,3], label: { enabled: true, position: "start", yAdjust: 10, content: ["111" + t.chart.roundSuffix, roundsToCards(111).toString()], backgroundColor: "rgba(0,0,0,0.7)", color: "#fff", font: { weight: "bold", size: 12 }, borderRadius: 4, padding: 4 } },
              line501: { type: "line", scaleID: "x", value: 501, borderColor: "rgba(255,0,0,0.8)", borderWidth: 2, borderDash: [6,3], label: { enabled: true, position: "start", yAdjust: 10, content: ["501" + t.chart.roundSuffix, roundsToCards(501).toString()], backgroundColor: "rgba(0,0,0,0.7)", color: "#fff", font: { weight: "bold", size: 12 }, borderRadius: 4, padding: 4 } },
              line1001: { type: "line", scaleID: "x", value: 1001, borderColor: "rgba(255,0,0,0.8)", borderWidth: 2, borderDash: [6,3], label: { enabled: true, position: "start", yAdjust: 10, content: ["1001" + t.chart.roundSuffix, roundsToCards(1001).toString()], backgroundColor: "rgba(0,0,0,0.7)", color: "#fff", font: { weight: "bold", size: 12 }, borderRadius: 4, padding: 4 } },
              line1501: { type: "line", scaleID: "x", value: 1501, borderColor: "rgba(255,0,0,0.8)", borderWidth: 2, borderDash: [6,3], label: { enabled: true, position: "start", yAdjust: 10, content: ["1501" + t.chart.roundSuffix, roundsToCards(1501).toString()], backgroundColor: "rgba(0,0,0,0.7)", color: "#fff", font: { weight: "bold", size: 12 }, borderRadius: 4, padding: 4 } }
            }
          };
        }
        myChart = new Chart(ctx, chartOptions);
      }
      chartTypeSelect.addEventListener("change", function(){ currentChartType = this.value; generateChart(); });
      toggleAnnotationsCheckbox.addEventListener("change", generateChart);
      togglePointsCheckbox.addEventListener("change", generateChart);
      toggleGridCheckbox.addEventListener("change", generateChart);

      // Mode switching
      btnR2C.addEventListener("click", function(){
        mode = "r2c";
        btnR2C.classList.add("active");
        btnC2R.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "→") updateResult();
      });
      btnC2R.addEventListener("click", function(){
        mode = "c2r";
        btnC2R.classList.add("active");
        btnR2C.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "→") updateResult();
      });
      calcBtn.addEventListener("click", updateResult);
      processBtn.addEventListener("click", function(e){
        e.stopPropagation();
        processInfo.classList.toggle("visible");
        if(processInfo.classList.contains("visible") && !typewriterInterval && typewriterIndex < processTextCache.length) {
          animateProcessText(processTextCache);
        }
        updateResult();
      });
      processInfo.addEventListener("wheel", function(e){ e.stopPropagation(); });

      // History functions
      function addHistoryRecord(timestamp, modeUsed, input){
        historyData.unshift({ timestamp, mode: modeUsed, input });
        saveLS(LS_KEYS.history, historyData);
        currentHistoryPage = 0;
        renderHistory();
      }
      function renderHistory(){
        historyTableBody.innerHTML = "";
        if(historyData.length === 0){
          historyTableBody.innerHTML = `<tr><td colspan='4'>${translations[currentLang].history.noRecord}</td></tr>`;
        } else {
          historyData.slice(currentHistoryPage * recordsPerPage, (currentHistoryPage+1) * recordsPerPage)
            .forEach(rec => {
              const tr = document.createElement("tr");
              const timeStr = new Date(rec.timestamp).toLocaleString(currentLang === "zh-TW" || currentLang === "zh-CN" ? "zh-TW" : "en-US");
              let computed = (rec.mode === "r2c") ? roundsToCards(rec.input) : cardsToRounds(rec.input);
              let resultText = "→ " + computed.toString() + (rec.mode === "r2c" ? translations[currentLang].units.r2c : translations[currentLang].units.c2r);
              let modeText = (rec.mode === "r2c") ? translations[currentLang].calculator.modeR2C : translations[currentLang].calculator.modeC2R;
              tr.innerHTML = `<td>${timeStr}</td><td>${modeText}</td><td>${rec.input}</td><td>${resultText}</td>`;
              historyTableBody.appendChild(tr);
            });
        }
        renderHistoryPagination();
      }
      function renderHistoryPagination(){
        historyPagination.innerHTML = "";
        const totalPages = Math.ceil(historyData.length / recordsPerPage);
        if(totalPages <= 1) return;
        const paginationDiv = document.createElement("div");
        if(currentHistoryPage > 0){
          const prevBtn = document.createElement("button");
          prevBtn.textContent = translations[currentLang].pagination.prev;
          prevBtn.style.marginRight = "1rem";
          prevBtn.addEventListener("click", function(){ currentHistoryPage--; renderHistory(); });
          paginationDiv.appendChild(prevBtn);
        }
        const pageInfo = document.createElement("span");
        pageInfo.textContent = translations[currentLang].pagination.pageInfo
          .replace("{current}", currentHistoryPage + 1)
          .replace("{total}", totalPages);
        paginationDiv.appendChild(pageInfo);
        if(currentHistoryPage < totalPages - 1){
          const nextBtn = document.createElement("button");
          nextBtn.textContent = translations[currentLang].pagination.next;
          nextBtn.style.marginLeft = "1rem";
          nextBtn.addEventListener("click", function(){ currentHistoryPage++; renderHistory(); });
          paginationDiv.appendChild(nextBtn);
        }
        historyPagination.appendChild(paginationDiv);
      }
      clearHistoryBtn.addEventListener("click", function(){
        if(confirm("Are you sure you want to clear all history records?")){
          historyData = [];
          saveLS(LS_KEYS.history, historyData);
          currentHistoryPage = 0;
          renderHistory();
        }
      });

      // Language update
      function updateLanguage() {
        currentLang = langSelect.value;
        const t = translations[currentLang] || translations["zh-TW"];
        document.querySelector("#calculator .module h2").textContent = t.calculator.title;
        document.querySelector("#common .module h2").textContent = t.common.title;
        document.querySelector("#chartSection .module h2").textContent = t.chart.title;
        document.querySelector("#history .module h2").textContent = t.history.title;
        document.getElementById("btnR2C").textContent = t.calculator.modeR2C;
        document.getElementById("btnC2R").textContent = t.calculator.modeC2R;
        document.querySelector("#calculator label[for='inputValue']").textContent = t.calculator.inputLabel;
        document.getElementById("calcBtn").textContent = t.calculator.calcBtn;
        document.getElementById("processBtn").textContent = t.calculator.processBtn;
        document.querySelector("#chartSection label[for='chartType']").textContent = t.chart.chartTypeLabel;
        chartTypeSelect.options[0].text = t.chart.optionLine;
        chartTypeSelect.options[1].text = t.chart.optionBar;
        document.getElementById("annotationsLabel").textContent = t.chart.showAnnotationsLabel;
        document.getElementById("pointsLabel").textContent = t.chart.showPointsLabel;
        document.getElementById("gridLabel").textContent = t.chart.showGridLabel;
        document.getElementById("clearHistory").textContent = t.history.clearHistory;
        let r2cHeaders = document.querySelectorAll("#r2cTable thead tr th");
        r2cHeaders[0].textContent = t.tables.r2c.header1;
        r2cHeaders[1].textContent = t.tables.r2c.header2;
        let c2rHeaders = document.querySelectorAll("#c2rTable thead tr th");
        c2rHeaders[0].textContent = t.tables.c2r.header1;
        c2rHeaders[1].textContent = t.tables.c2r.header2;
        let historyHeaders = document.querySelectorAll("#historyTable thead tr th");
        historyHeaders[0].textContent = t.tables.history.header1;
        historyHeaders[1].textContent = t.tables.history.header2;
        historyHeaders[2].textContent = t.tables.history.header3;
        historyHeaders[3].textContent = t.tables.history.header4;
        document.getElementById("menuCalculator").textContent = t.nav.calculator;
        document.getElementById("menuCommon").textContent = t.nav.common;
        document.getElementById("menuChartSection").textContent = t.nav.chartSection;
        document.getElementById("menuHistory").textContent = t.nav.history;
        siteTitleSub.textContent = t.siteTitleSub;
        document.getElementById("hiddenCredits").textContent = t.credits;
        renderToggleBtn();
        renderHistory();
        generateChart();
        // Update dynamic content
        if (inputValueElem.value.trim() !== "") {
          updateResult();
        } else {
          resultDiv.innerText = "→ ";
          resultDiv.classList.remove("visible");
        }
      }
      langSelect.addEventListener("change", updateLanguage);

      // Initial setup
      populateTables();
      generateChart();
      initPreferences();

      // Update chart axis color
      function updateChartAxisColor(){
        if(myChart){
          myChart.options.scales.x.ticks.color = body.classList.contains("dark") ? "#fff" : "#333";
          myChart.options.scales.y.ticks.color = body.classList.contains("dark") ? "#fff" : "#333";
          myChart.update();
        }
      }

      // Easter egg
      function triggerEasterEgg() {
        eggClickCount++;
        if(eggTimeout) clearTimeout(eggTimeout);
        eggTimeout = setTimeout(() => { eggClickCount = 0; easterEggText.textContent = ""; }, 5000);
        const floatEmoji = document.createElement("span");
        floatEmoji.textContent = "🤔";
        floatEmoji.style.position = "fixed";
        floatEmoji.style.zIndex = "9999";
        floatEmoji.style.left = (Math.random() * 80 + 10) + "%";
        floatEmoji.style.bottom = "0px";
        floatEmoji.style.fontSize = "2.5rem";
        floatEmoji.style.opacity = "1";
        floatEmoji.style.pointerEvents = "none";
        floatEmoji.style.transition = "transform 3s ease-out, opacity 3s ease-out";
        document.body.appendChild(floatEmoji);
        setTimeout(() => {
          floatEmoji.style.transform = "translateY(-120vh) rotate(" + (Math.random()*20-10) + "deg) scale(2)";
          floatEmoji.style.opacity = "0";
        }, 50);
        setTimeout(() => { floatEmoji.remove(); }, 3050);
        const tEgg = translations[currentLang].easterEgg;
        switch(eggClickCount){
          case 1: easterEggText.textContent = tEgg.click1; break;
          case 3: easterEggText.textContent = tEgg.click3; break;
          case 5: easterEggText.textContent = tEgg.click5; break;
          case 7: easterEggText.textContent = tEgg.click7; break;
          case 10: easterEggText.textContent = tEgg.click10; break;
          case 15: easterEggText.textContent = tEgg.click15; break;
          case 25: easterEggText.textContent = tEgg.click25; break;
          case 35: easterEggText.textContent = tEgg.click35; break;
          case 45: easterEggText.textContent = tEgg.click45; break;
          case 60: easterEggText.textContent = tEgg.click60; break;
          default: if(eggClickCount >= 80) easterEggText.textContent = tEgg.click80; break;
        }
      }
      siteTitleContainer.addEventListener("click", triggerEasterEgg);

      // Load animation
      window.addEventListener("load", function(){
        sideMenu.classList.remove("collapsed");
        setTimeout(() => {
          sideMenu.classList.add("collapsed");
          sideMenuToggle.style.left = "0px";
        }, 2000);
        for(let i = 0; i < 20; i++){
          setTimeout(() => {
            let emoji = document.createElement("span");
            emoji.textContent = "🤔";
            emoji.style.position = "fixed";
            emoji.style.bottom = "0px";
            emoji.style.left = (Math.random() * 80 + 10) + "%";
            emoji.style.fontSize = "2rem";
            emoji.style.opacity = "1";
            emoji.style.pointerEvents = "none";
            emoji.style.zIndex = "9999";
            emoji.style.transition = "transform 2s ease-out, opacity 2s ease-out";
            document.body.appendChild(emoji);
            requestAnimationFrame(() => {
              emoji.style.transform = "translateY(-100vh) scale(1.5)";
              emoji.style.opacity = "0";
            });
            setTimeout(() => { emoji.remove(); }, 2100);
          }, i * 100);
        }
      });
    })();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Card / Wave Converter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
      line-height: 1.6;
    }
    @media (min-width: 769px) { body { overflow-y: hidden; } }
    :root {
      --bg-color: #f0f4f8;
      --text-color: #333;
      --container-bg: #fff;
      --primary-color: #3498db;
      --primary-active: #2980b9;
      --table-border: #ddd;
      --shadow-light: rgba(0,0,0,0.1);
      --shadow-dark: rgba(0,0,0,0.2);
      --button-shadow: 0 3px 6px rgba(0,0,0,0.15);
      --bg-gradient-light: linear-gradient(-45deg, #f0f4f8, #d9e2ec, #c8d7e1, #b0c7d6);
      --bg-pattern-light: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="1" fill="#ccc"/></svg>');
    }
    .dark {
      --bg-color: #1a1a1a;
      --text-color: #ddd;
      --container-bg: #242424;
      --primary-color: #3498db;
      --primary-active: #2980b9;
      --table-border: #666;
      --shadow-light: rgba(0,0,0,0.3);
      --shadow-dark: rgba(0,0,0,0.5);
      --button-shadow: 0 5px 10px rgba(0,0,0,0.3);
      --bg-gradient-dark: linear-gradient(-45deg, #1a1a1a, #242424, #2e2e2e, #383838);
      --bg-pattern-dark: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="1" fill="#444"/></svg>');
    }
    body {
      background: var(--bg-gradient-light), var(--bg-pattern-light);
      background-size: 200% 200%, 20px 20px;
      animation: bgShift 15s ease infinite;
      color: var(--text-color);
      font-size: 16px;
      transition: background 1s ease, color 1s ease;
    }
    body.dark {
      background: var(--bg-gradient-dark), var(--bg-pattern-dark);
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    ::-webkit-scrollbar {
      width: 12px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 6px;
    }
    ::-webkit-scrollbar-track {
      background: var(--container-bg);
    }
    section {
      min-height: 100vh;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .module {
      background: var(--container-bg);
      border-radius: 1rem;
      box-shadow: 0 10px 20px var(--shadow-light), 0 -10px 20px var(--shadow-light);
      border: 1px solid var(--primary-color);
      padding: 2.5rem;
      margin: 1rem auto;
      width: 90%;
      max-width: 60rem;
      transition: box-shadow 0.3s;
    }
    .module:hover {
      box-shadow: 0 15px 30px var(--shadow-dark), 0 -15px 30px var(--shadow-dark);
    }
    .module h2 {
      text-align: center;
      margin-bottom: 2rem;
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-shadow: 0 2px 4px var(--shadow-light);
    }
    body.dark .module h2 { text-shadow: 0 2px 4px var(--shadow-dark); }
    .mode-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .mode-toggles {
      display: flex;
      gap: 0.75rem;
      flex-wrap: nowrap;
    }
    .mode-toggle {
      padding: 0.5rem 1rem;
      border: 2px solid var(--primary-color);
      border-radius: 0.75rem;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      background: transparent;
      transition: background 0.3s ease, color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      color: var(--primary-color);
      user-select: none;
      min-width: 44px;
      min-height: 44px;
    }
    .mode-toggle.active {
      background: var(--primary-active);
      color: #fff;
    }
    .mode-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--primary-color);
    }
    .mode-toggle:active { transform: scale(0.95); }
    .table-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin-top: 2rem;
    }
    .table-box {
      flex: 1 1 45%;
      max-width: 45%;
      margin-bottom: 1.5rem;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .table-responsive {
      width: 100%;
      border-radius: 0.75rem;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: center;
      border-bottom: 1px solid var(--table-border);
      font-size: 1rem;
      word-wrap: break-word;
    }
    th {
      background: var(--primary-color);
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
    }
    td { font-weight: 400; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    body.dark table th { background: var(--primary-color); color: #fff; }
    body.dark table td { color: #ddd; border-bottom-color: var(--table-border); }
    body.dark tr:nth-child(even) { background-color: #2a2a2a; }
    .result table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .result td {
      padding: 0.5rem;
      text-align: center;
      border-bottom: 1px solid var(--table-border);
      white-space: normal;
      word-break: break-word;
    }
    .result tr:nth-child(even) { background: #f2f2f2; }
    body.dark .result tr:nth-child(even) { background: #2a2a2a; }
    #sideMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 240px;
      height: 100%;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      border-radius: 0 1rem 1rem 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      z-index: 1300;
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transform: translateX(0);
      opacity: 1;
    }
    #sideMenu.collapsed {
      transform: translateX(-100%);
      opacity: 0;
    }
    body.dark #sideMenu { background: rgba(34,34,34,0.8); }
    #sideMenu a {
      color: #333;
      text-decoration: none;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      transition: transform 0.3s ease, background 0.3s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    body.dark #sideMenu a { color: #ddd; }
    #sideMenu a.active, #sideMenu a:hover {
      background: #3498db;
      color: #fff;
      transform: scale(1.05);
    }
    #siteTitleContainer {
      text-align: center;
      margin-bottom: 1rem;
      user-select: none;
      cursor: pointer;
    }
    #siteTitleContainer:hover { transform: scale(1.02); }
    #siteTitleContainer h1 {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    #siteTitleSub, #easterEggText {
      display: block;
      margin-top: 0.25rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary-color);
    }
    body.dark select, body.dark input[type="text"] {
      background: #333;
      color: #fff;
      border-color: #555;
      border-radius: 0.5rem;
    }
    body.dark select option {
      background: #333;
      color: #fff;
    }
    body.dark .result { background: #333; color: #fff; }
    .result.error { color: red; }
    #sideMenuToggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      color: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 1400;
      transition: left 0.3s ease, transform 0.3s ease;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #settingsToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      color: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 1500;
      transition: transform 0.3s ease;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #settingsToggle.rotate {
      transform: rotate(180deg);
    }
    #navTop {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      color: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #navTop:hover {
      transform: scale(1.1);
    }
    body.dark #sideMenuToggle, body.dark #settingsToggle, body.dark #navTop {
      background: rgba(34,34,34,0.7);
      color: #ddd;
    }
    #sideMenuToggle:hover, #settingsToggle:hover, #navTop:hover {
      transform: scale(1.1);
    }
    @media (min-width: 769px) {
      #sideMenuToggle.moved { left: 250px; }
    }
    @media (max-width: 768px) {
      .table-container {
        flex-direction: column;
        align-items: center;
      }
      .table-box {
        flex: 1 1 100%;
        max-width: 100%;
      }
      .copyBtn {
        position: relative;
        margin-top: 0.5rem;
      }
      .mode-toggles {
        flex-wrap: wrap;
        justify-content: center;
      }
      .mode-toggle {
        min-width: 120px;
        margin: 0.25rem;
        padding: 0.5rem;
      }
      #processBtn {
        padding: 0.5rem;
        min-width: 44px;
      }
    }
    #processBtn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      width: 2rem;
      height: 2rem;
      font-size: 1.2rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
      user-select: none;
      margin-left: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    #processBtn:hover {
      background: var(--primary-active);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #processBtn:active { transform: scale(0.98); }
    #processInfo {
      max-height: 0;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(-10px);
      transition: max-height 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      margin-top: 0.5rem;
      padding: 0 0.5rem;
      background: #fff;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      white-space: pre-wrap;
      font-family: monospace;
      line-height: 1.5;
      position: relative;
      z-index: 500;
      color: #000;
      border: 2px solid var(--table-border);
    }
    body.dark #processInfo { background: #333; color: #fff; }
    #processInfo.visible {
      max-height: 15rem;
      opacity: 1;
      transform: translateY(0);
      padding: 0.5rem;
    }
    .result {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #fff;
      border-radius: 0.75rem;
      text-align: left;
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-height: 10rem;
      overflow-y: auto;
      overflow-x: auto;
    }
    .result.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .copyBtn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.3s ease;
      min-width: 44px;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    .copyBtn:hover {
      background: var(--primary-active);
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .chart-container {
      position: relative;
      height: 30rem;
      width: 100%;
      margin: 0 auto;
      background: #f9f9f9;
      border-radius: 1rem;
    }
    body.dark .chart-container { background: #1e1e1e; }
    #chartControls {
      text-align: center;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
      flex-wrap: wrap;
    }
    #chartControls label { font-size: 0.9rem; color: var(--text-color); cursor: pointer; }
    .chart-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      background: var(--container-bg);
      padding: 0.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px var(--shadow-light);
    }
    #footer {
      position: fixed;
      bottom: -50px;
      left: 0;
      width: 100%;
      height: 50px;
      background: #808080;
      color: #fff;
      text-align: center;
      padding: 0.75rem;
      box-shadow: 0 -0.25rem 0.75rem rgba(0,0,0,0.3);
      border-radius: 1rem 1rem 0 0;
      z-index: 500;
      font-size: 0.9rem;
      transition: bottom 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #pageNav {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1200;
    }
    button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      margin: 0.5rem 0;
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
      user-select: none;
      min-width: 44px;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover {
      background: var(--primary-active);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    button:active { transform: scale(0.98); }
    button.loading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    #calcBtn:hover {
      box-shadow: 0 0 10px var(--primary-color);
    }
    input[type="text"], select {
      padding: 0.5rem;
      border: 2px solid var(--primary-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem 0;
      transition: border-color 0.3s, box-shadow 0.3s;
      background: #fff;
      color: #333;
      width: 100px;
    }
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: var(--primary-active);
      box-shadow: 0 0 5px rgba(52,152,219,0.5);
    }
    #historyTable { font-size: 0.9rem; }
    #historyTable tbody tr {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #historyTable tbody tr.visible {
      opacity: 1;
      transform: translateY(0);
    }
    #historyTable td {
      white-space: normal;
      word-break: break-word;
      padding: 0.75rem 0.5rem;
    }
    #historyPagination {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: nowrap;
      margin-top: 1rem;
      white-space: nowrap;
      overflow-x: auto;
    }
    #historyPagination button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    #historyPagination button:hover {
      background: var(--primary-active);
    }
    #historyPagination button .icon {
      display: none;
    }
    @media (max-width: 768px) {
      #historyPagination button .text {
        display: none;
      }
      #historyPagination button .icon {
        display: inline;
      }
      #historyPagination button {
        padding: 0.5rem;
        min-width: 44px;
        font-size: 1.2rem;
      }
    }
    #clearInput {
      display: none;
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      font-size: 0.9rem;
      user-select: none;
    }
    .subtle-btn {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s, color 0.3s, transform 0.2s, box-shadow 0.3s;
    }
    .subtle-btn:hover {
      background: var(--primary-color);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    @keyframes deleteAnimation {
      0% { opacity: 1; transform: scale(1); color: inherit; }
      50% { opacity: 0.5; transform: scale(1.2); color: red; }
      100% { opacity: 0; transform: scale(0.5); color: red; }
    }
    .delete-anim {
      animation: deleteAnimation 0.3s ease forwards;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .card-container {
      position: relative;
      cursor: pointer;
      padding: 0.2rem;
      display: inline-block;
    }
    .reward-symbol {
      font-size: 0.8em;
      vertical-align: super;
      cursor: pointer;
      margin-left: 2px;
    }
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1900;
    }
    #rewardModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
      width: 300px;
    }
    body.dark #rewardModal {
      background: rgba(34,34,34,0.8);
      color: #ddd;
    }
    #rewardModal.visible {
      opacity: 1;
    }
    #rewardModal .content {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #rewardModal h3 {
      margin: 0;
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: var(--primary-color);
    }
    #rewardModal select {
      width: auto;
      max-width: 200px;
    }
    #rewardDetails dl {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    #rewardDetails dt {
      font-weight: bold;
      text-align: right;
    }
    #rewardDetails dd {
      margin: 0;
      text-align: left;
    }
    #settingsPopup {
      position: fixed;
      top: 50px;
      right: 10px;
      background: var(--container-bg);
      border: 1px solid var(--primary-color);
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 4px 8px var(--shadow-light);
      z-index: 1600;
      width: 250px;
      color: var(--text-color);
      visibility: hidden;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.3s;
      pointer-events: none;
      background-image: linear-gradient(135deg, rgba(52,152,219,0.1), rgba(41,128,185,0.1));
    }
    #settingsPopup.visible {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0s;
      pointer-events: auto;
    }
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .settings-item label {
      margin-right: 1rem;
      font-size: 0.9rem;
      color: var(--text-color);
      white-space: nowrap;
    }
    #settingsPopup select, #settingsPopup button {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--primary-color);
      border-radius: 0.25rem;
      background: var(--container-bg);
      color: var(--text-color);
    }
    #settingsPopup button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    #settingsPopup button:hover {
      background: var(--primary-active);
    }
    @media (max-width: 768px) {
      body { font-size: 14px; }
      .module {
        padding: 1.5rem;
        width: 95%;
      }
      .mode-container {
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
      .mode-toggles {
        flex-wrap: wrap;
        justify-content: center;
      }
      .mode-toggle {
        flex: 1 1 auto;
        min-width: 100px;
        margin: 0.25rem;
        padding: 0.5rem 1rem;
      }
      #processBtn {
        margin-left: 0;
        margin-top: 0.5rem;
      }
      #calculator > div[style] {
        flex-direction: column;
        align-items: stretch;
      }
      #inputValue {
        width: 100%;
      }
      .copyBtn {
        width: 100%;
        margin-top: 0.5rem;
      }
      .module h2 { font-size: 1.5rem; }
      .table-box {
        flex: 1 1 100%;
        max-width: 100%;
      }
      .chart-container { height: 40rem; }
      #historyTable { font-size: 0.8rem; }
      .result table td { white-space: normal; word-break: break-word; }
      button { width: 100%; margin: 0.5rem 0; }
      input[type="text"] { font-size: 0.9rem; }
      #sideMenu {
        width: 100%;
        height: auto;
        top: auto;
        bottom: 0;
        left: 0;
        transform: translateY(0);
        border-radius: 1rem 1rem 0 0;
      }
      #sideMenu.collapsed {
        transform: translateY(100%);
      }
      #sideMenuToggle {
        top: 10px;
        left: 10px;
        right: auto;
        bottom: auto;
      }
      #dotNav {
        display: none;
      }
    }
    @media (max-width: 768px) {
      #historyTable thead {
        display: none;
      }
      #historyTable tr {
        display: block;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--table-border);
      }
      #historyTable td {
        display: block;
        text-align: left;
        padding: 0.25rem 0;
        font-size: 0.9rem;
      }
      #historyTable td::before {
        content: attr(data-label);
        font-weight: bold;
        margin-right: 0.5rem;
      }
    }
    @media (prefers-reduced-motion: reduce), (body.reduce-motion *) {
      * { transition: none !important; animation: none !important; }
    }
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-color);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 2000;
    }
    .notification.visible {
      opacity: 1;
    }
    .easter-egg {
      position: fixed;
      font-size: 2rem;
      opacity: 0;
      transition: opacity 0.5s ease, transform 1s ease;
      z-index: 1000;
    }
    .easter-egg.visible {
      opacity: 1;
      transform: translateY(-100vh);
    }
    .dot-nav {
      position: fixed;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 1rem;
      z-index: 1200;
    }
    @media (min-width: 769px) {
      .dot-nav { display: flex; }
    }
    .dot {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.3s ease, background 0.3s ease, border 0.3s ease;
    }
    .dot:hover {
      transform: scale(1.2);
    }
    .dot.active {
      transform: scale(1.5);
      background: transparent;
      border: 2px solid var(--primary-color);
    }
    #reduceMotion {
      appearance: none;
      width: 40px;
      height: 20px;
      background: #ccc;
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    #reduceMotion::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    #reduceMotion:checked {
      background: var(--primary-color);
    }
    #reduceMotion:checked::after {
      transform: translateX(20px);
    }
    .loader {
      font-size: 2rem;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <button id="sideMenuToggle" title="Toggle Menu" aria-label="Toggle Side Menu">â˜°</button>
  <button id="settingsToggle" title="Settings" aria-label="Settings">âš™ï¸</button>
  <div id="sideMenu" class="collapsed">
    <div id="siteTitleContainer">
      <h1 id="siteTitle">Random Dice Defense : PvP</h1>
      <span id="siteTitleSub"></span>
      <span id="easterEggText"></span>
    </div>
    <a href="#calculator" id="menuCalculator" data-target="calculator"></a>
    <a href="#common" id="menuCommon" data-target="common"></a>
    <a href="#chartSection" id="menuChartSection" data-target="chartSection"></a>
    <a href="#history" id="menuHistory" data-target="history"></a>
  </div>
  <div id="settingsPopup">
    <div class="settings-item">
      <label for="langSelect">ğŸŒ [L] Language</label>
      <select id="langSelect" aria-label="Select Language">
        <option value="auto">Auto-Detect</option>
        <option value="zh-TW">ç¹ä¸­ (zh-TW)</option>
        <option value="zh-CN">ç®€ä¸­ (zh-CN)</option>
        <option value="en">English (en)</option>
        <option value="ja">æ—¥æœ¬èª (ja)</option>
        <option value="ko">í•œêµ­ì–´ (ko)</option>
      </select>
    </div>
    <div class="settings-item">
      <label for="themeSelect">ğŸ¨ [T] Theme</label>
      <select id="themeSelect" aria-label="Select Theme">
        <option value="system">System Default</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
    <div class="settings-item">
      <label for="reduceMotion">Reduce Animation</label>
      <input type="checkbox" id="reduceMotion" />
    </div>
    <button id="clearHistory">Clear History</button>
  </div>
  <div id="pageNav">
    <button id="navTop">â¥”</button>
  </div>
  <div id="dotNav" class="dot-nav">
    <span class="dot" data-section="calculator"></span>
    <span class="dot" data-section="common"></span>
    <span class="dot" data-section="chartSection"></span>
    <span class="dot" data-section="history"></span>
  </div>
  <section id="calculator">
    <div class="module">
      <h2></h2>
      <div class="mode-container">
        <div class="mode-toggles">
          <button class="mode-toggle active" id="btnW2C"></button>
          <button class="mode-toggle" id="btnC2W"></button>
        </div>
        <button id="processBtn" aria-label="Show Conversion Process">?</button>
      </div>
      <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; width: 100%;">
        <label for="inputValue"></label>
        <div style="position: relative; flex: 1; min-width: 200px;">
          <input type="text" id="inputValue" style="width: 100%; padding-right: 4rem;">
          <span id="clearInput" style="display: none;"></span>
        </div>
        <button id="calcBtn" class="subtle-btn" aria-label="Calculate"></button>
      </div>
      <div class="result" id="result">â†’ </div>
      <div id="processInfo"></div>
    </div>
  </section>
  <section id="common">
    <div class="module">
      <h2></h2>
      <div class="table-container">
        <div class="table-box">
          <h3></h3>
          <div class="table-responsive">
            <table id="w2cTable">
              <thead><tr><th></th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="table-box">
          <h3></h3>
          <div class="table-responsive">
            <table id="c2wTable">
              <thead><tr><th></th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section id="chartSection">
    <div class="module">
      <h2></h2>
      <div style="text-align: center; margin-bottom: 1rem;">
        <label for="chartType"></label>
        <select id="chartType" style="font-size: 0.9rem; padding: 0.25rem;">
          <option value="line"></option>
          <option value="bar"></option>
        </select>
      </div>
      <div id="chartControls" class="chart-controls">
        <label><input type="checkbox" id="toggleAnnotations" checked><span id="annotationsLabel"></span></label>
        <label><input type="checkbox" id="togglePoints" checked><span id="pointsLabel"></span></label>
        <label><input type="checkbox" id="toggleGrid" checked><span id="gridLabel"></span></label>
      </div>
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>
  <section id="history">
    <div class="module">
      <h2></h2>
      <div class="table-responsive">
        <table id="historyTable">
          <thead><tr><th></th><th></th><th></th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="historyPagination" style="text-align: center; margin-top: 1rem;"></div>
    </div>
  </section>
  <div id="modalOverlay"></div>
  <div id="rewardModal">
    <div class="content">
      <h3></h3>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label for="rankSelect"></label>
        <select id="rankSelect"></select>
      </div>
      <div id="rewardDetails" class="reward-details"></div>
    </div>
  </div>
  <div id="footer"></div>
  <div id="notification" class="notification"></div>
  <script>
    (function(){
      "use strict";
      const LS_KEYS = {
        darkMode: "converter_darkMode",
        lastInput: "converter_lastInput",
        mode: "converter_mode",
        history: "converter_history",
        language: "converter_language",
        theme: "converter_theme",
        reduceMotion: "converter_reduceMotion",
        lastRank: "converter_lastRank"
      };
      const CONFIG = {
        baseThreshold: 45,
        baseArray: [0,1,2,4,5],
        extraRanges: [
          {a: 46, b: 111, f: 1},
          {a: 112, b: 500, f: 2},
          {a: 501, b: 1000, f: 3},
          {a: 1001, b: 1500, f: 4},
          {a: 1501, b: Infinity, f: 5}
        ],
        chart: { maxWaves: 1600, step: 50 }
      };
      const REWARDS = {
        1: { common: 14, rare: 4, hero: 2, legendary: 0.01, gold: 320, diamonds: 3 },
        2: { common: 20, rare: 5, hero: 2, legendary: 0.01, gold: 432, diamonds: 3 },
        3: { common: 25, rare: 6, hero: 3, legendary: 0.01, gold: 544, diamonds: 3 },
        4: { common: 28, rare: 8, hero: 4, legendary: 0.01, gold: 640, diamonds: 3 },
        5: { common: 33, rare: 9, hero: 4, legendary: 0.01, gold: 736, diamonds: 3 },
        6: { common: 37, rare: 10, hero: 5, legendary: 0.01, gold: 832, diamonds: 3 },
        7: { common: 42, rare: 11, hero: 5, legendary: 0.01, gold: 925, diamonds: 3 },
        8: { common: 46, rare: 12, hero: 6, legendary: 0.01, gold: 1024, diamonds: 3 },
        9: { common: 49, rare: 14, hero: 7, legendary: 0.01, gold: 1120, diamonds: 3 },
        10: { common: 54, rare: 15, hero: 7, legendary: 0.01, gold: 1312, diamonds: 3 },
        11: { common: 63, rare: 17, hero: 8, legendary: 0.01, gold: 1408, diamonds: 3 },
        12: { common: 67, rare: 18, hero: 9, legendary: 0.01, gold: 1504, diamonds: 3 },
        13: { common: 71, rare: 19, hero: 9, legendary: 0.01, gold: 1594, diamonds: 3 },
        14: { common: 77, rare: 20, hero: 10, legendary: 0.01, gold: 1687, diamonds: 3 },
        15: { common: 82, rare: 21, hero: 10, legendary: 0.01, gold: 1775, diamonds: 3 },
        16: { common: 87, rare: 22, hero: 11, legendary: 0.01, gold: 1866, diamonds: 3 },
        17: { common: 92, rare: 23, hero: 11, legendary: 0.01, gold: 1951, diamonds: 3 },
        18: { common: 99, rare: 24, hero: 12, legendary: 0.01, gold: 2044, diamonds: 3 },
        19: { common: 105, rare: 25, hero: 12, legendary: 0.01, gold: 2133, diamonds: 3 },
        20: { common: 111, rare: 26, hero: 13, legendary: 0.01, gold: 2222, diamonds: 3 }
      };

      let currentLang = loadLS(LS_KEYS.language, "auto");
      let theme = loadLS(LS_KEYS.theme, "system");
      let reduceMotion = loadLS(LS_KEYS.reduceMotion, false);
      let lastRank = loadLS(LS_KEYS.lastRank, "20");
      let currentCards = 0;
      const translations = {
        "zh-TW": {
          clear: "æ¸…é™¤",
          nav: { toggleMenu: "åˆ‡æ›èœå–®", calculator: "æ›ç®—å™¨", common: "å¸¸ç”¨æ›ç®—", chartSection: "é—œä¿‚åœ–", history: "æ­·å²è¨˜éŒ„" },
          calculator: { title: "å¡ç‰‡æ•¸ / å›åˆæ•¸ æ›ç®—å™¨", modeW2C: "å›åˆ â†’ å¡ç‰‡", modeC2W: "å¡ç‰‡ â†’ å›åˆ", inputLabel: "è¼¸å…¥æ•¸å­—ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼Œæœ€å¤š5å€‹å€¼ï¼‰ï¼š", calcBtn: "è¨ˆç®—", processBtn: "æ›ç®—éç¨‹", invalidInput: "è«‹è¼¸å…¥æœ‰æ•ˆä¸”å¤§æ–¼ 0 çš„æ•¸å€¼", copyText: "è¤‡è£½", placeholder: "ä¾‹å¦‚ï¼š100,200,300", maxValues: "æœ€å¤šå¯è¼¸å…¥ 5 å€‹æ•¸å€¼" },
          common: { title: "å¸¸ç”¨æ›ç®—", w2c: "å›åˆ â†’ å¡ç‰‡", c2w: "å¡ç‰‡ â†’ å›åˆ" },
          chart: { title: "å¡æ•¸ - å›åˆæ•¸ é—œä¿‚åœ–", chartTypeLabel: "åœ–è¡¨é¡å‹ï¼š", optionLine: "æŠ˜ç·šåœ–", optionBar: "æŸ±ç‹€åœ–", xAxis: "å›åˆæ•¸", yAxis: "å¡ç‰‡æ•¸", showAnnotationsLabel: "é¡¯ç¤ºæ¨™è¨»ç·š", showPointsLabel: "é¡¯ç¤ºè³‡æ–™é»", showGridLabel: "é¡¯ç¤ºç¶²æ ¼ç·š", waveSuffix: "å›åˆ" },
          history: { title: "æ›ç®—æ­·å²è¨˜éŒ„", clearHistory: "æ¸…é™¤æ­·å²", noRecord: "ç„¡æ­·å²è¨˜éŒ„" },
          process: { w2cTitle: "ã€å›åˆ â†’ å¡ç‰‡ã€‘", w2cBase: "å‰45å›åˆï¼šæ¯5å›åˆå¾—8å¡ï¼Œé¤˜æ•¸åŠ æˆ {lookup} å¡ï¼Œç¸½è¨ˆ {subtotal} å¡ã€‚", w2cExtra: "è¶…å‡º45å›åˆï¼šç¯„åœ {a}-{b}ï¼ˆå€ç‡ {f}ï¼‰ï¼š{extra} å¡ã€‚", w2cTotal: "ç¸½å¡ç‰‡æ•¸ï¼š{subtotal} + {extraTotal} = {result}", c2wTitle: "ã€å¡ç‰‡ â†’ å›åˆã€‘", c2wDesc: "ä½¿ç”¨äºŒåˆ†æœå°‹æ‰¾åˆ°æœ€å°å›åˆæ•¸ï¼šç¯„åœ {low}-{high}ï¼Œæœ€çµ‚ {result} å›åˆã€‚" },
          tables: { w2c: { header1: "å›åˆæ•¸", header2: "å¡ç‰‡æ•¸" }, c2w: { header1: "å¡ç‰‡æ•¸", header2: "å›åˆæ•¸" }, history: { header1: "æ™‚é–“", header2: "æ¨¡å¼", header3: "è¼¸å…¥å€¼", header4: "çµæœ" } },
          units: { waves: "å›åˆ", cards: "å¡ç‰‡" },
          pagination: { prev: "ä¸Šä¸€é ", next: "ä¸‹ä¸€é ", pageInfo: "ç¬¬ {current} é  / å…± {total} é " },
          footer: "Â© 2025 ğ•«ğ•™ğ•šğ•ğ•š (Discord@zhili_71)",
          darkMode: { light: "ç™½å¤©æ¨¡å¼", dark: "é»‘å¤œæ¨¡å¼", system: "ç³»çµ±é è¨­" },
          language: "èªè¨€",
          siteTitleSub: "å”åŒæ¨¡å¼å¡ç‰‡è¨ˆç®—å™¨",
          backToTop: "å›åˆ°é ‚éƒ¨",
          easterEgg: { click1: "ThinkingğŸ¤”", click3: "é›™å€ ThinkingğŸ¤”", click5: "ä¸‰å€ ThinkingğŸ¤”ï¼", click7: "ä¸»å®°ä¸€åˆ‡ï¼", click10: "ç‹‚æš´æ”»æ“Šï¼ï¼", click15: "çµ‚æ¥µ ThinkingğŸ¤”ï¼ï¼", click25: "ç„¡äººèƒ½æ“‹ï¼ï¼", click35: "è®Šæ…‹æ®ºæˆ®ï¼ï¼", click45: "çŒ›ç¸ç´š ThinkingğŸ¤”ï¼ï¼ï¼", click60: "è¶…ç¥çš„ï¼ï¼ï¼ï¼", click80: "æ¯”ç¥é‚„ç¥ï¼ï¼ï¼ï¼" },
          copied: "å·²è¤‡è£½",
          settings: { title: "è¨­ç½®", language: "èªè¨€", theme: "ä¸»é¡Œ", reduceMotion: "æ¸›å°‘å‹•ç•«", clearHistory: "æ¸…é™¤æ­·å²è¨˜éŒ„" },
          autoSelectLanguage: "è‡ªå‹•é¸æ“‡èªè¨€",
          reward: { title: "çå‹µè¨ˆç®—", selectRank: "é¸æ“‡éŠæˆ²å…§æ®µä½", boxes: "ç®±å­", commonDice: "æ™®é€šéª°å­", rareDice: "ç¨€æœ‰éª°å­", heroDice: "è‹±é›„éª°å­", legendaryDice: "å‚³èªªéª°å­", gold: "é‡‘å¹£", diamonds: "é‘½çŸ³", expected: "ï¼ˆé æœŸï¼‰" }
        },
        "zh-CN": {
          clear: "æ¸…é™¤",
          nav: { toggleMenu: "åˆ‡æ¢èœå•", calculator: "è½¬æ¢å™¨", common: "å¸¸ç”¨è½¬æ¢", chartSection: "å…³ç³»å›¾", history: "å†å²è®°å½•" },
          calculator: { title: "å¡ç‰‡æ•° / å›åˆæ•° è½¬æ¢å™¨", modeW2C: "å›åˆ â†’ å¡ç‰‡", modeC2W: "å¡ç‰‡ â†’ å›åˆ", inputLabel: "è¾“å…¥æ•°å­—ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œæœ€å¤š5ä¸ªå€¼ï¼‰ï¼š", calcBtn: "è®¡ç®—", processBtn: "è½¬æ¢è¿‡ç¨‹", invalidInput: "è¯·è¾“å…¥æœ‰æ•ˆä¸”å¤§äº 0 çš„æ•°å€¼", copyText: "å¤åˆ¶", placeholder: "ä¾‹å¦‚ï¼š100,200,300", maxValues: "æœ€å¤šå¯è¾“å…¥ 5 ä¸ªæ•°å€¼" },
          common: { title: "å¸¸ç”¨è½¬æ¢", w2c: "å›åˆ â†’ å¡ç‰‡", c2w: "å¡ç‰‡ â†’ å›åˆ" },
          chart: { title: "å¡æ•° - å›åˆæ•° å…³ç³»å›¾", chartTypeLabel: "å›¾è¡¨ç±»å‹ï¼š", optionLine: "æŠ˜çº¿å›¾", optionBar: "æŸ±çŠ¶å›¾", xAxis: "å›åˆæ•°", yAxis: "å¡ç‰‡æ•°", showAnnotationsLabel: "æ˜¾ç¤ºæ ‡æ³¨çº¿", showPointsLabel: "æ˜¾ç¤ºæ•°æ®ç‚¹", showGridLabel: "æ˜¾ç¤ºç½‘æ ¼çº¿", waveSuffix: "å›åˆ" },
          history: { title: "è½¬æ¢å†å²è®°å½•", clearHistory: "æ¸…é™¤å†å²", noRecord: "æ— å†å²è®°å½•" },
          process: { w2cTitle: "ã€å›åˆ â†’ å¡ç‰‡ã€‘", w2cBase: "å‰45å›åˆï¼šæ¯5å›åˆå¾—8å¡ï¼Œä½™æ•°åŠ æˆ {lookup} å¡ï¼Œæ€»è®¡ {subtotal} å¡ã€‚", w2cExtra: "è¶…å‡º45å›åˆï¼šèŒƒå›´ {a}-{b}ï¼ˆå€ç‡ {f}ï¼‰ï¼š{extra} å¡ã€‚", w2cTotal: "æ€»å¡ç‰‡æ•°ï¼š{subtotal} + {extraTotal} = {result}", c2wTitle: "ã€å¡ç‰‡ â†’ å›åˆã€‘", c2wDesc: "ä½¿ç”¨äºŒåˆ†æœç´¢æ‰¾åˆ°æœ€å°å›åˆæ•°ï¼šèŒƒå›´ {low}-{high}ï¼Œæœ€ç»ˆ {result} å›åˆã€‚" },
          tables: { w2c: { header1: "å›åˆæ•°", header2: "å¡ç‰‡æ•°" }, c2w: { header1: "å¡ç‰‡æ•°", header2: "å›åˆæ•°" }, history: { header1: "æ—¶é—´", header2: "æ¨¡å¼", header3: "è¾“å…¥å€¼", header4: "ç»“æœ" } },
          units: { waves: "å›åˆ", cards: "å¡ç‰‡" },
          pagination: { prev: "ä¸Šä¸€é¡µ", next: "ä¸‹ä¸€é¡µ", pageInfo: "ç¬¬ {current} é¡µ / å…± {total} é¡µ" },
          footer: "Â© 2025 ğ•«ğ•™ğ•šğ•ğ•š (Discord@zhili_71)",
          darkMode: { light: "ç™½å¤©æ¨¡å¼", dark: "é»‘å¤œæ¨¡å¼", system: "ç³»ç»Ÿé»˜è®¤" },
          language: "è¯­è¨€",
          siteTitleSub: "ååŒæ¨¡å¼å¡ç‰‡è®¡ç®—å™¨",
          backToTop: "å›åˆ°é¡¶éƒ¨",
          easterEgg: { click1: "ThinkingğŸ¤”", click3: "åŒå€ ThinkingğŸ¤”", click5: "ä¸‰å€ ThinkingğŸ¤”ï¼", click7: "ä¸»å®°ä¸€åˆ‡ï¼", click10: "ç‹‚æš´æ”»å‡»ï¼ï¼", click15: "ç»ˆæ ThinkingğŸ¤”ï¼ï¼", click25: "æ— äººèƒ½æŒ¡ï¼ï¼", click35: "å˜æ€æ€æˆ®ï¼ï¼", click45: "çŒ›å…½çº§ ThinkingğŸ¤”ï¼ï¼ï¼", click60: "è¶…ç¥çš„ï¼ï¼ï¼ï¼", click80: "æ¯”ç¥è¿˜ç¥ï¼ï¼ï¼ï¼" },
          copied: "å·²å¤åˆ¶",
          settings: { title: "è®¾ç½®", language: "è¯­è¨€", theme: "ä¸»é¢˜", reduceMotion: "å‡å°‘åŠ¨ç”»", clearHistory: "æ¸…é™¤å†å²è®°å½•" },
          autoSelectLanguage: "è‡ªåŠ¨é€‰æ‹©è¯­è¨€",
          reward: { title: "å¥–åŠ±è®¡ç®—", selectRank: "é€‰æ‹©æ¸¸æˆå†…æ®µä½", boxes: "ç®±å­", commonDice: "æ™®é€šéª°å­", rareDice: "ç¨€æœ‰éª°å­", heroDice: "è‹±é›„éª°å­", legendaryDice: "ä¼ è¯´éª°å­", gold: "é‡‘å¸", diamonds: "é’»çŸ³", expected: "ï¼ˆé¢„æœŸï¼‰" }
        },
        "en": {
          clear: "Clear",
          nav: { toggleMenu: "Toggle Menu", calculator: "Converter", common: "Common Conversions", chartSection: "Chart", history: "History" },
          calculator: { title: "Cards / Waves Converter", modeW2C: "Wave â†’ Cards", modeC2W: "Cards â†’ Wave", inputLabel: "Enter numbers (comma-separated, up to 5 values):", calcBtn: "Calculate", processBtn: "Conversion Process", invalidInput: "Please enter valid numbers > 0", copyText: "Copy", placeholder: "e.g., 100,200,300", maxValues: "Maximum of 5 values allowed" },
          common: { title: "Common Conversions", w2c: "Wave â†’ Cards", c2w: "Cards â†’ Wave" },
          chart: { title: "Cards vs. Waves Chart", chartTypeLabel: "Chart Type:", optionLine: "Line Chart", optionBar: "Bar Chart", xAxis: "Wave", yAxis: "Cards", showAnnotationsLabel: "Show Annotations", showPointsLabel: "Show Points", showGridLabel: "Show Grid", waveSuffix: " waves" },
          history: { title: "Conversion History", clearHistory: "Clear History", noRecord: "No history records" },
          process: { w2cTitle: "ã€Wave â†’ Cardsã€‘", w2cBase: "First 45 waves: 8 cards per 5 waves, bonus {lookup} cards, total {subtotal} cards.", w2cExtra: "Beyond 45 waves: Range {a}-{b} (multiplier {f}): {extra} cards.", w2cTotal: "Total cards: {subtotal} + {extraTotal} = {result}", c2wTitle: "ã€Cards â†’ Waveã€‘", c2wDesc: "Binary search for minimum waves: Range {low}-{high}, final {result} waves." },
          tables: { w2c: { header1: "Wave", header2: "Cards" }, c2w: { header1: "Cards", header2: "Wave" }, history: { header1: "Time", header2: "Mode", header3: "Input", header4: "Result" } },
          units: { waves: "waves", cards: "cards" },
          pagination: { prev: "Previous", next: "Next", pageInfo: "Page {current} of {total}" },
          footer: "Â© 2025 ğ•«ğ•™ğ•šğ•ğ•š (@zhili_71 on Discord)",
          darkMode: { light: "Light Mode", dark: "Dark Mode", system: "System Default" },
          language: "Language",
          siteTitleSub: "Co-op Mode Card Calculator",
          backToTop: "Back to Top",
          easterEgg: { click1: "ThinkingğŸ¤”", click3: "Double ThinkingğŸ¤”", click5: "Triple ThinkingğŸ¤”!", click7: "Dominate All!", click10: "Frenzied Attack!!", click15: "Ultimate ThinkingğŸ¤”!!", click25: "Unstoppable!!", click35: "Insane Slaughter!!", click45: "Beast-Level ThinkingğŸ¤”!!!", click60: "Super Divine!!!!", click80: "Beyond God!!!!" },
          copied: "Copied",
          settings: { title: "Settings", language: "Language", theme: "Theme", reduceMotion: "Reduce Motion", clearHistory: "Clear History" },
          autoSelectLanguage: "Auto-select language",
          reward: { title: "Reward Calculation", selectRank: "Select Rank", boxes: "Boxes", commonDice: "Common Dice", rareDice: "Rare Dice", heroDice: "Hero Dice", legendaryDice: "Legendary Dice", gold: "Gold", diamonds: "Diamonds", expected: "(expected)" }
        },
        "ja": {
          clear: "ã‚¯ãƒªã‚¢",
          nav: { toggleMenu: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ", calculator: "ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼", common: "ä¸€èˆ¬çš„ãªå¤‰æ›", chartSection: "ãƒãƒ£ãƒ¼ãƒˆ", history: "å±¥æ­´" },
          calculator: { title: "ã‚«ãƒ¼ãƒ‰æ•° / ã‚¦ã‚§ãƒ¼ãƒ–æ•° ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼", modeW2C: "ã‚¦ã‚§ãƒ¼ãƒ– â†’ ã‚«ãƒ¼ãƒ‰", modeC2W: "ã‚«ãƒ¼ãƒ‰ â†’ ã‚¦ã‚§ãƒ¼ãƒ–", inputLabel: "æ•°å­—ã‚’å…¥åŠ›ï¼ˆã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚Šã€æœ€å¤§5å€¤ï¼‰ï¼š", calcBtn: "è¨ˆç®—", processBtn: "å¤‰æ›ãƒ—ãƒ­ã‚»ã‚¹", invalidInput: "æœ‰åŠ¹ã§0ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", copyText: "ã‚³ãƒ”ãƒ¼", placeholder: "ä¾‹ï¼š100,200,300", maxValues: "æœ€å¤§5ã¤ã®å€¤ã‚’å…¥åŠ›ã§ãã¾ã™" },
          common: { title: "ä¸€èˆ¬çš„ãªå¤‰æ›", w2c: "ã‚¦ã‚§ãƒ¼ãƒ– â†’ ã‚«ãƒ¼ãƒ‰", c2w: "ã‚«ãƒ¼ãƒ‰ â†’ ã‚¦ã‚§ãƒ¼ãƒ–" },
          chart: { title: "ã‚«ãƒ¼ãƒ‰æ•° - ã‚¦ã‚§ãƒ¼ãƒ–æ•° ãƒãƒ£ãƒ¼ãƒˆ", chartTypeLabel: "ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼š", optionLine: "æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•", optionBar: "æ£’ã‚°ãƒ©ãƒ•", xAxis: "ã‚¦ã‚§ãƒ¼ãƒ–æ•°", yAxis: "ã‚«ãƒ¼ãƒ‰æ•°", showAnnotationsLabel: "æ³¨é‡ˆã‚’è¡¨ç¤º", showPointsLabel: "ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º", showGridLabel: "ã‚°ãƒªãƒƒãƒ‰ç·šã‚’è¡¨ç¤º", waveSuffix: "ã‚¦ã‚§ãƒ¼ãƒ–" },
          history: { title: "å¤‰æ›å±¥æ­´", clearHistory: "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢", noRecord: "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“" },
          process: { w2cTitle: "ã€ã‚¦ã‚§ãƒ¼ãƒ– â†’ ã‚«ãƒ¼ãƒ‰ã€‘", w2cBase: "æœ€åˆã®45ã‚¦ã‚§ãƒ¼ãƒ–ï¼š5ã‚¦ã‚§ãƒ¼ãƒ–ã”ã¨ã«8ã‚«ãƒ¼ãƒ‰ã€ãƒœãƒ¼ãƒŠã‚¹ {lookup} ã‚«ãƒ¼ãƒ‰ã€åˆè¨ˆ {subtotal} ã‚«ãƒ¼ãƒ‰ã€‚", w2cExtra: "45ã‚¦ã‚§ãƒ¼ãƒ–è¶…ãˆï¼šç¯„å›² {a}-{b}ï¼ˆå€ç‡ {f}ï¼‰ï¼š{extra} ã‚«ãƒ¼ãƒ‰ã€‚", w2cTotal: "ç·ã‚«ãƒ¼ãƒ‰æ•°ï¼š{subtotal} + {extraTotal} = {result}", c2wTitle: "ã€ã‚«ãƒ¼ãƒ‰ â†’ ã‚¦ã‚§ãƒ¼ãƒ–ã€‘", c2wDesc: "äºŒåˆ†æ¢ç´¢ã§æœ€å°ã‚¦ã‚§ãƒ¼ãƒ–æ•°ã‚’æ¤œç´¢ï¼šç¯„å›² {low}-{high}ã€æœ€çµ‚ {result} ã‚¦ã‚§ãƒ¼ãƒ–ã€‚" },
          tables: { w2c: { header1: "ã‚¦ã‚§ãƒ¼ãƒ–æ•°", header2: "ã‚«ãƒ¼ãƒ‰æ•°" }, c2w: { header1: "ã‚«ãƒ¼ãƒ‰æ•°", header2: "ã‚¦ã‚§ãƒ¼ãƒ–æ•°" }, history: { header1: "æ™‚é–“", header2: "ãƒ¢ãƒ¼ãƒ‰", header3: "å…¥åŠ›å€¤", header4: "çµæœ" } },
          units: { waves: "ã‚¦ã‚§ãƒ¼ãƒ–", cards: "ã‚«ãƒ¼ãƒ‰" },
          pagination: { prev: "å‰", next: "æ¬¡", pageInfo: "ãƒšãƒ¼ã‚¸ {current}/{total}" },
          footer: "Â© 2025 ğ•«ğ•™ğ•šğ•ğ•š (Discord@zhili_71)",
          darkMode: { light: "ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰", dark: "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰", system: "ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" },
          language: "è¨€èª",
          siteTitleSub: "å”åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰è¨ˆç®—æ©Ÿ",
          backToTop: "ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹",
          easterEgg: { click1: "ThinkingğŸ¤”", click3: "ãƒ€ãƒ–ãƒ« ThinkingğŸ¤”", click5: "ãƒˆãƒªãƒ—ãƒ« ThinkingğŸ¤”ï¼", click7: "å…¨ã¦ã‚’æ”¯é…ï¼", click10: "ç‹‚ä¹±æ”»æ’ƒï¼ï¼", click15: "ç©¶æ¥µ ThinkingğŸ¤”ï¼ï¼", click25: "æ­¢ã‚ã‚‰ã‚Œãªã„ï¼ï¼", click35: "ç•°å¸¸æ®ºæˆ®ï¼ï¼", click45: "çŒ›ç£ç´š ThinkingğŸ¤”ï¼ï¼ï¼", click60: "è¶…ç¥ã®ï¼ï¼ï¼ï¼", click80: "ç¥ã‚’è¶…ãˆã‚‹ï¼ï¼ï¼ï¼" },
          copied: "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ",
          settings: { title: "è¨­å®š", language: "è¨€èª", theme: "ãƒ†ãƒ¼ãƒ", reduceMotion: "ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¸›ã‚‰ã™", clearHistory: "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢" },
          autoSelectLanguage: "è¨€èªã‚’è‡ªå‹•é¸æŠ",
          reward: { title: "å ±é…¬è¨ˆç®—", selectRank: "ãƒ©ãƒ³ã‚¯ã‚’é¸æŠ", boxes: "ãƒœãƒƒã‚¯ã‚¹", commonDice: "ä¸€èˆ¬ãƒ€ã‚¤ã‚¹", rareDice: "ãƒ¬ã‚¢ãƒ€ã‚¤ã‚¹", heroDice: "ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ€ã‚¤ã‚¹", legendaryDice: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ãƒ€ã‚¤ã‚¹", gold: "ã‚´ãƒ¼ãƒ«ãƒ‰", diamonds: "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰", expected: "ï¼ˆæœŸå¾…å€¤ï¼‰" }
        },
        "ko": {
          clear: "ì§€ìš°ê¸°",
          nav: { toggleMenu: "ë©”ë‰´ ì „í™˜", calculator: "ë³€í™˜ê¸°", common: "ì¼ë°˜ ë³€í™˜", chartSection: "ì°¨íŠ¸", history: "ê¸°ë¡" },
          calculator: { title: "ì¹´ë“œ ìˆ˜ / ì›¨ì´ë¸Œ ìˆ˜ ë³€í™˜ê¸°", modeW2C: "ì›¨ì´ë¸Œ â†’ ì¹´ë“œ", modeC2W: "ì¹´ë“œ â†’ ì›¨ì´ë¸Œ", inputLabel: "ìˆ«ì ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„, ìµœëŒ€ 5ê°œ ê°’):", calcBtn: "ê³„ì‚°", processBtn: "ë³€í™˜ ê³¼ì •", invalidInput: "0ë³´ë‹¤ í° ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”", copyText: "ë³µì‚¬", placeholder: "ì˜ˆ: 100,200,300", maxValues: "ìµœëŒ€ 5ê°œì˜ ê°’ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
          common: { title: "ì¼ë°˜ ë³€í™˜", w2c: "ì›¨ì´ë¸Œ â†’ ì¹´ë“œ", c2w: "ì¹´ë“œ â†’ ì›¨ì´ë¸Œ" },
          chart: { title: "ì¹´ë“œ ìˆ˜ - ì›¨ì´ë¸Œ ìˆ˜ ì°¨íŠ¸", chartTypeLabel: "ì°¨íŠ¸ ìœ í˜•:", optionLine: "ì„  ì°¨íŠ¸", optionBar: "ë§‰ëŒ€ ì°¨íŠ¸", xAxis: "ì›¨ì´ë¸Œ ìˆ˜", yAxis: "ì¹´ë“œ ìˆ˜", showAnnotationsLabel: "ì£¼ì„ í‘œì‹œ", showPointsLabel: "ë°ì´í„° í¬ì¸íŠ¸ í‘œì‹œ", showGridLabel: "ê²©ìì„  í‘œì‹œ", waveSuffix: "ì›¨ì´ë¸Œ" },
          history: { title: "ë³€í™˜ ê¸°ë¡", clearHistory: "ê¸°ë¡ ì§€ìš°ê¸°", noRecord: "ê¸°ë¡ ì—†ìŒ" },
          process: { w2cTitle: "ã€ì›¨ì´ë¸Œ â†’ ì¹´ë“œã€‘", w2cBase: "ì²˜ìŒ 45ì›¨ì´ë¸Œ: 5ì›¨ì´ë¸Œë§ˆë‹¤ 8ì¹´ë“œ, ë³´ë„ˆìŠ¤ {lookup} ì¹´ë“œ, ì´ {subtotal} ì¹´ë“œã€‚", w2cExtra: "45ì›¨ì´ë¸Œ ì´ˆê³¼: ë²”ìœ„ {a}-{b} (ë°°ìœ¨ {f}): {extra} ì¹´ë“œã€‚", w2cTotal: "ì´ ì¹´ë“œ ìˆ˜: {subtotal} + {extraTotal} = {result}", c2wTitle: "ã€ì¹´ë“œ â†’ ì›¨ì´ë¸Œã€‘", c2wDesc: "ì´ë¶„ íƒìƒ‰ìœ¼ë¡œ ìµœì†Œ ì›¨ì´ë¸Œ ìˆ˜ ì°¾ê¸°: ë²”ìœ„ {low}-{high}, ìµœì¢… {result} ì›¨ì´ë¸Œã€‚" },
          tables: { w2c: { header1: "ì›¨ì´ë¸Œ ìˆ˜", header2: "ì¹´ë“œ ìˆ˜" }, c2w: { header1: "ì¹´ë“œ ìˆ˜", header2: "ì›¨ì´ë¸Œ ìˆ˜" }, history: { header1: "ì‹œê°„", header2: "ëª¨ë“œ", header3: "ì…ë ¥ê°’", header4: "ê²°ê³¼" } },
          units: { waves: "ì›¨ì´ë¸Œ", cards: "ì¹´ë“œ" },
          pagination: { prev: "ì´ì „", next: "ë‹¤ìŒ", pageInfo: "{total} ì¤‘ {current} í˜ì´ì§€" },
          footer: "Â© 2025 ğ•«ğ•™ğ•šğ•ğ•š (Discord@zhili_71)",
          darkMode: { light: "ë¼ì´íŠ¸ ëª¨ë“œ", dark: "ë‹¤í¬ ëª¨ë“œ", system: "ì‹œìŠ¤í…œ ê¸°ë³¸" },
          language: "ì–¸ì–´",
          siteTitleSub: "í˜‘ë™ ëª¨ë“œ ì¹´ë“œ ê³„ì‚°ê¸°",
          backToTop: "ë§¨ ìœ„ë¡œ",
          easterEgg: { click1: "ThinkingğŸ¤”", click3: "ë”ë¸” ThinkingğŸ¤”", click5: "íŠ¸ë¦¬í”Œ ThinkingğŸ¤”!", click7: "ëª¨ë‘ ì§€ë°°!", click10: "ê´‘ë€ ê³µê²©!!", click15: "ê¶ê·¹ ThinkingğŸ¤”!!", click25: "ë§‰ì„ ìˆ˜ ì—†ìŒ!!", click35: "ë³€íƒœ ì‚´ìœ¡!!", click45: "ì•¼ìˆ˜ê¸‰ ThinkingğŸ¤”!!!", click60: "ì´ˆì‹ ì˜!!!!", click80: "ì‹ ì„ ì´ˆì›”!!!!" },
          copied: "ë³µì‚¬ë¨",
          settings: { title: "ì„¤ì •", language: "ì–¸ì–´", theme: "í…Œë§ˆ", reduceMotion: "ëª¨ì…˜ ì¤„ì´ê¸°", clearHistory: "ê¸°ë¡ ì§€ìš°ê¸°" },
          autoSelectLanguage: "ì–¸ì–´ ìë™ ì„ íƒ",
          reward: { title: "ë³´ìƒ ê³„ì‚°", selectRank: "ë­í¬ ì„ íƒ", boxes: "ìƒì", commonDice: "ì¼ë°˜ ì£¼ì‚¬ìœ„", rareDice: "ë ˆì–´ ì£¼ì‚¬ìœ„", heroDice: "íˆì–´ë¡œ ì£¼ì‚¬ìœ„", legendaryDice: "ë ˆì „ë”ë¦¬ ì£¼ì‚¬ìœ„", gold: "ê³¨ë“œ", diamonds: "ë‹¤ì´ì•„ëª¬ë“œ", expected: "(ì˜ˆìƒ)" }
        }
      };
      let t = translations["zh-TW"];

      const body = document.body;
      const sideMenu = document.getElementById("sideMenu");
      const inputValue = document.getElementById("inputValue");
      const clearInput = document.getElementById("clearInput");
      const resultDiv = document.getElementById("result");
      const processInfo = document.getElementById("processInfo");
      const btnW2C = document.getElementById("btnW2C");
      const btnC2W = document.getElementById("btnC2W");
      const calcBtn = document.getElementById("calcBtn");
      const processBtn = document.getElementById("processBtn");
      const chartTypeSelect = document.getElementById("chartType");
      const toggleAnnotationsCheckbox = document.getElementById("toggleAnnotations");
      const togglePointsCheckbox = document.getElementById("togglePoints");
      const toggleGridCheckbox = document.getElementById("toggleGrid");
      const w2cTableBody = document.getElementById("w2cTable").querySelector("tbody");
      const c2wTableBody = document.getElementById("c2wTable").querySelector("tbody");
      const historyTableBody = document.getElementById("historyTable").querySelector("tbody");
      const historyPagination = document.getElementById("historyPagination");
      const langSelect = document.getElementById("langSelect");
      const themeSelect = document.getElementById("themeSelect");
      const reduceMotionCheckbox = document.getElementById("reduceMotion");
      const clearHistoryBtn = document.getElementById("clearHistory");
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsPopup = document.getElementById("settingsPopup");
      const sideMenuToggle = document.getElementById("sideMenuToggle");
      const siteTitleContainer = document.getElementById("siteTitleContainer");
      const siteTitleSub = document.getElementById("siteTitleSub");
      const easterEggText = document.getElementById("easterEggText");
      const footer = document.getElementById("footer");
      const notification = document.getElementById("notification");
      const rewardModal = document.getElementById("rewardModal");
      const modalOverlay = document.getElementById("modalOverlay");
      let myChart = null;
      let currentChartType = chartTypeSelect.value;
      let mode = "w2c";
      let historyData = [];
      let currentHistoryPage = 0;
      const recordsPerPage = 5;
      let typewriterInterval = null;
      let typewriterIndex = 0;
      let processTextCache = "";
      let eggClickCount = 0;
      let eggTimeout = null;

      function saveLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
      function loadLS(key, defaultValue) {
        const val = localStorage.getItem(key);
        return val ? JSON.parse(val) : defaultValue;
      }

      function initPreferences(){
        currentLang = loadLS(LS_KEYS.language, "auto");
        if(currentLang === "auto"){
          const browserLang = navigator.language.toLowerCase();
          if(browserLang.startsWith("zh-")){
            currentLang = browserLang === "zh-cn" ? "zh-CN" : "zh-TW";
          } else if(browserLang.startsWith("ja")){
            currentLang = "ja";
          } else if(browserLang.startsWith("ko")){
            currentLang = "ko";
          } else {
            currentLang = "en";
          }
        }
        langSelect.value = currentLang;

        if(theme === "system"){
          body.classList.toggle("dark", window.matchMedia('(prefers-color-scheme: dark)').matches);
        } else {
          body.classList.toggle("dark", theme === "dark");
        }
        themeSelect.value = theme;

        reduceMotion = loadLS(LS_KEYS.reduceMotion, false);
        reduceMotionCheckbox.checked = reduceMotion;
        if(reduceMotion || window.matchMedia('(prefers-reduced-motion: reduce)').matches){
          document.body.classList.add("reduce-motion");
        }

        mode = loadLS(LS_KEYS.mode, "w2c");
        btnW2C.classList.toggle("active", mode === "w2c");
        btnC2W.classList.toggle("active", mode === "c2w");
        historyData = loadLS(LS_KEYS.history, []);
        renderHistory();
        updateLanguage();
        lastRank = loadLS(LS_KEYS.lastRank, "20");
      }

      sideMenuToggle.addEventListener("click", function(){
        sideMenu.classList.toggle("collapsed");
        const isOpen = !sideMenu.classList.contains("collapsed");
        sideMenuToggle.classList.toggle("moved", isOpen);
        sideMenuToggle.innerHTML = isOpen ? "âœ–" : "â˜°";
        document.getElementById("dotNav").style.display = isOpen ? "none" : "flex";
      });

      settingsToggle.addEventListener("click", function(){
        settingsPopup.classList.toggle("visible");
        settingsToggle.classList.toggle("rotate");
      });

      document.addEventListener("click", function(event){
        const isOpen = !sideMenu.classList.contains("collapsed");
        if(!sideMenu.contains(event.target) && event.target !== sideMenuToggle && isOpen){
          sideMenuToggle.click();
        }
        if(!settingsPopup.contains(event.target) && event.target !== settingsToggle && settingsPopup.classList.contains("visible")){
          settingsPopup.classList.remove("visible");
          settingsToggle.classList.remove("rotate");
        }
        if(event.target.classList.contains("reward-symbol") || event.target.closest(".card-container")){
          const container = event.target.classList.contains("card-container") ? event.target : event.target.closest(".card-container");
          const cards = container.getAttribute("data-cards");
          showModal(cards);
        }
      });

      document.querySelectorAll(".dot").forEach(dot => {
        dot.addEventListener("click", function(){
          const sectionId = this.getAttribute("data-section");
          document.getElementById(sectionId).scrollIntoView({ behavior: "smooth" });
        });
      });

      function setTheme(mode){
        theme = mode;
        saveLS(LS_KEYS.theme, mode);
        if(mode === "system"){
          body.classList.toggle("dark", window.matchMedia('(prefers-color-scheme: dark)').matches);
        } else {
          body.classList.toggle("dark", mode === "dark");
        }
        updateChartAxisColor();
      }

      themeSelect.addEventListener("change", function(){
        setTheme(this.value);
      });

      langSelect.addEventListener("change", function(){
        currentLang = this.value;
        if(currentLang === "auto"){
          const browserLang = navigator.language.toLowerCase();
          if(browserLang.startsWith("zh-")){
            currentLang = browserLang === "zh-cn" ? "zh-CN" : "zh-TW";
          } else if(browserLang.startsWith("ja")){
            currentLang = "ja";
          } else if(browserLang.startsWith("ko")){
            currentLang = "ko";
          } else {
            currentLang = "en";
          }
        }
        saveLS(LS_KEYS.language, this.value);
        updateLanguage();
      });

      reduceMotionCheckbox.addEventListener("change", function(){
        reduceMotion = this.checked;
        saveLS(LS_KEYS.reduceMotion, reduceMotion);
        if(reduceMotion){
          document.body.classList.add("reduce-motion");
        } else {
          document.body.classList.remove("reduce-motion");
        }
      });

      clearHistoryBtn.addEventListener("click", function(){
        if(confirm("Are you sure you want to clear all history records?")){
          historyData = [];
          saveLS(LS_KEYS.history, historyData);
          currentHistoryPage = 0;
          renderHistory();
        }
      });

      if(window.innerWidth > 768) {
        window.addEventListener("wheel", function(e) {
          e.preventDefault();
          const sections = Array.from(document.querySelectorAll("section"));
          const currentScroll = window.scrollY;
          let target = null;
          if(e.deltaY > 0) {
            for(let i = 0; i < sections.length; i++){
              if(sections[i].offsetTop > currentScroll + 50){
                target = sections[i];
                break;
              }
            }
          } else {
            for(let i = sections.length - 1; i >= 0; i--){
              if(sections[i].offsetTop < currentScroll - 50){
                target = sections[i];
                break;
              }
            }
          }
          if(target) target.scrollIntoView({ behavior: "smooth" });
        }, {passive: false});
      }

      window.addEventListener("scroll", updateSideMenuHighlight);
      document.getElementById("navTop").addEventListener("click", function(){ window.scrollTo({ top: 0, behavior: "smooth" }); });

      function updateSideMenuHighlight() {
        const sections = document.querySelectorAll("section");
        let currentSectionId = "";
        sections.forEach(sec => {
          if(window.scrollY >= sec.offsetTop - 100) currentSectionId = sec.id;
        });
        document.querySelectorAll("#sideMenu a").forEach(link => {
          link.classList.toggle("active", link.getAttribute("href") === "#" + currentSectionId);
        });
        document.querySelectorAll(".dot").forEach(dot => {
          dot.classList.toggle("active", dot.getAttribute("data-section") === currentSectionId);
        });
        document.getElementById("pageNav").style.display = window.scrollY < 50 ? "none" : "flex";
      }

      function wavesToCards(t){
        let T = BigInt(t);
        if(T < 1n) return 0n;
        const baseThreshold = BigInt(CONFIG.baseThreshold);
        let w = T < baseThreshold ? T : baseThreshold;
        const baseArray = CONFIG.baseArray.map(x => BigInt(x));
        let base = (w / 5n) * 8n + baseArray[Number(w % 5n)];
        let extra = 0n;
        CONFIG.extraRanges.forEach(range => {
          let a = BigInt(range.a);
          let b = (range.b === Infinity) ? T : BigInt(range.b);
          let f = BigInt(range.f);
          if(T >= a){
            let x = T < b ? T : b;
            let term1 = x - a + 1n;
            let term2 = ((x + 1n) / 2n) - (a / 2n);
            extra += 2n * f * (term1 + 2n * term2);
          }
        });
        return base + extra;
      }
      function cardsToWaves(x){
        let X = BigInt(x);
        if(X < 1n) return 0n;
        let l = 1n, h = 1n;
        while(wavesToCards(h) < X){ h *= 2n; }
        while(l < h){
          let m = (l + h) / 2n;
          if(wavesToCards(m) < X) l = m + 1n; else h = m;
        }
        return l;
      }

      function animateProcessText(text) {
        if(processTextCache === text) return;
        processTextCache = text;
        typewriterIndex = 0;
        if(typewriterInterval) clearInterval(typewriterInterval);
        processInfo.innerHTML = "";
        let currentBlinker = null;
        let currentLineSpan = document.createElement("span");
        currentLineSpan.className = "line";
        processInfo.appendChild(currentLineSpan);

        typewriterInterval = setInterval(() => {
          if (typewriterIndex < text.length) {
            if (currentBlinker) {
              currentBlinker.remove();
              currentBlinker = null;
            }
            let char = text[typewriterIndex];
            if (char === "\n") {
              let br = document.createElement("br");
              processInfo.appendChild(br);
              currentLineSpan = document.createElement("span");
              currentLineSpan.className = "line";
              processInfo.appendChild(currentLineSpan);
            } else {
              let charSpan = document.createElement("span");
              charSpan.className = "char";
              charSpan.textContent = char;
              currentLineSpan.appendChild(charSpan);
              let blinker = document.createElement("span");
              blinker.className = "blinker";
              blinker.textContent = "â—";
              charSpan.appendChild(blinker);
              currentBlinker = blinker;
              requestAnimationFrame(() => { charSpan.style.opacity = "1"; });
            }
            typewriterIndex++;
          } else {
            clearInterval(typewriterInterval);
            typewriterInterval = null;
          }
        }, 2);
      }

      function cleanInput(input){
        let values = input.split(",").map(val => val.trim());
        let cleanedValues = [];
        const seen = new Set();

        values.forEach(val => {
          if (val === "" || val === "0") {
            animateDelete(val);
            return;
          }
          let cleanedVal = val.replace(/^0+/, "") || "0";
          if (cleanedVal !== val) animateDelete(val);
          if (!seen.has(cleanedVal)) {
            seen.add(cleanedVal);
            cleanedValues.push(cleanedVal);
          } else {
            animateDelete(val);
          }
        });

        return cleanedValues.join(",");
      }

      function animateDelete(value) {
        let span = document.createElement("span");
        span.textContent = value;
        span.className = "delete-anim";
        span.style.position = "absolute";
        span.style.left = inputValue.getBoundingClientRect().left + "px";
        span.style.top = inputValue.getBoundingClientRect().top + "px";
        document.body.appendChild(span);
        span.addEventListener("animationend", () => {
          span.remove();
          if (!document.querySelector(".delete-anim")) {
            inputValue.value = "";
          }
        });
      }

      function updateResult(){
        calcBtn.classList.add("loading");
        resultDiv.innerHTML = '<div class="loader">âš€</div>';
        resultDiv.classList.add("visible");
        setTimeout(() => {
          const inputStr = cleanInput(inputValue.value.trim());
          inputValue.value = inputStr;
          const inputs = inputStr.split(",").map(val => val.trim()).filter(val => val !== "");
          resultDiv.classList.remove("error");
          if (inputs.length === 0) {
            showNotification(t.calculator.invalidInput);
            calcBtn.classList.remove("loading");
            return;
          }
          let tableHTML = `<table><tbody>`;
          inputs.forEach(input => {
            let calcResult = mode === "w2c" ? wavesToCards(input) : cardsToWaves(input);
            let inputUnit = mode === "w2c" ? t.units.waves : t.units.cards;
            let outputUnit = mode === "w2c" ? t.units.cards : t.units.waves;
            let inputText = `${input} ${inputUnit}`;
            let outputText = mode === "w2c" ? `<span class="card-container" data-cards="${calcResult}">${calcResult} ${outputUnit}<span class="reward-symbol">?</span></span>` : `${calcResult} ${outputUnit}`;
            let plainOutputText = `${calcResult} ${outputUnit}`;
            tableHTML += `<tr><td>${inputText}</td><td>â†’</td><td>${outputText}</td><td><button class="copyBtn" data-text="${inputText} â†’ ${plainOutputText}">â˜</button></td></tr>`;
            addHistoryRecord(Date.now(), mode, input);
          });
          tableHTML += "</tbody></table>";
          resultDiv.innerHTML = tableHTML;
          updateProcessInfo(inputs);
          calcBtn.classList.remove("loading");
          addCopyFunctionality();
        }, 500);
      }
      function addCopyFunctionality(){
        document.querySelectorAll(".copyBtn").forEach(btn => {
          btn.addEventListener("click", function(){
            const text = this.getAttribute("data-text");
            navigator.clipboard.writeText(text).then(() => {
              showNotification(t.copied);
            });
          });
        });
      }
      function showNotification(message) {
        notification.textContent = message;
        notification.classList.add("visible");
        setTimeout(() => {
          notification.classList.remove("visible");
        }, 2000);
      }
      function updateProcessInfo(inputs){
        let explanation = "";
        inputs.forEach((inputStr, index) => {
          if(!/^\d+$/.test(inputStr) || inputStr === "0") return;
          explanation += (index > 0 ? "\n" : "") + (mode === "w2c" ? t.process.w2cTitle : t.process.c2wTitle) + "\n";
          if(mode === "w2c"){
            const w = BigInt(inputStr) < BigInt(CONFIG.baseThreshold) ? BigInt(inputStr) : BigInt(CONFIG.baseThreshold);
            const fullSets = (w / 5n);
            const baseCalc = fullSets * 8n;
            const baseArray = CONFIG.baseArray.map(x => BigInt(x));
            const mod = w % 5n;
            const lookup = baseArray[Number(mod)];
            let subtotal = baseCalc + lookup;
            explanation += t.process.w2cBase
              .replace("{lookup}", lookup.toString())
              .replace("{subtotal}", subtotal.toString()) + "\n";
            let extraTotal = 0n;
            if(BigInt(inputStr) > BigInt(CONFIG.baseThreshold)){
              CONFIG.extraRanges.forEach(range => {
                let a = BigInt(range.a);
                let b = (range.b === Infinity) ? BigInt(inputStr) : BigInt(range.b);
                let f = BigInt(range.f);
                if(BigInt(inputStr) >= a){
                  let x = BigInt(inputStr) < b ? BigInt(inputStr) : b;
                  let roundsInRange = x - a + 1n;
                  let term1 = roundsInRange;
                  let term2 = ((x + 1n) / 2n) - (a / 2n);
                  let extra = 2n * f * (term1 + 2n * term2);
                  explanation += t.process.w2cExtra
                    .replace("{a}", a.toString())
                    .replace("{b}", (b === BigInt(inputStr) ? inputStr : b.toString()))
                    .replace("{f}", f.toString())
                    .replace("{extra}", extra.toString()) + "\n";
                  extraTotal += extra;
                }
              });
            }
            explanation += t.process.w2cTotal
              .replace("{subtotal}", subtotal.toString())
              .replace("{extraTotal}", extraTotal.toString())
              .replace("{result}", wavesToCards(inputStr).toString()) + "\n";
          } else {
            let low = 1n, high = 1n;
            while(wavesToCards(high) < BigInt(inputStr)){ high *= 2n; }
            let result = cardsToWaves(inputStr);
            explanation += t.process.c2wDesc
              .replace("{low}", "1")
              .replace("{high}", high.toString())
              .replace("{result}", result.toString()) + "\n";
          }
        });
        animateProcessText(explanation);
      }

      function populateTables(){
        const w2cValues = [111,200,300,1000,1500,2000,2500,10000,20000];
        const c2wValues = [40,400,4000,8000,12000,16000,20000,40000,400000];
        w2cTableBody.innerHTML = "";
        c2wTableBody.innerHTML = "";
        w2cValues.forEach(waves => {
          const cards = wavesToCards(waves).toString();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${waves}</td><td><span class="card-container" data-cards="${cards}">${cards}<span class="reward-symbol">?</span></span></td>`;
          w2cTableBody.appendChild(tr);
        });
        c2wValues.forEach(cards => {
          const waves = cardsToWaves(cards).toString();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td><span class="card-container" data-cards="${cards}">${cards}<span class="reward-symbol">?</span></span></td><td>${waves}</td>`;
          c2wTableBody.appendChild(tr);
        });
      }
      function generateChart(){
        const maxWaves = CONFIG.chart.maxWaves;
        const step = CONFIG.chart.step;
        const dataPoints = [];
        for(let w=0; w<=maxWaves; w+=step){
          dataPoints.push({x: w, y: Number(wavesToCards(w))});
        }
        const maxY = Number(wavesToCards(maxWaves));
        const ctx = document.getElementById("chart").getContext("2d");
        if(myChart) myChart.destroy();
        const axisColor = body.classList.contains("dark") ? "#fff" : "#333";
        const datasetOptions = {
          label: t.chart.yAxis,
          data: dataPoints,
          borderColor: "rgba(255, 99, 132, 1)",
          backgroundColor: "rgba(255, 99, 132, 0.2)",
          pointRadius: togglePointsCheckbox.checked ? 4 : 0,
          fill: false,
          tension: 0.15
        };
        const chartOptions = {
          type: currentChartType,
          data: { datasets: [datasetOptions] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: reduceMotion ? 0 : 1000, easing: 'easeInOutQuad' },
            plugins: {
              tooltip: {
                mode: "index",
                intersect: false,
                callbacks: { label: context => `${t.chart.xAxis}: ${context.parsed.x}, ${t.chart.yAxis}: ${context.parsed.y}` }
              },
              datalabels: { display: false }
            },
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: t.chart.xAxis, font: { size: 14 }, color: axisColor },
                min: 0,
                max: maxWaves,
                ticks: { font: { size: 12 }, color: axisColor },
                grid: { display: toggleGridCheckbox.checked }
              },
              y: {
                title: { display: true, text: t.chart.yAxis, font: { size: 14 }, color: axisColor },
                min: 0,
                max: maxY,
                ticks: { 
                  stepSize: maxY / 10, 
                  callback: value => Math.round(value / 1000) * 1000,
                  font: { size: 12 }, 
                  color: axisColor 
                },
                grid: { display: toggleGridCheckbox.checked }
              }
            }
          }
        };
        if(toggleAnnotationsCheckbox.checked){
          const annotations = {};
          const keyPoints = [45,111,501,1001,1501].filter(w => w <= maxWaves);
          keyPoints.forEach((wave, index) => {
            annotations[`line${wave}`] = {
              type: "line",
              scaleID: "x",
              value: wave,
              borderColor: "rgba(255,0,0,0.8)",
              borderWidth: 2,
              borderDash: [6,3],
              label: {
                enabled: true,
                position: "start",
                yAdjust: 10,
                content: [`${wave}${t.chart.waveSuffix}`, wavesToCards(wave).toString()],
                backgroundColor: "rgba(0,0,0,0.7)",
                color: "#fff",
                font: { weight: "bold", size: 10 },
                borderRadius: 4,
                padding: 4
              }
            };
          });
          chartOptions.options.plugins.annotation = { annotations };
        }
        myChart = new Chart(ctx, chartOptions);
      }
      chartTypeSelect.addEventListener("change", function(){ currentChartType = this.value; generateChart(); });
      toggleAnnotationsCheckbox.addEventListener("change", generateChart);
      togglePointsCheckbox.addEventListener("change", generateChart);
      toggleGridCheckbox.addEventListener("change", generateChart);

      btnW2C.addEventListener("click", function(){
        mode = "w2c";
        btnW2C.classList.add("active");
        btnC2W.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "â†’" || resultDiv.querySelector("table")) updateResult();
      });
      btnC2W.addEventListener("click", function(){
        mode = "c2w";
        btnC2W.classList.add("active");
        btnW2C.classList.remove("active");
        saveLS(LS_KEYS.mode, mode);
        if(resultDiv.innerText.trim() !== "â†’" || resultDiv.querySelector("table")) updateResult();
      });
      calcBtn.addEventListener("click", updateResult);
      processBtn.addEventListener("click", function(e){
        e.stopPropagation();
        processInfo.classList.toggle("visible");
        if(processInfo.classList.contains("visible") && !typewriterInterval && typewriterIndex < processTextCache.length) {
          animateProcessText(processTextCache);
        }
        updateResult();
      });
      processInfo.addEventListener("wheel", function(e){ e.stopPropagation(); });

      inputValue.addEventListener("input", function(){
        clearInput.style.display = this.value ? "block" : "none";
        const values = this.value.split(",").map(val => val.trim());
        if (values.length > 5) {
          this.value = values.slice(0, 5).join(",");
          showNotification(t.calculator.maxValues);
        }
        this.value = this.value.replace(/[^0-9,]/g, "");
        this.value = this.value.replace(/(^|,)0+/g, "$1").replace(/,0+/g, ",");
        this.value = this.value.replace(/,+/g, ",");
      });
      inputValue.addEventListener("keypress", function(e){
        if (!/[\d,]/.test(e.key)) {
          e.preventDefault();
        }
        const values = this.value.split(",").map(val => val.trim());
        if (values.length >= 5 && e.key === ",") {
          e.preventDefault();
          showNotification(t.calculator.maxValues);
        }
        if (e.key === "," && (this.value.endsWith(",") || this.value === "")) {
          e.preventDefault();
        }
      });
      inputValue.addEventListener("paste", function(e){
        e.preventDefault();
        const text = e.clipboardData.getData("text/plain").replace(/[^0-9,]/g, "");
        document.execCommand("insertText", false, text);
      });
      inputValue.addEventListener("change", function(){
        this.value = cleanInput(this.value);
      });
      clearInput.addEventListener("click", function(){
        inputValue.value = "";
        clearInput.style.display = "none";
        inputValue.focus();
      });

      function addHistoryRecord(timestamp, modeUsed, input){
        historyData.unshift({ timestamp, mode: modeUsed, input });
        if(historyData.length > 100) historyData.pop();
        saveLS(LS_KEYS.history, historyData);
        currentHistoryPage = 0;
        renderHistory();
      }
      function renderHistory(){
        historyTableBody.innerHTML = "";
        if(historyData.length === 0){
          historyTableBody.innerHTML = `<tr><td colspan='4'>${t.history.noRecord}</td></tr>`;
        } else {
          historyData.slice(currentHistoryPage * recordsPerPage, (currentHistoryPage+1) * recordsPerPage)
            .forEach(rec => {
              const tr = document.createElement("tr");
              const timeStr = new Date(rec.timestamp).toLocaleString(currentLang === "zh-TW" || currentLang === "zh-CN" ? "zh-TW" : currentLang);
              let computed = (rec.mode === "w2c") ? wavesToCards(rec.input) : cardsToWaves(rec.input);
              let inputText, resultText;
              if (rec.mode === "w2c") {
                inputText = `${rec.input} ${t.units.waves}`;
                resultText = `<span class="card-container" data-cards="${computed}">${computed} ${t.units.cards}<span class="reward-symbol">?</span></span>`;
              } else {
                inputText = `<span class="card-container" data-cards="${rec.input}">${rec.input} ${t.units.cards}<span class="reward-symbol">?</span></span>`;
                resultText = `${computed} ${t.units.waves}`;
              }
              let modeText = (rec.mode === "w2c") ? t.calculator.modeW2C : t.calculator.modeC2W;
              tr.innerHTML = `<td data-label="${t.tables.history.header1}">${timeStr}</td><td data-label="${t.tables.history.header2}">${modeText}</td><td data-label="${t.tables.history.header3}">${inputText}</td><td data-label="${t.tables.history.header4}">${resultText}</td>`;
              historyTableBody.appendChild(tr);
            });
          setTimeout(() => {
            historyTableBody.querySelectorAll("tr").forEach(tr => tr.classList.add("visible"));
          }, 50);
        }
        renderHistoryPagination();
      }
      function renderHistoryPagination(){
        historyPagination.innerHTML = "";
        const totalPages = Math.ceil(historyData.length / recordsPerPage);
        if(totalPages <= 1) return;
        const paginationDiv = document.createElement("div");
        if(currentHistoryPage > 0){
          const prevBtn = document.createElement("button");
          prevBtn.innerHTML = `<span class="text">${t.pagination.prev}</span><span class="icon">â—€</span>`;
          prevBtn.addEventListener("click", function(){ currentHistoryPage--; renderHistory(); });
          paginationDiv.appendChild(prevBtn);
        }
        const pageInfo = document.createElement("span");
        pageInfo.textContent = t.pagination.pageInfo
          .replace("{current}", currentHistoryPage + 1)
          .replace("{total}", totalPages);
        paginationDiv.appendChild(pageInfo);
        if(currentHistoryPage < totalPages - 1){
          const nextBtn = document.createElement("button");
          nextBtn.innerHTML = `<span class="text">${t.pagination.next}</span><span class="icon">â–¶</span>`;
          nextBtn.addEventListener("click", function(){ currentHistoryPage++; renderHistory(); });
          paginationDiv.appendChild(nextBtn);
        }
        historyPagination.appendChild(paginationDiv);
      }

      function updateLanguage() {
        t = translations[currentLang] || translations["zh-TW"];
        document.querySelector("#calculator .module h2").textContent = t.calculator.title;
        document.querySelector("#common .module h2").textContent = t.common.title;
        document.querySelector("#chartSection .module h2").textContent = t.chart.title;
        document.querySelector("#history .module h2").textContent = t.history.title;
        document.querySelector("#w2cTable thead tr th:nth-child(1)").textContent = t.tables.w2c.header1;
        document.querySelector("#w2cTable thead tr th:nth-child(2)").textContent = t.tables.w2c.header2;
        document.querySelector("#c2wTable thead tr th:nth-child(1)").textContent = t.tables.c2w.header1;
        document.querySelector("#c2wTable thead tr th:nth-child(2)").textContent = t.tables.c2w.header2;
        document.querySelector("#historyTable thead tr th:nth-child(1)").textContent = t.tables.history.header1;
        document.querySelector("#historyTable thead tr th:nth-child(2)").textContent = t.tables.history.header2;
        document.querySelector("#historyTable thead tr th:nth-child(3)").textContent = t.tables.history.header3;
        document.querySelector("#historyTable thead tr th:nth-child(4)").textContent = t.tables.history.header4;
        document.querySelector("#common .table-box:nth-child(1) h3").textContent = t.common.w2c;
        document.querySelector("#common .table-box:nth-child(2) h3").textContent = t.common.c2w;
        document.getElementById("btnW2C").textContent = t.calculator.modeW2C;
        document.getElementById("btnC2W").textContent = t.calculator.modeC2W;
        document.querySelector("#calculator label[for='inputValue']").textContent = t.calculator.inputLabel;
        document.getElementById("calcBtn").textContent = t.calculator.calcBtn;
        document.getElementById("processBtn").textContent = "?";
        document.querySelector("#chartSection label[for='chartType']").textContent = t.chart.chartTypeLabel;
        chartTypeSelect.options[0].text = t.chart.optionLine;
        chartTypeSelect.options[1].text = t.chart.optionBar;
        document.getElementById("annotationsLabel").textContent = t.chart.showAnnotationsLabel;
        document.getElementById("pointsLabel").textContent = t.chart.showPointsLabel;
        document.getElementById("gridLabel").textContent = t.chart.showGridLabel;
        document.getElementById("menuCalculator").textContent = t.nav.calculator;
        document.getElementById("menuCommon").textContent = t.nav.common;
        document.getElementById("menuChartSection").textContent = t.nav.chartSection;
        document.getElementById("menuHistory").textContent = t.nav.history;
        siteTitleSub.textContent = t.siteTitleSub;
        footer.textContent = t.footer;
        inputValue.placeholder = t.calculator.placeholder;
        clearInput.textContent = t.clear;
        document.querySelector("#settingsPopup label[for='langSelect']").textContent = "ğŸŒ [L] " + t.settings.language;
        document.querySelector("#settingsPopup label[for='themeSelect']").textContent = "ğŸ¨ [T] " + t.settings.theme;
        document.querySelector("#settingsPopup label[for='reduceMotion']").textContent = t.settings.reduceMotion;
        document.getElementById("clearHistory").textContent = t.settings.clearHistory;
        themeSelect.options[0].text = t.darkMode.system;
        themeSelect.options[1].text = t.darkMode.light;
        themeSelect.options[2].text = t.darkMode.dark;
        langSelect.options[0].text = t.autoSelectLanguage;
        sideMenuToggle.setAttribute("title", t.nav.toggleMenu);
        sideMenuToggle.setAttribute("aria-label", t.nav.toggleMenu);
        settingsToggle.setAttribute("title", t.settings.title);
        settingsToggle.setAttribute("aria-label", t.settings.title);
        document.getElementById("rewardModal").querySelector("h3").textContent = t.reward.title;
        document.getElementById("rewardModal").querySelector("label").textContent = t.reward.selectRank;
        renderHistory();
        generateChart();
        if (inputValue.value.trim()) {
          updateResult();
        } else {
          resultDiv.innerText = "â†’ ";
          resultDiv.classList.remove("visible");
        }
        updateRankOptions();
      }

      function showModal(cards){
        currentCards = cards;
        updateRankOptions();
        document.getElementById("rankSelect").value = lastRank;
        updateRewardDetails(cards, lastRank);
        modalOverlay.style.display = "block";
        rewardModal.style.display = "block";
        setTimeout(() => {
          rewardModal.classList.add("visible");
        }, 10);
      }
      function hideModal(){
        rewardModal.classList.remove("visible");
        setTimeout(() => {
          modalOverlay.style.display = "none";
          rewardModal.style.display = "none";
        }, 300);
      }
      function updateRewardDetails(cards, rank){
        const boxes = Math.floor(cards / 40);
        const reward = REWARDS[rank] || REWARDS[20];
        const rewardText = `
          <dl>
            <dt>${t.reward.boxes}</dt><dd>${boxes}</dd>
          </dl>
          <hr>
          <dl>
            <dt>${t.reward.commonDice}</dt><dd>${reward.common * boxes}</dd>
            <dt>${t.reward.rareDice}</dt><dd>${reward.rare * boxes}</dd>
            <dt>${t.reward.heroDice}</dt><dd>${reward.hero * boxes}</dd>
            <dt>${t.reward.legendaryDice}</dt><dd>${(reward.legendary * boxes).toFixed(2)} ${t.reward.expected}</dd>
          </dl>
          <hr>
          <dl>
            <dt>${t.reward.gold}</dt><dd>${reward.gold * boxes}</dd>
            <dt>${t.reward.diamonds}</dt><dd>${reward.diamonds * boxes}</dd>
          </dl>
        `;
        document.getElementById("rewardDetails").innerHTML = rewardText;
      }
      document.getElementById("rankSelect").addEventListener("change", function(){
        lastRank = this.value;
        saveLS(LS_KEYS.lastRank, lastRank);
        updateRewardDetails(currentCards, this.value);
      });
      modalOverlay.addEventListener("click", hideModal);

      function updateRankOptions(){
        const rankSelect = document.getElementById("rankSelect");
        rankSelect.innerHTML = "";
        for(let i=1; i<=19; i++){
          const option = document.createElement("option");
          option.value = i;
          option.textContent = currentLang === "en" ? `Rank ${i}` : i;
          rankSelect.appendChild(option);
        }
        const option20 = document.createElement("option");
        option20.value = "20";
        option20.textContent = currentLang === "en" ? "Rank 20âº" : "20âº";
        rankSelect.appendChild(option20);
        rankSelect.value = lastRank;
      }

      populateTables();
      generateChart();
      initPreferences();

      function updateChartAxisColor(){
        if(myChart){
          const axisColor = body.classList.contains("dark") ? "#fff" : "#333";
          myChart.options.scales.x.ticks.color = axisColor;
          myChart.options.scales.y.ticks.color = axisColor;
          myChart.options.scales.x.title.color = axisColor;
          myChart.options.scales.y.title.color = axisColor;
          myChart.update();
        }
      }

      function triggerEasterEgg() {
        if(reduceMotion) return;
        eggClickCount++;
        if(eggTimeout) clearTimeout(eggTimeout);
        eggTimeout = setTimeout(() => {
          eggClickCount = 0;
          easterEggText.textContent = "";
          easterEggText.style.color = "";
        }, 5000);
        const tEgg = t.easterEgg;
        switch(eggClickCount){
          case 1: easterEggText.textContent = tEgg.click1; break;
          case 3: easterEggText.textContent = tEgg.click3; break;
          case 5: easterEggText.textContent = tEgg.click5; break;
          case 7: easterEggText.textContent = tEgg.click7; break;
          case 10: easterEggText.textContent = tEgg.click10; break;
          case 15: easterEggText.textContent = tEgg.click15; break;
          case 25: easterEggText.textContent = tEgg.click25; break;
          case 35: easterEggText.textContent = tEgg.click35; break;
          case 45: easterEggText.textContent = tEgg.click45; break;
          case 60: easterEggText.textContent = tEgg.click60; break;
          case 80: easterEggText.textContent = tEgg.click80; break;
          default: if(eggClickCount > 80) {
            easterEggText.textContent = tEgg.click80;
            easterEggText.style.color = `hsl(${Math.random()*360}, 100%, 50%)`;
          }
          break;
        }
        if(eggClickCount < 80) easterEggText.style.color = "var(--primary-color)";
        for(let i = 0; i < Math.min(eggClickCount, 3); i++){ // Reduced to 3 for performance
          setTimeout(() => {
            let emoji = document.createElement("span");
            emoji.textContent = "ğŸ¤”";
            emoji.className = "easter-egg";
            emoji.style.left = (Math.random() * 80 + 10) + "%";
            emoji.style.bottom = "0px";
            document.body.appendChild(emoji);
            requestAnimationFrame(() => {
              emoji.classList.add("visible");
            });
            setTimeout(() => {
              emoji.remove();
            }, 1000); // Reduced animation duration
          }, i * 100);
        }
      }
      siteTitleContainer.addEventListener("click", triggerEasterEgg);
      siteTitleContainer.addEventListener("touchstart", triggerEasterEgg);

      window.addEventListener("load", function(){
        if(!reduceMotion){
          for(let i = 0; i < 3; i++){ // Reduced to 3 for performance
            setTimeout(() => {
              let emoji = document.createElement("span");
              emoji.textContent = "ğŸ¤”";
              emoji.className = "easter-egg";
              emoji.style.left = (Math.random() * 80 + 10) + "%";
              emoji.style.bottom = "0px";
              document.body.appendChild(emoji);
              requestAnimationFrame(() => {
                emoji.classList.add("visible");
              });
              setTimeout(() => {
                emoji.remove();
              }, 1000); // Reduced animation duration
            }, i * 100);
          }
        }
      });

      updateSideMenuHighlight();
    })();
  </script>
</body>
</html>
